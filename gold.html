<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù†Ù‡Ø§ÛŒÛŒ Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø± â€” Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ (Ø¨Ø§ AutoFetch Ùˆ Alerts)</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{--bg1:#0f1720;--card:#1f2937;--accent:#ffd369;--muted:#9bd7ff}
*{box-sizing:border-box}
body{margin:0;padding:14px;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:linear-gradient(180deg,var(--bg1),#0b1116);color:#fff}
.container{max-width:980px;margin:0 auto}
.header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
.title{font-size:1.25rem;color:var(--accent);font-weight:700}
.small{font-size:0.85rem;color:#cbd5e1}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:14px;margin-bottom:12px;box-shadow:0 6px 30px rgba(0,0,0,0.6);border:1px solid rgba(255,211,105,0.06)}
.row{display:flex;gap:10px;align-items:center}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
@media(max-width:740px){.grid{grid-template-columns:1fr}}
label{display:block;font-size:0.85rem;margin-bottom:6px;color:#d1d5db}
input[type=number],input[type=text],textarea{width:100%;padding:8px;border-radius:8px;border:none;background:#0b1220;color:#fff}
button{padding:9px 12px;border-radius:10px;border:none;background:var(--accent);color:#000;font-weight:600;cursor:pointer}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff}
.result{background:#071018;padding:10px;border-radius:8px;margin-top:8px;border:1px solid rgba(255,255,255,0.03);font-size:0.95rem}
.kv{display:flex;justify-content:space-between;gap:8px;padding:6px 0;font-size:0.95rem}
.tip{color:var(--muted);font-size:0.88rem;line-height:1.45}
.footer-small{font-size:0.82rem;color:#94a3b8;margin-top:8px}
.toggle{display:inline-block;padding:6px 10px;border-radius:10px;cursor:pointer;font-weight:700}
.toggle.on{background:#16a34a;color:#fff}
.toggle.off{background:#ef4444;color:#fff}
.signals-list{max-height:160px;overflow:auto;margin-top:8px;border-radius:8px;padding:8px;border:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent)}
.signal-item{padding:6px;border-bottom:1px dashed rgba(255,255,255,0.03);font-size:0.9rem}
.canvas-wrap{background:#06121a;padding:8px;border-radius:10px;margin-top:8px}
.legend{display:flex;gap:8px;align-items:center;margin-top:8px}
.legend .dot{width:12px;height:12px;border-radius:3px;display:inline-block}
.entry-dot{background:#16a34a}
.exit-dot{background:#ef4444}
.hr{height:1px;background:rgba(255,255,255,0.03);margin:12px 0;border-radius:2px}
.small-muted{color:#94a3b8;font-size:0.85rem}
.input-inline{display:flex;gap:8px}
.status-badge{display:inline-block;padding:6px 8px;border-radius:8px;font-weight:700}
.status-normal{background:#374151;color:#fff}
.status-high{background:#065f46;color:#fff}
.status-low{background:#7f1d1d;color:#fff}
.counter-box{display:flex;gap:12px;align-items:center}
.counter-box div{min-width:120px}
textarea{min-height:90px}
canvas{width:100% !important; height:360px !important}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div>
      <div class="title">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù†Ù‡Ø§ÛŒÛŒ Ù†ÙˆØ³Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ â€” Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø±</div>
      <div class="small">ÙˆØ±Ú˜Ù†: Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ â€” Ø¯Ø³ØªÛŒ + API â€” RSI Ø§Ø² API/ØªØ§Ø±ÛŒØ®Ú†Ù‡</div>
    </div>
    <div class="small-muted">Ø°Ø®ÛŒØ±Ù‡ Ù…Ø­Ù„ÛŒ: LocalStorage â€¢ Ø¯Ø±Ø®ÙˆØ§Ø³Øª API: Ù…Ø­Ø¯ÙˆØ¯ ÛŒØ§ Ù‚Ø§Ø¨Ù„ Ø§ÙØ²Ø§ÛŒØ´</div>
  </div>

  <!-- ØªÙˆØ¶ÛŒØ­Ø§Øª Ùˆ ØªØ§ÛŒÙ… -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start">
      <div style="flex:1">
        <h3 style="margin:0 0 6px;color:var(--accent)">Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø³Ø±ÛŒØ¹ Ø§Ø³ØªÙØ§Ø¯Ù‡</h3>
        <div class="tip">
          â€¢ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ Ø±Ø§ <strong>Ø¯Ø³ØªÛŒ</strong> ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø§Ø² Ø¯Ú©Ù…Ù‡Ù” <strong>Ø¯Ø±ÛŒØ§ÙØª Ø§Ø² API</strong> Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.<br>
          â€¢ Ø§Ú¯Ø± Ú©Ù„ÛŒØ¯ RSI API Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ Ø¨Ø±Ù†Ø§Ù…Ù‡ ØªÙ„Ø§Ø´ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ RSI ÙˆØ§Ù‚Ø¹ÛŒ Ø±Ø§ Ø§Ø² Ø³Ø±ÙˆÛŒØ³ Ø®Ø§Ø±Ø¬ÛŒ Ø¨Ú¯ÛŒØ±Ø¯Ø› Ø¯Ø± ØºÛŒØ± Ø§ÛŒÙ† ØµÙˆØ±Øª RSI Ø§Ø² ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.<br>
          â€¢ AutoFetch Ø¨ÛŒÙ† 18:00â€“22:00 Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯ (ØµÙØ­Ù‡ Ø¨Ø§ÛŒØ¯ Ø¨Ø§Ø² Ø¨Ø§Ø´Ø¯).<br>
          â€¢ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒ Ø­Ø¯ Ø¨Ø§Ù„Ø§/Ù¾Ø§ÛŒÛŒÙ† ØªØ¹Ø±ÛŒÙ Ú©Ù†ÛŒ ØªØ§ Ù‡Ù†Ú¯Ø§Ù… Ø¹Ø¨ÙˆØ± Ù‚ÛŒÙ…Øª Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ùˆ Ù‡Ø´Ø¯Ø§Ø± ØµÙˆØªÛŒ ØµØ§Ø¯Ø± Ø´ÙˆØ¯.<br>
          â€¢ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ ØµØ§Ø¯Ø±Ø§Øª/Ø¯Ø±ÙˆÙ†â€ŒØ±ÛŒØ²ÛŒ Ø¨Ø±Ø§ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯.
        </div>
      </div>
      <div style="width:260px">
        <div class="kv"><div class="small-muted">ØªØ§ÛŒÙ… ØªØ±ÛŒØ¯ ØµØ¨Ø­</div><div>10:30 â€” 12:00</div></div>
        <div class="kv"><div class="small-muted">ØªØ§ÛŒÙ… ØªØ±ÛŒØ¯ Ø´Ø¨</div><div>18:00 â€” 22:00</div></div>
        <div class="hr"></div>
        <div class="small-muted">Ù†Ú©ØªÙ‡: Ø¨Ø±Ø±Ø³ÛŒ Ù‡Ù…Ø²Ù…Ø§Ù† Ø§Ù†Ø³ Ùˆ Ø¯Ù„Ø§Ø± Ø¬Ù‡Ø§Ù†ÛŒØŒ Ø§Ø¹ØªØ¨Ø§Ø± Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø±Ø§ Ø¨Ø§Ù„Ø§ Ù…ÛŒâ€ŒØ¨Ø±Ø¯.</div>
      </div>
    </div>
  </div>

  <!-- ÙˆØ±ÙˆØ¯ÛŒ Ù‡Ø§ -->
  <div class="card">
    <h3 style="margin:0 0 8px;color:var(--accent)">ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù‚ÛŒÙ…Øª (Ø¯Ø³ØªÛŒ ÛŒØ§ API)</h3>
    <div class="grid">
      <div>
        <label>Ù‚ÛŒÙ…Øª Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø± (ØªÙˆÙ…Ø§Ù†)</label>
        <input id="gold18" type="number" placeholder="Ù…Ø«Ø§Ù„: 12679000" step="any">
      </div>
      <div>
        <label>Ù‚ÛŒÙ…Øª Ø¯Ù„Ø§Ø± (ØªÙˆÙ…Ø§Ù†)</label>
        <input id="usd" type="number" placeholder="Ù…Ø«Ø§Ù„: 125000" step="any">
      </div>
      <div>
        <label>Ù‚ÛŒÙ…Øª Ø§Ù†Ø³ Ø¬Ù‡Ø§Ù†ÛŒ (Ø¯Ù„Ø§Ø±)</label>
        <input id="ounce" type="number" placeholder="Ù…Ø«Ø§Ù„: 1960.12" step="any">
      </div>
      <div>
        <label>Ø§Ø¬Ø±Øª + Ù…Ø§Ù„ÛŒØ§Øª + Ø³ÙˆØ¯ (%)</label>
        <input id="fee" type="number" placeholder="Ù…Ø«Ø§Ù„: 1.2" step="any">
      </div>
    </div>

    <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;align-items:center">
      <button onclick="addData()">Ø«Ø¨Øª Ø¯Ø§Ø¯Ù‡ (Ø¯Ø³ØªÛŒ)</button>
      <button class="btn-ghost" onclick="fetchFromAPI()">ğŸ“¡ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø² API (BRSAPI)</button>
      <button class="btn-ghost" onclick="editLastAPI()">âœï¸ Ø§ØµÙ„Ø§Ø­ Ø¢Ø®Ø±ÛŒÙ† Ù‚ÛŒÙ…Øª API</button>

      <div style="flex:1"></div>

      <div style="min-width:220px">
        <label>API Ú©Ù„ÛŒØ¯ Ø¨Ø±Ø§ÛŒ RSI (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
        <div class="input-inline"><input id="rsiApiKey" type="text" placeholder="Ù…Ø«Ø§Ù„: ALPHAVANTAGE_KEY"><button class="btn-ghost" onclick="saveRSIKey()">Ø°Ø®ÛŒØ±Ù‡</button></div>
        <div class="small-muted" style="margin-top:6px">Ø§Ú¯Ø± ÙˆØ§Ø±Ø¯ Ù†Ø´ÙˆØ¯ØŒ RSI Ø§Ø² ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
      </div>
    </div>

    <div class="hr"></div>
    <div class="result" id="goldResult">ÙˆØ¶Ø¹ÛŒØª: Ø¢Ù…Ø§Ø¯Ù‡</div>
    <div class="kv" style="margin-top:8px"><div class="small-muted">ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª API Ø§Ù…Ø±ÙˆØ²</div><div id="apiCounter">0</div></div>
  </div>

  <!-- AutoFetch & Limits -->
  <div class="card">
    <h3 style="margin:0 0 8px;color:var(--accent)">ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø®ÙˆØ¯Ú©Ø§Ø± API Ùˆ Ù‡Ø´Ø¯Ø§Ø± Ù‚ÛŒÙ…Øª</h3>
    <div class="grid">
      <div>
        <label>Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú©Ù„ Ø¯Ø± Ø¨Ø§Ø²Ù‡ 18:00â€“22:00 (Ø­Ø¯Ø§Ú©Ø«Ø± 1500)</label>
        <input id="maxRequests" type="number" value="100" min="1" max="1500">
      </div>
      <div>
        <label>Ø§Ø¬Ø±Ø§ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±ØŸ</label>
        <div style="display:flex;gap:8px"><button onclick="startAutoFetch()">â–¶ Ø´Ø±ÙˆØ¹ Ø¯Ø± 18:00</button><button class="btn-ghost" onclick="stopAutoFetch()">â–  ØªÙˆÙ‚Ù</button></div>
      </div>
      <div>
        <label>Ø­Ø¯ Ù¾Ø§ÛŒÛŒÙ† Ù‡Ø´Ø¯Ø§Ø± (ØªÙˆÙ…Ø§Ù†)</label>
        <input id="lowLimit" type="number" placeholder="Ù…Ø«Ø§Ù„: 12000000">
      </div>
      <div>
        <label>Ø­Ø¯ Ø¨Ø§Ù„Ø§ Ù‡Ø´Ø¯Ø§Ø± (ØªÙˆÙ…Ø§Ù†)</label>
        <input id="highLimit" type="number" placeholder="Ù…Ø«Ø§Ù„: 18000000">
      </div>
    </div>

    <div class="hr"></div>
    <div class="counter-box">
      <div>Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡: <strong id="doneCount">0</strong></div>
      <div>Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: <strong id="leftCount">0</strong></div>
      <div>Ø¨Ø¹Ø¯ÛŒ Ø¯Ø±: <strong id="nextIn">â€”</strong> Ø«Ø§Ù†ÛŒÙ‡</div>
    </div>
    <div class="small-muted" style="margin-top:8px">ØªØ°Ú©Ø±: Ø§Ú¯Ø± ØµÙØ­Ù‡ Ø±Ø§ Ø¨Ø¨Ù†Ø¯ÛŒ Ø§Ø¬Ø±Ø§ Ù‚Ø·Ø¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯ (Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§ÛŒ Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø³Ø±ÙˆÛŒØ³â€ŒÙˆØ±Ú©Ø±/Ø¨Ú©â€ŒØ§Ù†Ø¯ Ø§Ø³Øª).</div>
    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn-ghost" onclick="window.resetApiCounter()">Ø±ÛŒØ³Øª Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ API</button>
      <button class="btn-ghost" onclick="window.clearAllData()">Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</button>
      <button onclick="exportData()">ØµØ§Ø¯Ø±Ø§Øª JSON</button>
      <label class="btn-ghost" style="padding:8px;border-radius:8px;cursor:pointer">
        Ø¯Ø±ÙˆÙ†â€ŒØ±ÛŒØ²ÛŒ <input id="importFile" type="file" accept="application/json" style="display:none" onchange="importData(event)">
      </label>
    </div>
  </div>

  <!-- Ù†Ù…ÙˆØ¯Ø§Ø± Ùˆ Ø³ÛŒÚ¯Ù†Ø§Ù„ -->
  <div class="card">
    <h3 style="margin:0 0 8px;color:var(--accent)">Ù†Ù…ÙˆØ¯Ø§Ø± Ø­Ø¨Ø§Ø¨ØŒ Ø­Ù…Ø§ÛŒØª/Ù…Ù‚Ø§ÙˆÙ…Øª Ùˆ RSI</h3>
    <div style="display:flex;gap:8px;align-items:center">
      <button onclick="signal()">ğŸ” Ø¯Ø±ÛŒØ§ÙØª Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ</button>
      <div style="flex:1"></div>
      <div>
        <button id="notifyBtn" class="toggle off" onclick="toggleNotification()">ğŸ”” Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø®Ø§Ù…ÙˆØ´</button>
      </div>
    </div>

    <div class="canvas-wrap">
      <canvas id="trendChart"></canvas>
    </div>

    <div class="legend">
      <div class="dot entry-dot"></div><div class="small-muted">Ù†Ù‚Ø·Ù‡ ÙˆØ±ÙˆØ¯</div>
      <div class="dot exit-dot" style="margin-left:8px"></div><div class="small-muted">Ù†Ù‚Ø·Ù‡ Ø®Ø±ÙˆØ¬</div>
    </div>

    <div class="hr"></div>
    <div class="result" id="signalResult">Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ Ùˆ ØªØ§Ø±ÛŒØ®Ú†Ù‡Ù” Ø¢Ø®Ø±ÛŒÙ† 50 Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø¯Ø± Ø²ÛŒØ± Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>

    <div class="signals-list" id="signalsList"></div>
  </div>

  <div class="footer-small">ØªÙˆØ¶ÛŒØ­Ø§Øª ÙÙ†ÛŒ: Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¯Ø± LocalStorage Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯. Ø´Ù…Ø§Ø±Ø´Ú¯Ø± API Ø¯Ø± LocalStorage Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ ØªØ§ Ø±ÛŒØ³ØªØŒ Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯.</div>

</div>

<script>
/* -------------------------
  ØªÙ†Ø¸ÛŒÙ… Ø§ÙˆÙ„ÛŒÙ‡ Ùˆ Ù…ØªØºÛŒØ±Ù‡Ø§
--------------------------*/
const BRS_URL = "https://brsapi.ir/Api/Market/Gold_Currency.php?key=BBzNUXWfiBpUmeXusfw4mkbjXuXjj9nU"; // Ø§Ú¯Ø± ØªØºÛŒÛŒØ± Ø¯Ø§Ø¯ÛŒØ¯ Ø§ÛŒÙ† Ø±Ø§ Ø¹ÙˆØ¶ Ú©Ù†ÛŒØ¯
const STORAGE_KEYS = {
  history: 'goldHistory_v2',
  signals: 'goldSignals_v2',
  apiCounter: 'goldApiCounter_v2',
  rsiKey: 'goldRsiKey_v2',
  notify: 'goldNotify_v2'
};

let apiCounter = parseInt(localStorage.getItem(STORAGE_KEYS.apiCounter)) || 0;
let historyData = JSON.parse(localStorage.getItem(STORAGE_KEYS.history)) || [];
let signals = JSON.parse(localStorage.getItem(STORAGE_KEYS.signals)) || [];
let notifyActive = (localStorage.getItem(STORAGE_KEYS.notify) === '1');
if(notifyActive){
  document.getElementById('notifyBtn').className='toggle on';
  document.getElementById('notifyBtn').innerText='ğŸ”” Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø±ÙˆØ´Ù†';
}
document.getElementById('apiCounter').innerText = apiCounter;

// AutoFetch state
let autoState = { running:false, timerId:null, countdownId:null, nextAt: null, done:0, left:0 };

/* Chart.js setup */
const ctx = document.getElementById('trendChart').getContext('2d');
const trendChart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: [],
    datasets: [
      { label: 'Ø­Ø¨Ø§Ø¨ Ù‚ÛŒÙ…Øª (ØªÙˆÙ…Ø§Ù†)', data: [], borderColor:'#60a5fa', backgroundColor:'rgba(96,165,250,0.08)', tension:0.3, fill:true, pointRadius:5, pointBackgroundColor:[] },
      { label: 'Ø­Ù…Ø§ÛŒØª', data: [], borderColor:'#10b981', borderDash:[6,4], fill:false, pointRadius:0 },
      { label: 'Ù…Ù‚Ø§ÙˆÙ…Øª', data: [], borderColor:'#ef4444', borderDash:[6,4], fill:false, pointRadius:0 },
      { label: 'RSI', data: [], borderColor:'#f472b6', fill:false, yAxisID: 'rsiAxis', pointRadius:2 }
    ]
  },
  options: {
    responsive:true,
    interaction:{mode:'index',intersect:false},
    scales: {
      y: { position:'left', title:{display:true,text:'ØªÙˆÙ…Ø§Ù† (Ø­Ø¨Ø§Ø¨/Ø³Ø·ÙˆØ­)'} },
      rsiAxis: { position:'right', min:0, max:100, title:{display:true,text:'RSI'} }
    },
    plugins: { legend:{labels:{boxWidth:12}}}
  }
});

/* -------------------------
  ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ
--------------------------*/
function saveHistory(){ try{ localStorage.setItem(STORAGE_KEYS.history, JSON.stringify(historyData)); }catch(e){ console.warn('saveHistory', e); } }
function saveSignals(){ try{ localStorage.setItem(STORAGE_KEYS.signals, JSON.stringify(signals)); }catch(e){ console.warn('saveSignals', e); } }
function setApiCounter(n){ apiCounter = n; localStorage.setItem(STORAGE_KEYS.apiCounter, String(apiCounter)); document.getElementById('apiCounter').innerText = apiCounter; }

/* Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† n Ø±ÙˆØ² (Ù‚Ø§Ø¨Ù„ ØªØºÛŒÛŒØ±) */
function computeAverage(data, newPrice, days=5){
  if(!Array.isArray(data)) data = [];
  const recent = data.slice(-days).map(d=>d.price).filter(p=>typeof p === 'number' && !isNaN(p));
  recent.push(newPrice);
  if(recent.length === 0) return newPrice;
  const sum = recent.reduce((a,b)=>a+b,0);
  return sum / recent.length;
}

/* Ù…Ø­Ø§Ø³Ø¨Ù‡ RSI Ù¾Ø§ÛŒÙ‡ (Ø³Ø§Ø¯Ù‡ØŒ Ø·ÙˆÙ„ Ø¯ÙˆØ±Ù‡ Ù‚Ø§Ø¨Ù„ ØªÙ†Ø¸ÛŒÙ…) */
function computeRSI(prices, period=14){
  // prices: Ø¢Ø±Ø§ÛŒÙ‡Ù” Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ÛŒ Ù…ØªÙˆØ§Ù„ÛŒ (Ø¹Ø¯Ø¯) â€” Ø¨Ø§Ø²Ú¯Ø´Øª Ø¹Ø¯Ø¯ Ø¨ÛŒÙ† 0-100
  if(!Array.isArray(prices) || prices.length <= period) return 50;
  let gains = 0, losses = 0;
  for(let i = prices.length - period; i < prices.length; i++){
    const diff = prices[i] - prices[i-1];
    if(diff > 0) gains += diff;
    else losses += Math.abs(diff);
  }
  if(losses === 0) return 100;
  const rs = gains / losses;
  return 100 - (100 / (1 + rs));
}

/* ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ú¯Ø±ÙØªÙ† RSI Ø§Ø² API Ø®Ø§Ø±Ø¬ÛŒ (AlphaVantage Ù…Ø«Ø§Ù„) â€” Ù†ÛŒØ§Ø² Ø¨Ù‡ Ú©Ù„ÛŒØ¯ */
async function fetchRSIFromAPI(symbol='XAUUSD', interval='daily', time_period=14){
  const key = localStorage.getItem(STORAGE_KEYS.rsiKey);
  if(!key) return null;
  try{
    const url = `https://www.alphavantage.co/query?function=RSI&symbol=${symbol}&interval=${interval}&time_period=${time_period}&series_type=close&apikey=${encodeURIComponent(key)}`;
    const res = await fetch(url);
    const j = await res.json();
    if(j && j['Technical Analysis: RSI']){
      const lastKey = Object.keys(j['Technical Analysis: RSI'])[0];
      const val = parseFloat(j['Technical Analysis: RSI'][lastKey]['RSI']);
      if(!isNaN(val)) return val;
    }
    return null;
  }catch(e){ console.error('RSI API error', e); return null; }
}

/* Ù¾Ø®Ø´ ØµØ¯Ø§ Ùˆ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† */
function playSound(){ try{ const a = new Audio('https://www.soundjay.com/button/sounds/beep-07.mp3'); a.play().catch(()=>{}); }catch(e){console.warn(e);} }
function notify(message){
  if(!notifyActive) return;
  if(!("Notification" in window)) return;
  if(Notification.permission === 'granted'){ new Notification('Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø±', { body: message }); }
  else if(Notification.permission !== 'denied'){ Notification.requestPermission().then(p => { if(p==='granted') new Notification('Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø±', { body: message }); }); }
}

/* Ø§ÙØ²ÙˆØ¯Ù† Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ùˆ Ù†Ù…Ø§ÛŒØ´ Ù„ÛŒØ³Øª */
function pushSignal(type, text){
  const now = new Date().toLocaleString();
  const item = {type, text, ts: now};
  signals.unshift(item);
  if(signals.length>50) signals = signals.slice(0,50);
  saveSignals();
  renderSignals();
}

/* Ù†Ù…Ø§ÛŒØ´ Ù„ÛŒØ³Øª Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ */
function renderSignals(){
  const el = document.getElementById('signalsList'); el.innerHTML = '';
  if(signals.length===0){ el.innerHTML = '<div class="small-muted">Ù‡Ù†ÙˆØ² Ø³ÛŒÚ¯Ù†Ø§Ù„ÛŒ ØµØ§Ø¯Ø± Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</div>'; return; }
  signals.forEach(s=>{
    const div = document.createElement('div');
    div.className = 'signal-item';
    div.innerHTML = `<strong>[${s.type}]</strong> ${s.text} <div class="small-muted" style="margin-top:4px">${s.ts}</div>`;
    el.appendChild(div);
  });
}

/* Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ù…ÙˆØ¯Ø§Ø± */
function updateChart(){
  try{
    trendChart.data.labels = historyData.map((d,i)=> {
      if(d && d.ts) return new Date(d.ts).toLocaleTimeString();
      return i+1;
    });
    trendChart.data.datasets[0].data = historyData.map(d=>d.bubble || 0);
    trendChart.data.datasets[1].data = historyData.map(d=>d.avg ? d.avg*0.985 : null);
    trendChart.data.datasets[2].data = historyData.map(d=>d.avg ? d.avg*1.015 : null);
    trendChart.data.datasets[3].data = historyData.map(d=>d.rsi || null);
    trendChart.data.datasets[0].pointBackgroundColor = historyData.map(d=>{
      if(d && d.signal === 'entry') return '#16a34a';
      if(d && d.signal === 'exit') return '#ef4444';
      return '#60a5fa';
    });
    trendChart.update();
  }catch(e){ console.error('chart update error', e); }
}

/* Ø°Ø®ÛŒØ±Ù‡ Ú©Ù„ÛŒØ¯ RSI */
function saveRSIKey(){
  const key = document.getElementById('rsiApiKey').value.trim();
  if(!key){ alert('Ú©Ù„ÛŒØ¯ ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡'); return; }
  try{
    localStorage.setItem(STORAGE_KEYS.rsiKey, key);
    document.getElementById('goldResult').innerText = 'Ú©Ù„ÛŒØ¯ RSI Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯. Ø¯Ø± Ø¯ÙØ¹Ø§Øª Ø¨Ø¹Ø¯ÛŒ ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª RSI Ø§Ø² API Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯.';
  }catch(e){ alert('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ú©Ù„ÛŒØ¯'); console.error(e); }
}

/* ÙˆÛŒØ±Ø§ÛŒØ´ Ø¢Ø®Ø±ÛŒÙ† Ù‚ÛŒÙ…Øª API (Ø¯Ø± ØµÙˆØ±ØªÛŒ Ú©Ù‡ Ø§Ø´ØªØ¨Ø§Ù‡ Ø¨Ø§Ø´Ø¯) */
function editLastAPI(){
  if(historyData.length===0){ alert('Ù‡Ù†ÙˆØ² Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.'); return; }
  const last = historyData[historyData.length-1];
  const pretty = last && last.price ? last.price : '';
  const newVal = prompt('Ù‚ÛŒÙ…Øª Ø§ØµÙ„Ø§Ø­â€ŒØ´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø¢Ø®Ø±ÛŒÙ† Ø«Ø¨Øª API Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (ØªÙˆÙ…Ø§Ù†):', String(pretty));
  if(newVal === null) return;
  const n = parseFloat(newVal);
  if(isNaN(n)){ alert('Ù‚ÛŒÙ…Øª Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
  historyData[historyData.length-1].price = n;
  const avg = computeAverage(historyData.slice(0,-1), n);
  historyData[historyData.length-1].avg = avg;
  historyData[historyData.length-1].bubble = n - avg;
  const prices = historyData.map(d=>d.price);
  historyData[historyData.length-1].rsi = computeRSI(prices,14);
  saveHistory(); updateChart();
  document.getElementById('goldResult').innerText = 'Ø¢Ø®Ø±ÛŒÙ† Ù‚ÛŒÙ…Øª API Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ØµÙ„Ø§Ø­ Ø´Ø¯.';
}

/* -------------------------
  Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø§Ø¯Ù‡ (Ø¯Ø³ØªÛŒ)
--------------------------*/
async function addData(){
  const goldRaw = document.getElementById('gold18').value;
  const gold = goldRaw === '' ? null : parseFloat(goldRaw);
  const usdRaw = document.getElementById('usd').value;
  const usd = usdRaw === '' ? null : parseFloat(usdRaw);
  const ounceRaw = document.getElementById('ounce').value;
  const ounce = ounceRaw === '' ? null : parseFloat(ounceRaw);
  const feeRaw = document.getElementById('fee').value;
  const fee = feeRaw === '' ? 0 : parseFloat(feeRaw);

  if((gold === null || isNaN(gold)) && ((usd === null || isNaN(usd)) || (ounce === null || isNaN(ounce)))){
    document.getElementById('goldResult').innerText = 'Ù„Ø·ÙØ§Ù‹ ÛŒØ§ Ù‚ÛŒÙ…Øª Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø¯Ù„Ø§Ø± Ùˆ Ø§Ù†Ø³ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯.';
    return;
  }

  // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù‚ÛŒÙ…Øª Ù†Ù‡Ø§ÛŒÛŒ: Ø§ÙˆÙ„ÙˆÛŒØª Ø¨Ù‡ Ù‚ÛŒÙ…Øª Ø¯Ø³ØªÛŒ
  let finalPrice;
  if(gold !== null && !isNaN(gold) && gold > 0) finalPrice = gold;
  else {
    // ØªØ¨Ø¯ÛŒÙ„ Ø§Ù†Ø³(Ø¯Ù„Ø§Ø±) Ã— Ø¯Ù„Ø§Ø±(ØªÙˆÙ…Ø§Ù†) â†’ Ù‡Ø± Ú¯Ø±Ù… (Ø§Ù†Ø³=31.1035g Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø§ÙˆÙ†Ø³ Ø·Ù„Ø§)
    finalPrice = ((ounce * usd) / 31.1035) * (1 + (isNaN(fee) ? 0 : fee/100));
  }
  finalPrice = Number(finalPrice);

  const avg = computeAverage(historyData, finalPrice, 5);
  const bubble = finalPrice - avg;

  // RSI: ØªÙ„Ø§Ø´ Ø§ÙˆÙ„ Ø¨Ø±Ø§ÛŒ API Ø§Ú¯Ø± Ù…ÙˆØ¬ÙˆØ¯ Ø¨ÙˆØ¯ØŒ ÙˆÚ¯Ø±Ù†Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¯Ø§Ø®Ù„ÛŒ
  let rsi = 50;
  const pricesForRSI = [...historyData.map(d=>d.price).filter(p=>typeof p==='number'), finalPrice];
  const rsiKey = localStorage.getItem(STORAGE_KEYS.rsiKey);
  if(rsiKey){
    try{
      const fetched = await fetchRSIFromAPI('XAUUSD','daily',14);
      if(fetched !== null && !isNaN(fetched)) rsi = fetched;
      else rsi = computeRSI(pricesForRSI,14);
    }catch(e){ rsi = computeRSI(pricesForRSI,14); }
  } else {
    rsi = computeRSI(pricesForRSI,14);
  }

  // Ø±ÙˆÙ†Ø¯ Ø¯Ù„Ø§Ø±/Ø§Ù†Ø³ Ù†Ø³Ø¨Øª Ø¨Ù‡ Ø¢Ø®Ø±ÛŒÙ†
  let usdTrend = 'â€”', ounceTrend = 'â€”';
  if(historyData.length>0){
    const last = historyData[historyData.length-1];
    if(usd !== null && typeof last.usd === 'number') usdTrend = (usd > last.usd ? 'Ù…Ø«Ø¨Øª' : (usd < last.usd ? 'Ù…Ù†ÙÛŒ' : 'Ø«Ø§Ø¨Øª'));
    if(ounce !== null && typeof last.ounce === 'number') ounceTrend = (ounce > last.ounce ? 'Ù…Ø«Ø¨Øª' : (ounce < last.ounce ? 'Ù…Ù†ÙÛŒ' : 'Ø«Ø§Ø¨Øª'));
  }

  const now = Date.now();
  const obj = { price: finalPrice, avg: avg, bubble: bubble, rsi: rsi, usd: usd, ounce: ounce, fee: fee, ts: now, usdTrend: usdTrend, ounceTrend: ounceTrend };
  historyData.push(obj);
  saveHistory(); updateChart();
  document.getElementById('goldResult').innerText = `Ø«Ø¨Øª Ø´Ø¯: ${finalPrice.toLocaleString()} ØªÙˆÙ…Ø§Ù† | Ø­Ø¨Ø§Ø¨: ${Math.round(bubble).toLocaleString()} ØªÙˆÙ…Ø§Ù† | RSI: ${Number(rsi).toFixed(2)}`;
  // Ø¨Ø¹Ø¯ Ø§Ø² Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø³ØªÛŒØŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ú†Ú© Ù‡Ø´Ø¯Ø§Ø±
  autoSignalCheck();
}

/* -------------------------
  Ø¯Ø±ÛŒØ§ÙØª Ø§Ø² BRSAPI (Ùˆ Ø§ÙØ²ÙˆØ¯Ù† Ø®ÙˆØ¯Ú©Ø§Ø±)
--------------------------*/
async function fetchFromAPI(){
  // Ø­Ø¯Ø§Ú©Ø«Ø± Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ Ø¯Ø± LocalStorage Ø¨Ø±Ø±Ø³ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯
  const maxAllowed = parseInt(document.getElementById('maxRequests').value)||100;
  if(apiCounter >= maxAllowed){
    document.getElementById('goldResult').innerText = `âš  Ø³Ù‚Ù ${maxAllowed} Ø¯Ø±Ø®ÙˆØ§Ø³Øª API Ø§Ù…Ø±ÙˆØ² Ø±Ø³ÛŒØ¯!`;
    return;
  }
  try{
    const res = await fetch(BRS_URL);
    const j = await res.json();
    // Ø³Ø¹ÛŒ Ú©Ù† Ø³Ø§Ø®ØªØ§Ø±Ù‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù Ø±Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ú©Ù†ÛŒ
    let gold18 = null, ounce = null, usd = null;
    try{
      if(Array.isArray(j.gold)){
        const goldObj = j.gold.find(i=>i.symbol && i.symbol.includes('18'));
        const xauObj = j.gold.find(i=>i.symbol && (i.symbol==='XAUUSD' || i.symbol.includes('XAU')));
        if(goldObj) gold18 = parseFloat(goldObj.price);
        if(xauObj) ounce = parseFloat(xauObj.price);
      }
      if(Array.isArray(j.currency)){
        const usdObj = j.currency.find(i=>i.symbol && i.symbol.includes('USD'));
        if(usdObj) usd = parseFloat(usdObj.price);
      }
    }catch(e){}
    // Ø§Ú¯Ø± Ù‚ÛŒÙ…Øª Ø·Ù„Ø§ÛŒ Û±Û¸ Ù…ÙˆØ¬ÙˆØ¯ Ù†Ø¨ÙˆØ¯ Ø§Ù…Ø§ Ø§Ù†Ø³ Ùˆ Ø¯Ù„Ø§Ø± Ù…ÙˆØ¬ÙˆØ¯ Ø¨ÙˆØ¯ØŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ú©Ù†
    if((gold18 === null || isNaN(gold18)) && (ounce !== null && usd !== null && !isNaN(ounce) && !isNaN(usd))){
      gold18 = ((ounce * usd) / 31.1035);
    }
    // write to inputs (if present)
    if(!isNaN(gold18)) document.getElementById('gold18').value = Math.round(gold18);
    if(!isNaN(usd)) document.getElementById('usd').value = Number(usd);
    if(!isNaN(ounce)) document.getElementById('ounce').value = Number(ounce);

    setApiCounter(apiCounter + 1);
    document.getElementById('goldResult').innerText = `Ø¢Ø®Ø±ÛŒÙ† Ù‚ÛŒÙ…Øª API: ${gold18 ? Math.round(gold18).toLocaleString() + ' ØªÙˆÙ…Ø§Ù†' : 'Ù†Ø§Ù…Ø´Ø®Øµ'} â€” Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯...`;
    await addData();
    autoSignalCheck();
  }catch(err){ console.error(err); document.getElementById('goldResult').innerText = 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡ Ø§Ø² API'; }
}

/* -------------------------
  ØªÙˆÙ„ÛŒØ¯ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ùˆ Ø¹Ù„Ø§Ù…Øª Ú¯Ø°Ø§Ø±ÛŒ Ø±ÙˆÛŒ Ù†Ù…ÙˆØ¯Ø§Ø±
--------------------------*/
function autoSignalCheck(){
  if(historyData.length===0) return;
  const last = historyData[historyData.length-1];
  const support = last.avg * 0.985;
  const resistance = last.avg * 1.015;
  let txt = '';
  if(last.bubble < -20000 && last.price <= support){
    txt = `ğŸŸ¢ Ø³ÛŒÚ¯Ù†Ø§Ù„ ÙˆØ±ÙˆØ¯ Ù‚ÙˆÛŒ â€” Ù‚ÛŒÙ…Øª Ù†Ø²Ø¯ÛŒÚ© Ø­Ù…Ø§ÛŒØª: ${Math.round(support).toLocaleString()}`;
    pushSignal('ÙˆØ±ÙˆØ¯', txt); playSound(); notify(txt);
    historyData[historyData.length-1].signal = 'entry';
  } else if(last.bubble > 20000 && last.price >= resistance){
    txt = `ğŸ”´ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø®Ø±ÙˆØ¬ Ù‚ÙˆÛŒ â€” Ù‚ÛŒÙ…Øª Ù†Ø²Ø¯ÛŒÚ© Ù…Ù‚Ø§ÙˆÙ…Øª: ${Math.round(resistance).toLocaleString()}`;
    pushSignal('Ø®Ø±ÙˆØ¬', txt); playSound(); notify(txt);
    historyData[historyData.length-1].signal = 'exit';
  } else { historyData[historyData.length-1].signal = null; }
  saveHistory(); updateChart();
  renderSignals();
  // Ø¨Ø±Ø±Ø³ÛŒ Ø­Ø¯ Ø¨Ø§Ù„Ø§/Ù¾Ø§ÛŒÛŒÙ† Ùˆ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª
  checkLimitsAndAlert(last.price);
}

/* -------------------------
  Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø¯Ú©Ù…Ù‡â€ŒØ§ÛŒ
--------------------------*/
function signal(){
  if(historyData.length===0){ document.getElementById('signalResult').innerText = 'Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡'; return; }
  const last = historyData[historyData.length-1];
  const support = last.avg * 0.985;
  const resistance = last.avg * 1.015;
  let resText='';
  if(last.bubble < -20000 && last.price <= support){
    resText = `ğŸŸ¢ Ø³ÛŒÚ¯Ù†Ø§Ù„ ÙˆØ±ÙˆØ¯ Ù‚ÙˆÛŒ â€” Ù‚ÛŒÙ…Øª Ù†Ø²Ø¯ÛŒÚ© Ø­Ù…Ø§ÛŒØª: ${Math.round(support).toLocaleString()} | RSI: ${Number(last.rsi).toFixed(2)}`;
    playSound(); notify(resText); pushSignal('ÙˆØ±ÙˆØ¯', resText); historyData[historyData.length-1].signal = 'entry';
  } else if(last.bubble > 20000 && last.price >= resistance){
    resText = `ğŸ”´ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø®Ø±ÙˆØ¬ Ù‚ÙˆÛŒ â€” Ù‚ÛŒÙ…Øª Ù†Ø²Ø¯ÛŒÚ© Ù…Ù‚Ø§ÙˆÙ…Øª: ${Math.round(resistance).toLocaleString()} | RSI: ${Number(last.rsi).toFixed(2)}`;
    playSound(); notify(resText); pushSignal('Ø®Ø±ÙˆØ¬', resText); historyData[historyData.length-1].signal = 'exit';
  } else {
    resText = `âš– Ø¨Ø§Ø²Ø§Ø± Ø®Ù†Ø«ÛŒ â€” Ø­Ø¨Ø§Ø¨: ${Math.round(last.bubble).toLocaleString()} ØªÙˆÙ…Ø§Ù† | RSI: ${Number(last.rsi).toFixed(2)} | Ø±ÙˆÙ†Ø¯ Ø¯Ù„Ø§Ø±: ${last.usdTrend} | Ø§Ù†Ø³: ${last.ounceTrend}`;
    pushSignal('Ø®Ù†Ø«ÛŒ', resText); historyData[historyData.length-1].signal = null;
  }
  saveHistory(); updateChart(); renderSignals(); document.getElementById('signalResult').innerText = resText;
}

/* -------------------------
  Ø­Ø¯ Ø¨Ø§Ù„Ø§/Ù¾Ø§ÛŒÛŒÙ† Ùˆ Ù‡Ø´Ø¯Ø§Ø±
--------------------------*/
function checkLimitsAndAlert(price){
  const low = (document.getElementById('lowLimit').value === '') ? null : parseFloat(document.getElementById('lowLimit').value);
  const high = (document.getElementById('highLimit').value === '') ? null : parseFloat(document.getElementById('highLimit').value);
  const statusEl = document.getElementById('goldResult');
  if(low !== null && !isNaN(low) && price <= low){
    statusEl.innerHTML = `<span class="status-badge status-low">Ù‚ÛŒÙ…Øª â‰¤ Ø­Ø¯ Ù¾Ø§ÛŒÛŒÙ†</span> Ù‚ÛŒÙ…Øª: ${Math.round(price).toLocaleString()} ØªÙˆÙ…Ø§Ù†`;
    playSound(); notify(`âš  Ù‚ÛŒÙ…Øª Ø·Ù„Ø§ÛŒ Û±Û¸ â‰¤ Ø­Ø¯ Ù¾Ø§ÛŒÛŒÙ† (${Math.round(low).toLocaleString()})`);
    pushSignal('Ù‡Ø´Ø¯Ø§Ø±', `Ù‚ÛŒÙ…Øª Ø¨Ù‡ Ø­Ø¯ Ù¾Ø§ÛŒÛŒÙ† Ø±Ø³ÛŒØ¯: ${Math.round(price).toLocaleString()} ØªÙˆÙ…Ø§Ù†`);
    return;
  }
  if(high !== null && !isNaN(high) && price >= high){
    statusEl.innerHTML = `<span class="status-badge status-high">Ù‚ÛŒÙ…Øª â‰¥ Ø­Ø¯ Ø¨Ø§Ù„Ø§</span> Ù‚ÛŒÙ…Øª: ${Math.round(price).toLocaleString()} ØªÙˆÙ…Ø§Ù†`;
    playSound(); notify(`âš  Ù‚ÛŒÙ…Øª Ø·Ù„Ø§ÛŒ Û±Û¸ â‰¥ Ø­Ø¯ Ø¨Ø§Ù„Ø§ (${Math.round(high).toLocaleString()})`);
    pushSignal('Ù‡Ø´Ø¯Ø§Ø±', `Ù‚ÛŒÙ…Øª Ø¨Ù‡ Ø­Ø¯ Ø¨Ø§Ù„Ø§ Ø±Ø³ÛŒØ¯: ${Math.round(price).toLocaleString()} ØªÙˆÙ…Ø§Ù†`);
    return;
  }
  // Ù†Ø±Ù…Ø§Ù„
  statusEl.innerHTML = `Ù‚ÛŒÙ…Øª ÙØ¹Ù„ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯: ${Math.round(price).toLocaleString()} ØªÙˆÙ…Ø§Ù†`;
}

/* -------------------------
  AutoFetch: Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ø¨ÛŒÙ† 18:00 ØªØ§ 22:00
--------------------------*/
function startAutoFetch(){
  if(autoState.running){ alert('AutoFetch Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§Ø³Øª'); return; }
  const maxReq = parseInt(document.getElementById('maxRequests').value) || 100;
  if(maxReq < 1 || maxReq > 1500){ alert('Ø­Ø¯Ø§Ú©Ø«Ø± Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† 1 Ùˆ 1500 Ø¨Ø§Ø´Ø¯'); return; }

  // Ù…Ø­Ø§Ø³Ø¨Ù‡ ÙØ§ØµÙ„Ù‡ Ø«Ø§Ù†ÛŒÙ‡â€ŒØ§ÛŒ Ø¨ÛŒÙ† Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ Ø¯Ø§Ø®Ù„ Ø¨Ø§Ø²Ù‡ 18-22
  const windowSeconds = (22 - 18) * 3600; // 4 Ø³Ø§Ø¹Øª = 14400 Ø«Ø§Ù†ÛŒÙ‡
  let intervalSec = Math.floor(windowSeconds / maxReq);
  if(intervalSec < 3) intervalSec = 3; // Ø­Ø¯Ø§Ù‚Ù„ 3 Ø«Ø§Ù†ÛŒÙ‡ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ…Ù†ÛŒ
  autoState.running = true;
  autoState.done = 0;
  autoState.left = Math.max(0, maxReq - apiCounter);
  document.getElementById('doneCount').innerText = autoState.done;
  document.getElementById('leftCount').innerText = autoState.left;

  function scheduleNext(){
    const now = new Date();
    const hour = now.getHours();
    let nextDelay = 0;
    if(hour >= 18 && hour < 22){
      nextDelay = 0;
    } else {
      const nextStart = new Date(now);
      nextStart.setHours(18,0,0,0);
      if(now >= nextStart) nextStart.setDate(nextStart.getDate() + 1);
      nextDelay = Math.max(0, Math.floor((nextStart - now)/1000));
    }
    if(nextDelay > 0){
      document.getElementById('nextIn').innerText = nextDelay;
      autoState.countdownId = setInterval(()=>{
        nextDelay -= 1;
        document.getElementById('nextIn').innerText = nextDelay;
        if(nextDelay<=0){ clearInterval(autoState.countdownId); beginLoop(); }
      },1000);
    } else {
      beginLoop();
    }
  }

  function beginLoop(){
    const intervalSecLocal = intervalSec;
    autoState.timerId = setInterval(async ()=>{
      const now = new Date();
      const hour = now.getHours();
      if(hour >= 18 && hour < 22){
        if(apiCounter >= maxReq){ stopAutoFetch(); return; }
        await fetchFromAPI();
        autoState.done += 1;
        autoState.left = Math.max(0, maxReq - apiCounter);
        document.getElementById('doneCount').innerText = autoState.done;
        document.getElementById('leftCount').innerText = autoState.left;
        autoState.nextAt = Date.now() + intervalSecLocal*1000;
        document.getElementById('nextIn').innerText = intervalSecLocal;
      } else {
        stopAutoFetch();
      }
    }, intervalSecLocal * 1000);

    autoState.countdownId = setInterval(()=>{
      if(!autoState.nextAt) return;
      const s = Math.max(0, Math.ceil((autoState.nextAt - Date.now())/1000));
      document.getElementById('nextIn').innerText = s;
    }, 500);
  }

  scheduleNext();
  document.getElementById('goldResult').innerText = 'AutoFetch Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ Ø´Ø¯Ø› Ù…Ù†ØªØ¸Ø± Ø´Ø±ÙˆØ¹ ÛŒØ§ Ø§Ø¬Ø±Ø§ÛŒ Ø¢Ù† Ø¨Ø§Ø´ÛŒØ¯.';
}

function stopAutoFetch(){
  if(autoState.timerId) clearInterval(autoState.timerId);
  if(autoState.countdownId) clearInterval(autoState.countdownId);
  autoState = { running:false, timerId:null, countdownId:null, nextAt: null, done:0, left:0 };
  document.getElementById('nextIn').innerText = 'â€”';
  document.getElementById('doneCount').innerText = '0';
  document.getElementById('leftCount').innerText = '0';
  document.getElementById('goldResult').innerText = 'AutoFetch Ù…ØªÙˆÙ‚Ù Ø´Ø¯.';
}

/* -------------------------
  ÙˆØ¶Ø¹ÛŒØª Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†
--------------------------*/
function toggleNotification(){
  notifyActive = !notifyActive;
  localStorage.setItem(STORAGE_KEYS.notify, notifyActive ? '1' : '0');
  const btn = document.getElementById('notifyBtn');
  if(notifyActive){ btn.className = 'toggle on'; btn.innerText = 'ğŸ”” Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø±ÙˆØ´Ù†'; Notification.requestPermission().catch(()=>{}); }
  else { btn.className = 'toggle off'; btn.innerText = 'ğŸ”” Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø®Ø§Ù…ÙˆØ´'; }
}

/* -------------------------
  Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ù†Ù…ÙˆØ¯Ø§Ø± Ùˆ Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§
--------------------------*/
function init(){
  updateChart(); renderSignals();
  document.getElementById('apiCounter').innerText = apiCounter;
  document.getElementById('leftCount').innerText = 0;
  // Ø§Ú¯Ø± Ú©Ù„ÛŒØ¯ RSI Ø¯Ø± localStorage Ø¨ÙˆØ¯ØŒ Ù…Ù‚Ø¯Ø§Ø± ÙˆØ±ÙˆØ¯ÛŒ Ø±Ø§ Ù†Ø´Ø§Ù† Ø¨Ø¯Ù‡
  const rkey = localStorage.getItem(STORAGE_KEYS.rsiKey);
  if(rkey) document.getElementById('rsiApiKey').value = rkey;
}
init();

/* -------------------------
  ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø§Ø¶Ø§ÙÛŒ (Ø±ÛŒØ³ØªØŒ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒØŒ ØµØ§Ø¯Ø±Ø§Øª/Ø¯Ø±ÙˆÙ†â€ŒØ±ÛŒØ²ÛŒ)
--------------------------*/
window.resetApiCounter = function(){
  if(confirm('Ø¢ÛŒØ§ Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ API Ø±Ø§ Ø±ÛŒØ³Øª Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯ØŸ (Ø±ÙˆØ²Ø§Ù†Ù‡)')){
    setApiCounter(0);
    alert('Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ Ø±ÛŒØ³Øª Ø´Ø¯.');
  }
};
window.clearAllData = function(){
  if(!confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø´ÙˆÙ†Ø¯ØŸ')) return;
  historyData = []; signals = []; saveHistory(); saveSignals(); updateChart(); renderSignals();
  document.getElementById('goldResult').innerText = 'Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø´Ø¯.';
};

function exportData(){
  const dump = {
    history: historyData,
    signals: signals,
    apiCounter: apiCounter,
    savedAt: Date.now()
  };
  const blob = new Blob([JSON.stringify(dump, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `gold-backup-${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

function importData(event){
  const f = event.target.files && event.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = function(e){
    try{
      const j = JSON.parse(e.target.result);
      if(Array.isArray(j.history)) historyData = j.history;
      if(Array.isArray(j.signals)) signals = j.signals;
      if(typeof j.apiCounter === 'number') setApiCounter(j.apiCounter);
      saveHistory(); saveSignals(); updateChart(); renderSignals();
      alert('Ø¯Ø±ÙˆÙ†â€ŒØ±ÛŒØ²ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.');
    }catch(err){ alert('ÙØ§ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.'); console.error(err); }
  };
  reader.readAsText(f);
}

/* -------------------------
  Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯ Ø³Ø±ÛŒØ¹
--------------------------*/
window.addEventListener('error', function(e){ console.error('global error', e); });
</script>
</body>
</html>
