<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø± Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ â€” AutoFetch Ø¯Ù‚ÛŒÙ‚</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{--bg1:#0f1720;--card:#1f2937;--accent:#ffd369;--muted:#9bd7ff}
*{box-sizing:border-box}
body{margin:0;padding:14px;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:linear-gradient(180deg,var(--bg1),#0b1116);color:#fff}
.container{max-width:980px;margin:0 auto}
.header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
.title{font-size:1.25rem;color:var(--accent);font-weight:700}
.small{font-size:0.85rem;color:#cbd5e1}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:14px;margin-bottom:12px;box-shadow:0 6px 30px rgba(0,0,0,0.6);border:1px solid rgba(255,211,105,0.06)}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
@media(max-width:740px){.grid{grid-template-columns:1fr}}
label{display:block;font-size:0.85rem;margin-bottom:6px;color:#d1d5db}
input[type=number],input[type=text]{width:100%;padding:8px;border-radius:8px;border:none;background:#0b1220;color:#fff}
button{padding:9px 12px;border-radius:10px;border:none;background:var(--accent);color:#000;font-weight:600;cursor:pointer}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff}
.result{background:#071018;padding:10px;border-radius:8px;margin-top:8px;border:1px solid rgba(255,255,255,0.03);font-size:0.95rem}
.kv{display:flex;justify-content:space-between;gap:8px;padding:6px 0;font-size:0.95rem}
.tip{color:var(--muted);font-size:0.88rem;line-height:1.45}
.footer-small{font-size:0.82rem;color:#94a3b8;margin-top:8px}
.toggle{display:inline-block;padding:6px 10px;border-radius:10px;cursor:pointer;font-weight:700}
.toggle.on{background:#16a34a;color:#fff}
.toggle.off{background:#ef4444;color:#fff}
.signals-list{max-height:160px;overflow:auto;margin-top:8px;border-radius:8px;padding:8px;border:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent)}
.signal-item{padding:6px;border-bottom:1px dashed rgba(255,255,255,0.03);font-size:0.9rem}
.canvas-wrap{background:#06121a;padding:8px;border-radius:10px;margin-top:8px}
.legend{display:flex;gap:8px;align-items:center;margin-top:8px}
.legend .dot{width:12px;height:12px;border-radius:3px;display:inline-block}
.entry-dot{background:#16a34a}
.exit-dot{background:#ef4444}
.hr{height:1px;background:rgba(255,255,255,0.03);margin:12px 0;border-radius:2px}
.small-muted{color:#94a3b8;font-size:0.85rem}
.input-inline{display:flex;gap:8px}
.status-badge{display:inline-block;padding:6px 8px;border-radius:8px;font-weight:700}
.status-normal{background:#374151;color:#fff}
.status-high{background:#065f46;color:#fff}
.status-low{background:#7f1d1d;color:#fff}
.counter-box{display:flex;gap:12px;align-items:center}
.counter-box div{min-width:120px}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div>
      <div class="title">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø± â€” Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ</div>
      <div class="small">AutoFetch Ø¯Ù‚ÛŒÙ‚ Ø¨Ø§ RSI Ùˆ Ù‡Ø´Ø¯Ø§Ø±</div>
    </div>
    <div class="small-muted">LocalStorage Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ â€¢ API Ø·Ù„Ø§ÛŒ Û±Û¸ØŒ Ø¯Ù„Ø§Ø± Ùˆ Ø§Ù†Ø³ + RSI</div>
  </div>

  <!-- ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ -->
  <div class="card">
    <h3 style="margin:0 0 8px;color:var(--accent)">ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ Ùˆ API</h3>
    <div class="grid">
      <div><label>Ù‚ÛŒÙ…Øª Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø± (ØªÙˆÙ…Ø§Ù†)</label><input id="gold18" type="number"></div>
      <div><label>Ù‚ÛŒÙ…Øª Ø¯Ù„Ø§Ø± (ØªÙˆÙ…Ø§Ù†)</label><input id="usd" type="number"></div>
      <div><label>Ù‚ÛŒÙ…Øª Ø§Ù†Ø³ Ø¬Ù‡Ø§Ù†ÛŒ (Ø¯Ù„Ø§Ø±)</label><input id="ounce" type="number"></div>
      <div><label>Ø§Ø¬Ø±Øª + Ù…Ø§Ù„ÛŒØ§Øª + Ø³ÙˆØ¯ (%)</label><input id="fee" type="number"></div>
    </div>
    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <button onclick="addData()">Ø«Ø¨Øª Ø¯Ø§Ø¯Ù‡ (Ø¯Ø³ØªÛŒ)</button>
      <button class="btn-ghost" onclick="fetchFromAPI()">ğŸ“¡ Ø¯Ø±ÛŒØ§ÙØª Ø®ÙˆØ¯Ú©Ø§Ø± API</button>
      <button class="btn-ghost" onclick="editLastAPI()">âœï¸ Ø§ØµÙ„Ø§Ø­ Ø¢Ø®Ø±ÛŒÙ† Ø¯Ø§Ø¯Ù‡</button>
      <button class="btn-ghost" onclick="clearLast()">âŒ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø¢Ø®Ø±ÛŒÙ† Ø¯Ø§Ø¯Ù‡</button>
      <button class="btn-ghost" onclick="clearAllData()">ğŸ—‘ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú©Ù„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</button>
      <div style="flex:1"></div>
      <div style="min-width:200px">
        <label>Ú©Ù„ÛŒØ¯ RSI AlphaVantage</label>
        <div class="input-inline">
          <input id="rsiApiKey" type="text" placeholder="YOUR_KEY"><button class="btn-ghost" onclick="saveRSIKey()">Ø°Ø®ÛŒØ±Ù‡</button>
        </div>
      </div>
    </div>
    <div class="hr"></div>
    <div class="result" id="goldResult">ÙˆØ¶Ø¹ÛŒØª: Ø¢Ù…Ø§Ø¯Ù‡</div>
  </div>

  <!-- ØªÙ†Ø¸ÛŒÙ…Ø§Øª AutoFetch -->
  <div class="card">
    <h3 style="margin:0 0 8px;color:var(--accent)">AutoFetch & Ù‡Ø´Ø¯Ø§Ø±</h3>
    <div class="grid">
      <div>
        <label>ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø± Ø¨Ø§Ø²Ù‡ Û±Û¸:Û°Û°â€“Û²Û²:Û°Û°</label>
        <input id="maxRequests" type="number" value="100">
      </div>
      <div>
        <label>Ø§Ø¬Ø±Ø§ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±</label>
        <div style="display:flex;gap:8px">
          <button onclick="startAutoFetch()">â–¶ Ø´Ø±ÙˆØ¹</button>
          <button class="btn-ghost" onclick="stopAutoFetch()">â–  ØªÙˆÙ‚Ù</button>
        </div>
      </div>
      <div><label>Ø­Ø¯ Ù¾Ø§ÛŒÛŒÙ† Ù‡Ø´Ø¯Ø§Ø± (ØªÙˆÙ…Ø§Ù†)</label><input id="lowLimit" type="number" placeholder="Ù…Ø«Ø§Ù„: 12000000"></div>
      <div><label>Ø­Ø¯ Ø¨Ø§Ù„Ø§ Ù‡Ø´Ø¯Ø§Ø± (ØªÙˆÙ…Ø§Ù†)</label><input id="highLimit" type="number" placeholder="Ù…Ø«Ø§Ù„: 18000000"></div>
    </div>
    <div class="hr"></div>
    <div class="counter-box">
      <div>Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡: <strong id="doneCount">0</strong></div>
      <div>Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: <strong id="leftCount">0</strong></div>
      <div>Ø¨Ø¹Ø¯ÛŒ Ø¯Ø±: <strong id="nextIn">â€”</strong></div>
    </div>
  </div>

  <!-- Ù†Ù…ÙˆØ¯Ø§Ø± Ùˆ Ø³ÛŒÚ¯Ù†Ø§Ù„ -->
  <div class="card">
    <h3 style="margin:0 0 8px;color:var(--accent)">Ù†Ù…ÙˆØ¯Ø§Ø± Ùˆ Ø³ÛŒÚ¯Ù†Ø§Ù„</h3>
    <button onclick="signal()">ğŸ” Ø¨Ø±Ø±Ø³ÛŒ Ø³ÛŒÚ¯Ù†Ø§Ù„</button>
    <button id="notifyBtn" class="toggle off" onclick="toggleNotification()">ğŸ”” Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø®Ø§Ù…ÙˆØ´</button>
    <div class="canvas-wrap"><canvas id="trendChart" style="width:100%;height:360px"></canvas></div>
    <div class="legend">
      <div class="dot entry-dot"></div><div class="small-muted">ÙˆØ±ÙˆØ¯</div>
      <div class="dot exit-dot"></div><div class="small-muted">Ø®Ø±ÙˆØ¬</div>
    </div>
    <div class="hr"></div>
    <div class="signals-list" id="signalsList"></div>
  </div>

</div>

<script>
/* -------------------------
  ØªÙ†Ø¸ÛŒÙ… Ø§ÙˆÙ„ÛŒÙ‡
--------------------------*/
const BRS_URL="https://brsapi.ir/Api/Market/Gold_Currency.php?key=BBzNUXWfiBpUmeXusfw4mkbjXuXjj9nU";
let historyData=JSON.parse(localStorage.getItem('goldHistory'))||[];
let signals=JSON.parse(localStorage.getItem('signals'))||[];
let apiCounter=parseInt(localStorage.getItem('apiCounter'))||0;
let notifyActive=localStorage.getItem('notifyActive')==='1';
let autoState={running:false,timerId:null,nextAt:null,done:0,left:0};
if(notifyActive)document.getElementById('notifyBtn').className='toggle on';
document.getElementById('apiCounter')?.innerText=apiCounter;

/* -------------------------
  Chart.js setup
--------------------------*/
const ctx=document.getElementById('trendChart').getContext('2d');
const trendChart=new Chart(ctx,{type:'line',data:{labels:[],datasets:[
{label:'Ø­Ø¨Ø§Ø¨',data:[],borderColor:'#60a5fa',backgroundColor:'rgba(96,165,250,0.15)',fill:true,pointRadius:5,pointBackgroundColor:[]},
{label:'RSI',data:[],borderColor:'#f472b6',fill:false,yAxisID:'rsiAxis',pointRadius:2}
]},options:{responsive:true,interaction:{mode:'index',intersect:false},scales:{y:{position:'left',title:{display:true,text:'ØªÙˆÙ…Ø§Ù†'}},rsiAxis:{position:'right',min:0,max:100,title:{display:true,text:'RSI'}}},plugins:{legend:{labels:{boxWidth:12}}}}});

/* -------------------------
  Ú©Ù…Ú©ÛŒ
--------------------------*/
function saveHistory(){ localStorage.setItem('goldHistory',JSON.stringify(historyData)); }
function saveSignals(){ localStorage.setItem('signals',JSON.stringify(signals)); }
function setApiCounter(n){ apiCounter=n; localStorage.setItem('apiCounter',n); }
function playSound(){ try{ new Audio('https://www.soundjay.com/button/sounds/beep-07.mp3').play(); }catch(e){} }
function notify(msg){ if(!notifyActive)return; if(Notification.permission==='granted') new Notification('Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø·Ù„Ø§ÛŒ Û±Û¸', {body:msg}); else if(Notification.permission!=='denied') Notification.requestPermission().then(p=>{if(p==='granted')new Notification('Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø·Ù„Ø§ÛŒ Û±Û¸',{body:msg});}); }

function renderSignals(){ const el=document.getElementById('signalsList'); el.innerHTML=''; if(signals.length===0){ el.innerHTML='<div class="small-muted">Ù‡Ù†ÙˆØ² Ø³ÛŒÚ¯Ù†Ø§Ù„ÛŒ ØµØ§Ø¯Ø± Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</div>'; return;} signals.forEach(s=>{const div=document.createElement('div');div.className='signal-item';div.innerHTML=`<strong>[${s.type}]</strong> ${s.text}`;el.appendChild(div);}); }
function updateChart(){ trendChart.data.labels=historyData.map((_,i)=>i+1); trendChart.data.datasets[0].data=historyData.map(d=>d.bubble); trendChart.data.datasets[0].pointBackgroundColor=historyData.map(d=>d.signal==='ÙˆØ±ÙˆØ¯'?'#16a34a':d.signal==='Ø®Ø±ÙˆØ¬'?'#ef4444':'#60a5fa'); trendChart.data.datasets[1].data=historyData.map(d=>d.rsi); trendChart.update(); }
function pushSignal(type,text){ signals.unshift({type,text}); if(signals.length>50)signals=signals.slice(0,50); saveSignals(); renderSignals(); }

/* -------------------------
  RSI API
--------------------------*/
async function fetchRSIFromAPI(symbol='XAUUSD',interval='daily',period=14){
  const key=localStorage.getItem('rsiApiKey'); if(!key) return null;
  try{ const res=await fetch(`https://www.alphavantage.co/query?function=RSI&symbol=${symbol}&interval=${interval}&time_period=${period}&series_type=close&apikey=${key}`);
      const j=await res.json(); if(j['Technical Analysis: RSI']){const lastKey=Object.keys(j['Technical Analysis: RSI'])[0]; return parseFloat(j['Technical Analysis: RSI'][lastKey]['RSI']);} return null;
  }catch(e){ console.error(e); return null;}
}

/* -------------------------
  Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ùˆ RSI Ù…Ø­Ù„ÛŒ
--------------------------*/
function computeAverage(data,newPrice){ const recent=data.slice(-5).map(d=>d.price); recent.push(newPrice); return recent.reduce((a,b)=>a+b,0)/recent.length; }
function computeRSI(prices,period=14){ if(prices.length<period+1)return 50; let gains=0,losses=0; for(let i=prices.length-period;i<prices.length;i++){const diff=prices[i]-prices[i-1]; if(diff>0) gains+=diff; else losses+=Math.abs(diff);} if(losses===0) return 100; const rs=gains/losses; return 100-(100/(1+rs)); }

/* -------------------------
  Ø°Ø®ÛŒØ±Ù‡ Ú©Ù„ÛŒØ¯ RSI
--------------------------*/
function saveRSIKey(){ const k=document.getElementById('rsiApiKey').value.trim(); if(k){ localStorage.setItem('rsiApiKey',k); alert('Ú©Ù„ÛŒØ¯ RSI Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');} else alert('Ú©Ù„ÛŒØ¯ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª'); }

/* -------------------------
  Ø­Ø°Ù Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
--------------------------*/
function clearLast(){ if(historyData.length>0){ historyData.pop(); saveHistory(); updateChart(); renderSignals(); document.getElementById('goldResult').innerText='Ø¢Ø®Ø±ÛŒÙ† Ø¯Ø§Ø¯Ù‡ Ù¾Ø§Ú© Ø´Ø¯'; } }
function clearAllData(){ if(confirm('Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú©Ù„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ØŸ')){ historyData=[]; signals=[]; saveHistory(); saveSignals(); updateChart(); renderSignals(); document.getElementById('goldResult').innerText='Ú©Ù„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø´Ø¯';} }

/* -------------------------
  Ø¯Ø±ÛŒØ§ÙØª Ù‡Ù…Ø²Ù…Ø§Ù† Ø¯Ùˆ API
--------------------------*/
async function fetchFromAPI(){
  try{
    const res=await fetch(BRS_URL);
    const j=await res.json();
    const goldObj=Array.isArray(j.gold)?j.gold.find(i=>i.symbol==='IR_GOLD_18K'):null;
    const usdObj=Array.isArray(j.currency)?j.currency.find(i=>i.symbol==='USD'):null;
    const xauObj=Array.isArray(j.gold)?j.gold.find(i=>i.symbol==='XAUUSD'):null;
    const gold=goldObj?parseFloat(goldObj.price):null;
    const usd=usdObj?parseFloat(usdObj.price):null;
    const ounce=xauObj?parseFloat(xauObj.price):null;
    document.getElementById('gold18').value=gold;
    document.getElementById('usd').value=usd;
    document.getElementById('ounce').value=ounce;
    await addData(true);
    setApiCounter(apiCounter+1);
  }catch(e){ console.error(e); document.getElementById('goldResult').innerText='âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª API'; }
}

/* -------------------------
  Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø§Ø¯Ù‡ Ùˆ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø­Ø¨Ø§Ø¨ Ùˆ RSI
--------------------------*/
async function addData(fromAPI=false){
  const gold=parseFloat(document.getElementById('gold18').value);
  const usd=parseFloat(document.getElementById('usd').value);
  const ounce=parseFloat(document.getElementById('ounce').value);
  const fee=parseFloat(document.getElementById('fee').value)||0;
  if(!gold || !usd || !ounce){ document.getElementById('goldResult').innerText='Ù„Ø·ÙØ§Ù‹ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'; return;}
  const avg=computeAverage(historyData,gold);
  const bubble=gold-avg;
  const prices=historyData.map(d=>d.price); prices.push(gold);
  let rsi=await fetchRSIFromAPI(); if(rsi===null) rsi=computeRSI(prices);
  let signalType='',signalText='';
  const low=parseFloat(document.getElementById('lowLimit').value||-Infinity);
  const high=parseFloat(document.getElementById('highLimit').value||Infinity);
  if(bubble<=low || rsi<=30){ signalType='ÙˆØ±ÙˆØ¯'; signalText=`Ø®Ø±ÛŒØ¯: Ø­Ø¨Ø§Ø¨=${bubble.toFixed(0)}, RSI=${rsi.toFixed(1)}`; playSound(); notify(signalText);}
  else if(bubble>=high || rsi>=70){ signalType='Ø®Ø±ÙˆØ¬'; signalText=`ÙØ±ÙˆØ´: Ø­Ø¨Ø§Ø¨=${bubble.toFixed(0)}, RSI=${rsi.toFixed(1)}`; playSound(); notify(signalText);}
  historyData.push({price:gold,usd,ounce,fee,avg,bubble,rsi,signal:signalType});
  saveHistory(); updateChart(); renderSignals();
  document.getElementById('goldResult').innerText=`Ø¢Ø®Ø±ÛŒÙ† Ù‚ÛŒÙ…Øª: ${gold} ØªÙˆÙ…Ø§Ù† | Ø­Ø¨Ø§Ø¨: ${
