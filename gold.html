<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ù†ÙˆØ³Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø±</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{font-family:sans-serif;background:linear-gradient(135deg,#1b1b1b,#3a3a3a);color:#fff;margin:0;padding:10px}
.container{max-width:750px;margin:auto;padding:10px}
h1,h2{text-align:center;margin-bottom:10px;color:#ffd369;font-size:1.5rem}
.card{background:#2b2b2b;border-radius:15px;padding:15px;margin-bottom:15px;box-shadow:0 0 15px rgba(255,211,105,0.2)}
label{display:block;margin:6px 0 3px;font-size:0.9rem}
input{width:100%;padding:8px;border-radius:8px;border:none;margin-bottom:8px;font-size:0.9rem}
button{width:100%;padding:10px;background:#ffd369;border:none;border-radius:10px;color:#000;font-size:0.95rem;cursor:pointer;margin-top:5px;transition:0.3s}
button:hover{background:#ffb954}
.result{background:#1f1f1f;padding:10px;border-radius:10px;margin-top:10px;font-size:0.9rem;line-height:1.5;border:1px solid #ffd36944;transition:0.4s}
.tip{color:#9bd7ff;font-size:0.85rem;line-height:1.5;margin-bottom:5px}
canvas{border-radius:10px}
.toggle-btn{margin-top:5px;padding:5px 10px;border-radius:8px;background:#4d7bff;color:#fff;border:none;cursor:pointer;transition:0.3s;font-size:0.85rem;}
.toggle-btn.active{background:#28a745}
.toggle-btn.inactive{background:#dc3545}
</style>
</head>
<body>
<div class="container">
<h1>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ù†ÙˆØ³Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø±</h1>

<div class="card">
<h2>ØªÙˆØ¶ÛŒØ­Ø§Øª Ø§Ø³ØªÙØ§Ø¯Ù‡</h2>
<p class="tip">
1. Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø² API Ø¯Ø±ÛŒØ§ÙØª Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ Ùˆ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø®ÙˆØ¯Ú©Ø§Ø± Ø­Ø¨Ø§Ø¨ØŒ Ø­Ù…Ø§ÛŒØªØŒ Ù…Ù‚Ø§ÙˆÙ…Øª Ùˆ RSI Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯.<br>
2. Ø³ÛŒÚ¯Ù†Ø§Ù„ ÙˆØ±ÙˆØ¯: Ø­Ø¨Ø§Ø¨ Ù…Ù†ÙÛŒ + Ù†Ø²Ø¯ÛŒÚ© Ø­Ù…Ø§ÛŒØª<br>
3. Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø®Ø±ÙˆØ¬: Ø­Ø¨Ø§Ø¨ Ù…Ø«Ø¨Øª + Ù†Ø²Ø¯ÛŒÚ© Ù…Ù‚Ø§ÙˆÙ…Øª<br>
4. Ø¨Ù‡ØªØ±ÛŒÙ† Ø³Ø§Ø¹Ø§Øª Ù†ÙˆØ³Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ: <strong>10:30 ØªØ§ 12:00 Ø¸Ù‡Ø± Ùˆ 18:00 ØªØ§ 22:00 Ø´Ø¨</strong><br>
5. Ù†Ù…ÙˆØ¯Ø§Ø± Ø­Ø¨Ø§Ø¨ØŒ Ø­Ù…Ø§ÛŒØª/Ù…Ù‚Ø§ÙˆÙ…Øª Ùˆ RSI Ø´Ø¨ÛŒÙ‡ TradingView Ø§Ø³Øª.
</p>
</div>

<div class="card">
<h2>Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡ Ø§Ø² API</h2>
<button onclick="fetchFromAPI()">ğŸ“¡ Ø¯Ø±ÛŒØ§ÙØª Ù‚ÛŒÙ…Øª Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ø§Ø² API</button>
<p class="tip">ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª API Ø§Ù…Ø±ÙˆØ²: <span id="apiCounter">0</span>/100</p>
<label>Ø§Ø¬Ø±Øª + Ù…Ø§Ù„ÛŒØ§Øª + Ø³ÙˆØ¯ (Ø¯Ø±ØµØ¯) - Ø§Ø®ØªÛŒØ§Ø±ÛŒ:</label>
<input type="number" id="fee">
<div id="goldResult" class="result"></div>
</div>

<div class="card">
<h2>Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒØŒ Ù†Ù…ÙˆØ¯Ø§Ø± Ø­Ø¨Ø§Ø¨ Ùˆ RSI</h2>
<button onclick="signal()">Ø¯Ø±ÛŒØ§ÙØª Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ</button>
<div id="signalResult" class="result"></div>
<canvas id="trendChart" style="margin-top:10px;width:100%;height:300px;"></canvas>
<button class="toggle-btn inactive" id="notifyBtn" onclick="toggleNotification()">ğŸ”” Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø®Ø§Ù…ÙˆØ´</button>
</div>
</div>

<script>
// Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ API
let apiCounter = parseInt(localStorage.getItem('apiCounter')) || 0;
document.getElementById('apiCounter').innerText = apiCounter;

// ÙˆØ¶Ø¹ÛŒØª Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†
let notifyActive = false;

// Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
let historyData = JSON.parse(localStorage.getItem('goldHistory')) || [];

// Ù†Ù…ÙˆØ¯Ø§Ø±
const ctx = document.getElementById('trendChart').getContext('2d');
let trendChart = new Chart(ctx,{
    type:'line',
    data:{
        labels:[],
        datasets:[
            {label:'Ø­Ø¨Ø§Ø¨ Ù‚ÛŒÙ…Øª',data:[],borderColor:'#4d7bff',backgroundColor:'rgba(77,123,255,0.2)',tension:0.3,fill:true,yAxisID:'y'},
            {label:'Ø­Ù…Ø§ÛŒØª',data:[],borderColor:'green',borderDash:[5,5],fill:false,yAxisID:'y'},
            {label:'Ù…Ù‚Ø§ÙˆÙ…Øª',data:[],borderColor:'red',borderDash:[5,5],fill:false,yAxisID:'y'},
            {label:'RSI',data:[],borderColor:'#ff69b4',tension:0.3,fill:false,yAxisID:'rsi'}
        ]
    },
    options:{
        responsive:true,
        scales:{
            y:{beginAtZero:false,position:'left',title:{display:true,text:'ØªÙˆÙ…Ø§Ù†'}},
            rsi:{beginAtZero:true,max:100,position:'right',title:{display:true,text:'RSI'}}
        }
    }
});

// Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†
function toggleNotification(){
    notifyActive=!notifyActive;
    const btn=document.getElementById('notifyBtn');
    if(notifyActive){btn.className='toggle-btn active';btn.innerText='ğŸ”” Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø±ÙˆØ´Ù†';}
    else{btn.className='toggle-btn inactive';btn.innerText='ğŸ”” Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø®Ø§Ù…ÙˆØ´';}
}

// ØµØ¯Ø§
function playSound(){
    const audio=new Audio('https://www.soundjay.com/button/beep-07.wav');
    audio.play();
}

// Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ù…Ø±ÙˆØ±Ú¯Ø±
function notify(message){
    if(!notifyActive) return;
    if(Notification.permission==="granted"){
        new Notification("Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø±",{body:message});
    } else if(Notification.permission!=="denied"){
        Notification.requestPermission().then(p=>{
            if(p==="granted") new Notification("Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø±",{body:message});
        });
    }
}

// Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡ Ø§Ø² API Ùˆ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±ÙˆÙ†Ø¯ Ø®ÙˆØ¯Ú©Ø§Ø±
async function fetchFromAPI(){
    if(apiCounter>=100){
        document.getElementById('goldResult').innerHTML="âš  Ø³Ù‚Ù 100 Ø¯Ø±Ø®ÙˆØ§Ø³Øª API Ø§Ù…Ø±ÙˆØ² Ø±Ø³ÛŒØ¯!";
        return;
    }
    const url="https://brsapi.ir/Api/Market/Gold_Currency.php?key=BBzNUXWfiBpUmeXusfw4mkbjXuXjj9nU";
    try{
        let res=await fetch(url);
        let json=await res.json();
        const gold18=json.gold.find(item=>item.symbol==="IR_GOLD_18K").price;
        const ounce=json.gold.find(item=>item.symbol==="XAUUSD").price;
        const usd=json.currency.find(item=>item.symbol==="USD").price;

        // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±ÙˆÙ†Ø¯ Ø®ÙˆØ¯Ú©Ø§Ø± Ù…Ø«Ø¨Øª/Ù…Ù†ÙÛŒ
        let lastUSD=historyData.length>0?historyData[historyData.length-1].usd:usd;
        let lastOunce=historyData.length>0?historyData[historyData.length-1].ounce:ounce;
        const usdTrend=usd>lastUSD?'Ù…Ø«Ø¨Øª':'Ù…Ù†ÙÛŒ';
        const ounceTrend=ounce>lastOunce?'Ù…Ø«Ø¨Øª':'Ù…Ù†ÙÛŒ';

        // Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø§Ø¯Ù‡ Ùˆ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø­Ø¨Ø§Ø¨/RSI
        const fee=parseFloat(document.getElementById('fee').value)||0;
        const finalPrice=((ounce*usd)/31.1035)*(1+fee/100);
        const averagePrice=computeAverage(historyData,finalPrice);
        const bubble=finalPrice-averagePrice;
        const rsi=computeRSI([...historyData.map(d=>d.price),finalPrice],14);
        historyData.push({price:finalPrice,avg:averagePrice,bubble:bubble,rsi:rsi,usd:usd,ounce:ounce,usdTrend:usdTrend,ounceTrend:ounceTrend});
        localStorage.setItem('goldHistory',JSON.stringify(historyData));
        updateChart();

        apiCounter++;
        localStorage.setItem('apiCounter',apiCounter);
        document.getElementById('apiCounter').innerText=apiCounter;
        document.getElementById('goldResult').innerHTML=`ğŸ“¡ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ Ø§Ø² API Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯. Ø­Ø¨Ø§Ø¨: ${bubble.toLocaleString()} ØªÙˆÙ…Ø§Ù† | RSI: ${rsi.toFixed(2)} | Ø±ÙˆÙ†Ø¯ Ø¯Ù„Ø§Ø±: ${usdTrend} | Ø§Ù†Ø³: ${ounceTrend}`;
    }catch(err){console.error(err);document.getElementById('goldResult').innerHTML="âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡ Ø§Ø² API";}
}

// Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ûµ Ø±ÙˆØ² Ø§Ø®ÛŒØ±
function computeAverage(data,newPrice){
    const days=5;
    const recent=data.slice(-days).map(d=>d.price);
    recent.push(newPrice);
    const sum=recent.reduce((a,b)=>a+b,0);
    return sum/recent.length;
}

// Ù…Ø­Ø§Ø³Ø¨Ù‡ RSI
function computeRSI(prices,period){
    if(prices.length<period+1) return 50;
    let gains=0,losses=0;
    for(let i=1;i<=period;i++){
        const diff=prices[prices.length-i]-prices[prices.length-i-1];
        if(diff>0) gains+=diff;
        else losses-=diff;
    }
    if(losses===0) return 100;
    const rs=gains/losses;
    return 100-(100/(1+rs));
}

// Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ
function signal(){
    if(historyData.length===0){document.getElementById('signalResult').innerHTML='Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡';return;}
    const last=historyData[historyData.length-1];
    let support=last.avg*0.985;
    let resistance=last.avg*1.015;
    let result='';
    if(last.bubble<-20000 && last.price<=support){
        result=`ğŸŸ¢ Ø³ÛŒÚ¯Ù†Ø§Ù„ ÙˆØ±ÙˆØ¯ Ù‚ÙˆÛŒ â€” Ù‚ÛŒÙ…Øª Ù†Ø²Ø¯ÛŒÚ© Ø­Ù…Ø§ÛŒØª: ${support.toLocaleString()}`;
        playSound(); notify(result);
    } else if(last.bubble>20000 && last.price>=resistance){
        result=`ğŸ”´ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø®Ø±ÙˆØ¬ Ù‚ÙˆÛŒ â€” Ù‚ÛŒÙ…Øª Ù†Ø²Ø¯ÛŒÚ© Ù…Ù‚Ø§ÙˆÙ…Øª: ${resistance.toLocaleString()}`;
        playSound(); notify(result);
    } else{
        const usdTrend=last.usdTrend;
        const ounceTrend=last.ounceTrend;
        if(usdTrend==='Ù…Ù†ÙÛŒ' && ounceTrend==='Ù…Ù†ÙÛŒ') result='ğŸŸ¢ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø®Ø±ÛŒØ¯ â€” Ø¨Ù‡ØªØ±ÛŒÙ† Ø²Ù…Ø§Ù† ÙˆØ±ÙˆØ¯';
        else if(usdTrend==='Ù…Ø«Ø¨Øª' && ounceTrend==='Ù…Ø«Ø¨Øª') result='ğŸ”´ Ø³ÛŒÚ¯Ù†Ø§Ù„ ÙØ±ÙˆØ´ â€” Ø¨Ø§Ø²Ø§Ø± Ø¯Ø§Øº Ø§Ø³Øª';
        else result=`âš– Ø¨Ø§Ø²Ø§Ø± Ø®Ù†Ø«ÛŒ â€” Ø­Ø¨Ø§Ø¨: ${last.bubble.toLocaleString()} ØªÙˆÙ…Ø§Ù† | RSI: ${last.rsi.toFixed(2)}`;
    }
    document.getElementById('signalResult').innerHTML=result;
}

// Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ù…ÙˆØ¯Ø§Ø±
function updateChart(){
    trendChart.data.labels=historyData.map((_,i)=>i+1);
    trendChart.data.datasets[0].data=historyData.map(d=>d.bubble);
    trendChart.data.datasets[1].data=historyData.map(d=>d.avg*0.985);
    trendChart.data.datasets[2].data=historyData.map(d=>d.avg*1.015);
    trendChart.data.datasets[3].data=historyData.map(d=>d.rsi);
    trendChart.update();
}

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ù…ÙˆØ¯Ø§Ø± Ø§Ø² LocalStorage
updateChart();
</script>
</body>
</html>
