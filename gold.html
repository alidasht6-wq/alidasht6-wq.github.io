<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø± Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{--bg1:#0f1720;--card:#1f2937;--accent:#ffd369;--muted:#9bd7ff;}
body{margin:0;padding:14px;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:linear-gradient(180deg,var(--bg1),#0b1116);color:#fff}
.container{max-width:980px;margin:0 auto}
.card{background:var(--card);border-radius:12px;padding:14px;margin-bottom:12px;box-shadow:0 6px 20px rgba(0,0,0,0.6);}
button{padding:8px 12px;border-radius:10px;border:none;background:var(--accent);color:#000;font-weight:600;cursor:pointer}
.toggle{padding:6px 10px;border-radius:10px;cursor:pointer;font-weight:700}
.toggle.on{background:#16a34a;color:#fff}
.toggle.off{background:#ef4444;color:#fff}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
label{display:block;margin-bottom:4px;color:#cbd5e1}
input{width:100%;padding:6px;border-radius:6px;border:none;background:#0b1220;color:#fff}
.result{background:#071018;padding:10px;border-radius:8px;margin-top:8px;border:1px solid rgba(255,255,255,0.03)}
</style>
</head>
<body>
<div class="container">
  <h2 style="color:var(--accent)">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù†ÙˆØ³Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø±</h2>

  <!-- ÙˆØ±ÙˆØ¯ÛŒ Ùˆ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ -->
  <div class="card">
    <h3>ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§</h3>
    <div class="grid">
      <div><label>Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø± (ØªÙˆÙ…Ø§Ù†)</label><input id="gold18" type="number" placeholder="Ù…Ø«Ø§Ù„: 12679000"></div>
      <div><label>Ø¯Ù„Ø§Ø± (ØªÙˆÙ…Ø§Ù†)</label><input id="usd" type="number" placeholder="Ù…Ø«Ø§Ù„: 125000"></div>
      <div><label>Ø§Ù†Ø³ Ø¬Ù‡Ø§Ù†ÛŒ (Ø¯Ù„Ø§Ø±)</label><input id="ounce" type="number" placeholder="Ù…Ø«Ø§Ù„: 1960.12"></div>
      <div><label>Ú©Ù„ÛŒØ¯ RSI (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label><input id="rsiApiKey" type="text" placeholder="ALPHAVANTAGE_KEY"></div>
    </div>
    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
      <button onclick="addData()">Ø«Ø¨Øª Ø¯Ø³ØªÛŒ</button>
      <button onclick="fetchFromAPI()">Ø¯Ø±ÛŒØ§ÙØª Ø¢Ø®Ø±ÛŒÙ† API</button>
      <button onclick="clearLastData()">âŒ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø¢Ø®Ø±ÛŒÙ† Ø¯Ø§Ø¯Ù‡</button>
      <button onclick="clearAllData()">ğŸ—‘ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</button>
      <button id="notifyBtn" class="toggle off" onclick="toggleNotification()">ğŸ”” Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø®Ø§Ù…ÙˆØ´</button>
    </div>
    <div class="result" id="goldResult">ÙˆØ¶Ø¹ÛŒØª: Ø¢Ù…Ø§Ø¯Ù‡</div>
  </div>

  <!-- ØªÙ†Ø¸ÛŒÙ…Ø§Øª AutoFetch -->
  <div class="card">
    <h3>ØªÙ†Ø¸ÛŒÙ…Ø§Øª AutoFetch</h3>
    <div class="grid">
      <div><label>ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø±ÙˆØ²Ø§Ù†Ù‡</label><input id="maxRequests" type="number" value="100" min="1" max="1500"></div>
      <div>
        <label>Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ</label>
        <select id="timeRange">
          <option value="free">Ø²Ù…Ø§Ù† Ø¢Ø²Ø§Ø¯</option>
          <option value="morning">10:30 - 12:00</option>
          <option value="evening">18:00 - 22:00</option>
        </select>
      </div>
    </div>
    <div style="margin-top:8px;display:flex;gap:8px;">
      <button onclick="startAutoFetch()">â–¶ Ø´Ø±ÙˆØ¹</button>
      <button onclick="stopAutoFetch()">â–  ØªÙˆÙ‚Ù</button>
    </div>
    <div class="result">
      Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡: <span id="doneCount">0</span> | Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: <span id="leftCount">0</span> | Ø¨Ø¹Ø¯ÛŒ Ø¯Ø±: <span id="nextIn">â€”</span> Ø«Ø§Ù†ÛŒÙ‡
    </div>
  </div>

  <!-- Ù†Ù…ÙˆØ¯Ø§Ø± -->
  <div class="card">
    <h3>Ù†Ù…ÙˆØ¯Ø§Ø± Ø­Ø¨Ø§Ø¨ Ùˆ RSI</h3>
    <canvas id="trendChart" style="width:100%;height:300px"></canvas>
  </div>
</div>

<script>
let historyData = JSON.parse(localStorage.getItem('goldHistory')||'[]');
let apiCounter = parseInt(localStorage.getItem('apiCounter')||'0');
let notifyActive = (localStorage.getItem('notifyActive')==='1');
let autoState={running:false,timerId:null,countdownId:null,nextAt:null,done:0,left:0};

// Chart.js
const ctx = document.getElementById('trendChart').getContext('2d');
const trendChart = new Chart(ctx,{type:'line',data:{labels:[],datasets:[
  {label:'Ø­Ø¨Ø§Ø¨',data:[],borderColor:'#60a5fa',fill:false,pointRadius:5,pointBackgroundColor:[]},
  {label:'RSI',data:[],borderColor:'#f472b6',fill:false,pointRadius:2,yAxisID:'rsiAxis'}
]},options:{responsive:true,interaction:{mode:'index',intersect:false},scales:{y:{position:'left',title:{display:true,text:'ØªÙˆÙ…Ø§Ù†'}},rsiAxis:{position:'right',min:0,max:100,title:{display:true,text:'RSI'}}}}});

// -----------------------
// ØªÙˆØ§Ø¨Ø¹ Ù¾Ø§ÛŒÙ‡
// -----------------------
function saveHistory(){ localStorage.setItem('goldHistory',JSON.stringify(historyData)); }
function setApiCounter(n){ apiCounter=n; localStorage.setItem('apiCounter',String(apiCounter)); document.getElementById('doneCount').innerText=apiCounter; }

function updateChart(){
  trendChart.data.labels = historyData.map((_,i)=>i+1);
  trendChart.data.datasets[0].data = historyData.map(d=>d.bubble||0);
  trendChart.data.datasets[0].pointBackgroundColor = historyData.map(d=>{
    if(d.signal==='entry') return '#16a34a';
    if(d.signal==='exit') return '#ef4444';
    return '#60a5fa';
  });
  trendChart.data.datasets[1].data = historyData.map(d=>d.rsi||50);
  trendChart.update();
}

// -----------------------
// Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
// -----------------------
function addData(){
  const gold=parseFloat(document.getElementById('gold18').value);
  const usd=parseFloat(document.getElementById('usd').value);
  const ounce=parseFloat(document.getElementById('ounce').value);
  if(isNaN(gold)||isNaN(usd)||isNaN(ounce)){ alert('Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
  const fee = parseFloat(document.getElementById('fee')?.value||0);
  const finalPrice = gold || ((usd*ounce/31.1035)*(1+fee/100));
  const avg = historyData.slice(-5).reduce((a,d)=>a+d.price,0)/Math.max(1,Math.min(5,historyData.length));
  const bubble = finalPrice - avg;
  const rsi = 50; // fallback Ø³Ø§Ø¯Ù‡
  historyData.push({price:finalPrice,usd,ounce,bubble,rsi,date:new Date().toISOString()});
  saveHistory(); updateChart();
  document.getElementById('goldResult').innerText=`Ø«Ø¨Øª Ø´Ø¯: ${finalPrice.toLocaleString()}`;
}

async function fetchFromAPI(){
  try{
    const res=await fetch("https://brsapi.ir/Api/Market/Gold_Currency.php?key=BBzNUXWfiBpUmeXusfw4mkbjXuXjj9nU");
    const j=await res.json();
    const gold=parseFloat(j.gold.find(i=>i.symbol==='IR_GOLD_18K').price);
    const usd=parseFloat(j.currency.find(i=>i.symbol==='USD').price);
    const ounce=parseFloat(j.gold.find(i=>i.symbol==='XAUUSD').price);
    const rsi = 50; // fallback Ø³Ø§Ø¯Ù‡ ÛŒØ§ API
    historyData.push({price:gold,usd,ounce,bubble:gold-0,rsi,date:new Date().toISOString()});
    apiCounter++; setApiCounter(apiCounter);
    saveHistory(); updateChart();
    document.getElementById('goldResult').innerText=`Ø¢Ø®Ø±ÛŒÙ† API Ø«Ø¨Øª Ø´Ø¯: ${gold}`;
  }catch(e){ alert('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª API'); console.error(e); }
}

function clearLastData(){ if(historyData.length>0) historyData.pop(); saveHistory(); updateChart(); }
function clearAllData(){ historyData=[]; saveHistory(); updateChart(); }

function toggleNotification(){
  notifyActive=!notifyActive;
  localStorage.setItem('notifyActive',notifyActive?'1':'0');
  const btn=document.getElementById('notifyBtn');
  btn.className=notifyActive?'toggle on':'toggle off';
  btn.innerText=notifyActive?'ğŸ”” Ø±ÙˆØ´Ù†':'ğŸ”” Ø®Ø§Ù…ÙˆØ´';
}

// -----------------------
// AutoFetch Ø³Ø§Ø¯Ù‡ (Ø¨Ø±Ø§ÛŒ Ù…Ø«Ø§Ù„)
// -----------------------
function startAutoFetch(){
  if(autoState.running){ alert('AutoFetch Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§Ø³Øª'); return; }
  const maxReq = parseInt(document.getElementById('maxRequests').value)||100;
  autoState.running=true; autoState.done=0; autoState.left=maxReq-apiCounter;
  document.getElementById('doneCount').innerText=autoState.done;
  document.getElementById('leftCount').innerText=autoState.left;

  let intervalSec=Math.floor(240*60/maxReq); // 4 Ø³Ø§Ø¹Øª = 240 Ø¯Ù‚ÛŒÙ‚Ù‡
  autoState.timerId=setInterval(async()=>{
    await fetchFromAPI();
    autoState.done++; autoState.left=Math.max(0,maxReq-apiCounter);
    document.getElementById('doneCount').innerText=autoState.done;
    document.getElementById('leftCount').innerText=autoState.left;
  },intervalSec*1000);
}

function stopAutoFetch(){
  if(autoState.timerId) clearInterval(autoState.timerId);
  autoState={running:false,timerId:null,countdownId:null,nextAt:null,done:0,left:0};
  document.getElementById('nextIn').innerText='â€”';
  document.getElementById('doneCount').innerText='0';
  document.getElementById('leftCount').innerText='0';
  document.getElementById('goldResult').innerText='AutoFetch Ù…ØªÙˆÙ‚Ù Ø´Ø¯';
}

updateChart();
</script>
</body>
</html>
