<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>داشبورد نهایی طلای ۱۸ عیار — نمونه تست</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{margin:0;padding:14px;font-family:system-ui,sans-serif;background:#0f1720;color:#fff}
.container{max-width:980px;margin:0 auto}
.card{background:#1f2937;border-radius:12px;padding:14px;margin-bottom:12px}
.title{font-size:1.25rem;color:#ffd369;font-weight:700}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
@media(max-width:740px){.grid{grid-template-columns:1fr}}
input,button{padding:8px;border-radius:8px;border:none}
button{background:#ffd369;color:#000;cursor:pointer}
.result{background:#071018;padding:10px;border-radius:8px;margin-top:8px}
.kv{display:flex;justify-content:space-between;padding:6px 0;font-size:0.95rem}
.canvas-wrap{background:#06121a;padding:8px;border-radius:10px;margin-top:8px}
.legend{display:flex;gap:8px;align-items:center;margin-top:8px}
.dot{width:12px;height:12px;border-radius:3px;display:inline-block}
.entry-dot{background:#16a34a}
.exit-dot{background:#ef4444}
.signals-list{max-height:160px;overflow:auto;margin-top:8px;border-radius:8px;padding:8px;background:#0b1116}
.signal-item{padding:6px;border-bottom:1px dashed rgba(255,255,255,0.03)}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <div class="title">داشبورد نمونه طلای ۱۸ عیار</div>
  </div>

  <div class="card">
    <h3>ورودی دستی</h3>
    <div class="grid">
      <div>
        <label>قیمت طلای ۱۸ عیار (تومان)</label>
        <input id="gold18" type="number" placeholder="12679000">
      </div>
      <div>
        <label>اجرت + مالیات + سود (%)</label>
        <input id="fee" type="number" placeholder="1.2">
      </div>
    </div>
    <button onclick="addData()">ثبت داده</button>
    <div class="result" id="goldResult">وضعیت: آماده</div>
  </div>

  <div class="card">
    <h3>نمودار و سیگنال‌ها</h3>
    <div class="canvas-wrap">
      <canvas id="trendChart" style="width:100%;height:300px"></canvas>
    </div>
    <div class="legend">
      <div class="dot entry-dot"></div><div>ورود</div>
      <div class="dot exit-dot"></div><div>خروج</div>
    </div>
    <div class="signals-list" id="signalsList"></div>
  </div>
</div>

<script>
let historyData = [];
let signals = [];

const ctx = document.getElementById('trendChart').getContext('2d');
const trendChart = new Chart(ctx,{
  type:'line',
  data:{
    labels:[],
    datasets:[
      {label:'حباب قیمت',data:[],borderColor:'#60a5fa',backgroundColor:'rgba(96,165,250,0.15)',tension:0.3,fill:true,pointRadius:5,pointBackgroundColor:[]},
      {label:'حمایت',data:[],borderColor:'#10b981',borderDash:[6,4],fill:false,pointRadius:0},
      {label:'مقاومت',data:[],borderColor:'#ef4444',borderDash:[6,4],fill:false,pointRadius:0},
      {label:'RSI',data:[],borderColor:'#f472b6',fill:false,yAxisID:'rsiAxis',pointRadius:2}
    ]
  },
  options:{
    responsive:true,
    scales:{
      y:{position:'left',title:{display:true,text:'تومان / حباب'}},
      rsiAxis:{position:'right',min:0,max:100,title:{display:true,text:'RSI'}}
    }
  }
});

function saveSignals(){ localStorage.setItem('signals',JSON.stringify(signals)); }
function renderSignals(){
  const el = document.getElementById('signalsList'); el.innerHTML='';
  if(signals.length===0){ el.innerHTML='<div>هنوز سیگنالی صادر نشده است</div>'; return; }
  signals.forEach(s=>{
    const div = document.createElement('div');
    div.className='signal-item';
    div.innerHTML=`<strong>[${s.type}]</strong> ${s.text}`;
    el.appendChild(div);
  });
}

function computeAverage(data,newPrice){
  const days=5;
  const recent=data.slice(-days).map(d=>d.price); recent.push(newPrice);
  return recent.reduce((a,b)=>a+b,0)/recent.length;
}

function computeRSI(prices,period=14){
  if(prices.length<period+1)return 50;
  let gains=0,losses=0;
  for(let i=prices.length-period;i<prices.length;i++){
    const diff=prices[i]-prices[i-1];
    if(diff>0) gains+=diff; else losses+=Math.abs(diff);
  }
  if(losses===0) return 100;
  const rs=gains/losses;
  return 100-(100/(1+rs));
}

function updateChart(){
  trendChart.data.labels=historyData.map((_,i)=>i+1);
  trendChart.data.datasets[0].data=historyData.map(d=>d.bubble);
  trendChart.data.datasets[1].data=historyData.map(d=>d.avg*0.985);
  trendChart.data.datasets[2].data=historyData.map(d=>d.avg*1.015);
  trendChart.data.datasets[3].data=historyData.map(d=>d.rsi);
  trendChart.data.datasets[0].pointBackgroundColor=historyData.map(d=>d.signal==='entry'?'#16a34a':d.signal==='exit'?'#ef4444':'#60a5fa');
  trendChart.update();
}

function pushSignal(type,text){ signals.unshift({type,text}); if(signals.length>50)signals=signals.slice(0,50); saveSignals(); renderSignals(); }

function addData(){
  const gold=parseFloat(document.getElementById('gold18').value);
  const fee=parseFloat(document.getElementById('fee').value)||0;
  if(!gold){ document.getElementById('goldResult').innerText='قیمت را وارد کنید'; return; }
  const finalPrice=gold*(1+fee/100);
  const avg=computeAverage(historyData,finalPrice);
  const bubble=finalPrice-avg;
  const prices=[...historyData.map(d=>d.price),finalPrice];
  const rsi=computeRSI(prices,14);
  const obj={price:finalPrice,avg,bubble,rsi,signal:null};
  if(bubble<-20000){ obj.signal='entry'; pushSignal('ورود',`سیگنال ورود قوی — قیمت: ${finalPrice}`);}
  else if(bubble>20000){ obj.signal='exit'; pushSignal('خروج',`سیگنال خروج قوی — قیمت: ${finalPrice}`);}
  historyData.push(obj); updateChart();
  document.getElementById('goldResult').innerText=`ثبت شد: ${finalPrice.toLocaleString()} | حباب: ${bubble.toLocaleString()} | RSI: ${rsi.toFixed(2)}`;
}

// داده نمونه اولیه
(function initSample(){
  historyData.push({price:13000000,avg:12950000,bubble:50000,rsi:55,signal:'entry'});
  historyData.push({price:12800000,avg:12900000,bubble:-10000,rsi:45,signal:'exit'});
  updateChart();
  pushSignal('ورود','سیگنال نمونه ورود');
  pushSignal('خروج','سیگنال نمونه خروج');
})();
</script>
</body>
</html>
