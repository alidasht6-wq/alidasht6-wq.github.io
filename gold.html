<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù†Ù‡Ø§ÛŒÛŒ Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø± â€” Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ (Ø¨Ø§ AutoFetch Ùˆ Alerts)</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{--bg1:#0f1720;--card:#1f2937;--accent:#ffd369;--muted:#9bd7ff}
*{box-sizing:border-box}
body{margin:0;padding:14px;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:linear-gradient(180deg,var(--bg1),#0b1116);color:#fff}
.container{max-width:980px;margin:0 auto}
.header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
.title{font-size:1.25rem;color:var(--accent);font-weight:700}
.small{font-size:0.85rem;color:#cbd5e1}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:14px;margin-bottom:12px;box-shadow:0 6px 30px rgba(0,0,0,0.6);border:1px solid rgba(255,211,105,0.06)}
.row{display:flex;gap:10px;align-items:center}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
@media(max-width:740px){.grid{grid-template-columns:1fr}}
label{display:block;font-size:0.85rem;margin-bottom:6px;color:#d1d5db}
input[type=number],input[type=text]{width:100%;padding:8px;border-radius:8px;border:none;background:#0b1220;color:#fff}
button{padding:9px 12px;border-radius:10px;border:none;background:var(--accent);color:#000;font-weight:600;cursor:pointer}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff}
.result{background:#071018;padding:10px;border-radius:8px;margin-top:8px;border:1px solid rgba(255,255,255,0.03);font-size:0.95rem}
.kv{display:flex;justify-content:space-between;gap:8px;padding:6px 0;font-size:0.95rem}
.tip{color:var(--muted);font-size:0.88rem;line-height:1.45}
.footer-small{font-size:0.82rem;color:#94a3b8;margin-top:8px}
.toggle{display:inline-block;padding:6px 10px;border-radius:10px;cursor:pointer;font-weight:700}
.toggle.on{background:#16a34a;color:#fff}
.toggle.off{background:#ef4444;color:#fff}
.signals-list{max-height:160px;overflow:auto;margin-top:8px;border-radius:8px;padding:8px;border:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent)}
.signal-item{padding:6px;border-bottom:1px dashed rgba(255,255,255,0.03);font-size:0.9rem}
.canvas-wrap{background:#06121a;padding:8px;border-radius:10px;margin-top:8px}
.legend{display:flex;gap:8px;align-items:center;margin-top:8px}
.legend .dot{width:12px;height:12px;border-radius:3px;display:inline-block}
.entry-dot{background:#16a34a}
.exit-dot{background:#ef4444}
.hr{height:1px;background:rgba(255,255,255,0.03);margin:12px 0;border-radius:2px}
.small-muted{color:#94a3b8;font-size:0.85rem}
.input-inline{display:flex;gap:8px}
.status-badge{display:inline-block;padding:6px 8px;border-radius:8px;font-weight:700}
.status-normal{background:#374151;color:#fff}
.status-high{background:#065f46;color:#fff}
.status-low{background:#7f1d1d;color:#fff}
.counter-box{display:flex;gap:12px;align-items:center}
.counter-box div{min-width:120px}
</style>
</head>
<body>
<div class="container">
<!-- Ù‡Ù…Ø§Ù† Ù…Ø­ØªÙˆØ§ÛŒ UI Ø´Ù…Ø§ Ú©Ù‡ Ø´Ø§Ù…Ù„ headerØŒ ØªÙˆØ¶ÛŒØ­Ø§ØªØŒ ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ØŒ AutoFetch Ùˆ Ù†Ù…ÙˆØ¯Ø§Ø± Ùˆ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø§Ø³Øª -->
<!-- ØªØºÛŒÛŒØ±Ø§Øª AutoFetch Ùˆ Ø´Ù…Ø§Ø±Ø´ Ø¯Ù‚ÛŒÙ‚ Ø¨ÛŒÙ† Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ Ø¯Ø± Ø¬Ø§ÙˆØ§Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯Ù‡ Ø§Ø³Øª -->
</div>

<script>
// -------------------------
// ØªÙ†Ø¸ÛŒÙ… Ø§ÙˆÙ„ÛŒÙ‡ Ùˆ Ù…ØªØºÛŒØ±Ù‡Ø§
// -------------------------
const BRS_URL = "https://brsapi.ir/Api/Market/Gold_Currency.php?key=BBzNUXWfiBpUmeXusfw4mkbjXuXjj9nU";
let apiCounter = parseInt(localStorage.getItem('apiCounter')) || 0;
let historyData = JSON.parse(localStorage.getItem('goldHistory')) || [];
let signals = JSON.parse(localStorage.getItem('signals')) || [];
let notifyActive = (localStorage.getItem('notifyActive') === '1');
if(notifyActive){ document.getElementById('notifyBtn').className='toggle on'; document.getElementById('notifyBtn').innerText='ğŸ”” Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø±ÙˆØ´Ù†'; }
document.getElementById('apiCounter').innerText = apiCounter;

// AutoFetch state
let autoState = { running:false, timerId:null, countdownId:null, nextAt: null, done:0, left:0 };

// -------------------------
// Chart.js setup
// -------------------------
// Ù‡Ù…Ø§Ù† ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù‚Ø¨Ù„ÛŒ Ù†Ù…ÙˆØ¯Ø§Ø± Ø´Ù…Ø§

// -------------------------
// ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒØŒ Ø«Ø¨Øª Ø¯Ø³ØªÛŒ Ùˆ API
// -------------------------
// Ù‡Ù…Ø§Ù† ØªÙˆØ§Ø¨Ø¹ addData, fetchFromAPI, editLastAPI, saveRSIKey, computeRSI, computeAverage, pushSignal, renderSignals, updateChart, autoSignalCheck, signal, checkLimitsAndAlert

// -------------------------
// AutoFetch Ø§ØµÙ„Ø§Ø­â€ŒØ´Ø¯Ù‡ Ùˆ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ
// -------------------------
function startAutoFetch(){
  if(autoState.running){ alert('AutoFetch Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§Ø³Øª'); return; }
  const maxReq = parseInt(document.getElementById('maxRequests').value) || 100;
  if(maxReq < 1 || maxReq > 1500){ alert('Ø­Ø¯Ø§Ú©Ø«Ø± Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† 1 Ùˆ 1500 Ø¨Ø§Ø´Ø¯'); return; }

  const windowSeconds = (22 - 18) * 3600;
  let remainingRequests = Math.max(0, maxReq - apiCounter);
  if(remainingRequests === 0){
    document.getElementById('goldResult').innerText = `âš  Ø³Ù‚Ù ${maxReq} Ø¯Ø±Ø®ÙˆØ§Ø³Øª API Ø§Ù…Ø±ÙˆØ² Ø±Ø³ÛŒØ¯!`;
    return;
  }
  let intervalSec = Math.floor(windowSeconds / remainingRequests);
  if(intervalSec < 3) intervalSec = 3;

  autoState.running = true;
  autoState.done = 0;
  autoState.left = remainingRequests;
  document.getElementById('doneCount').innerText = autoState.done;
  document.getElementById('leftCount').innerText = autoState.left;

  function scheduleNext(){
    const now = new Date();
    const hour = now.getHours();
    let nextDelay = 0;

    if(hour >= 18 && hour < 22){ nextDelay = 0; }
    else {
      const nextStart = new Date(now);
      nextStart.setHours(18,0,0,0);
      if(now >= nextStart) nextStart.setDate(nextStart.getDate() + 1);
      nextDelay = Math.floor((nextStart - now)/1000);
    }

    if(nextDelay > 0){
      document.getElementById('nextIn').innerText = nextDelay;
      autoState.countdownId = setInterval(()=>{
        nextDelay -= 1;
        document.getElementById('nextIn').innerText = nextDelay;
        if(nextDelay <= 0){
          clearInterval(autoState.countdownId);
          beginLoop();
        }
      },1000);
    } else { beginLoop(); }
  }

  function beginLoop(){
    autoState.nextAt = Date.now() + intervalSec*1000;
    autoState.timerId = setInterval(async ()=>{
      const now = new Date();
      const hour = now.getHours();
      if(hour >= 18 && hour < 22){
        if(apiCounter >= maxReq){ stopAutoFetch(); return; }
        await fetchFromAPI();
        autoState.done += 1;
        autoState.left = Math.max(0, maxReq - apiCounter);
        document.getElementById('doneCount').innerText = autoState.done;
        document.getElementById('leftCount').innerText = autoState.left;
        autoState.nextAt = Date.now() + intervalSec*1000;
      } else { stopAutoFetch(); }
    }, intervalSec * 1000);

    autoState.countdownId = setInterval(()=>{
      if(!autoState.nextAt) return;
      const s = Math.max(0, Math.ceil((autoState.nextAt - Date.now())/1000));
      document.getElementById('nextIn').innerText = s;
    }, 500);
  }

  scheduleNext();
  document.getElementById('goldResult').innerText = 'AutoFetch Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ Ø´Ø¯Ø› Ù…Ù†ØªØ¸Ø± Ø´Ø±ÙˆØ¹ ÛŒØ§ Ø§Ø¬Ø±Ø§ÛŒ Ø¢Ù† Ø¨Ø§Ø´ÛŒØ¯.';
}

function stopAutoFetch(){
  if(autoState.timerId) clearInterval(autoState.timerId);
  if(autoState.countdownId) clearInterval(autoState.countdownId);
  autoState = { running:false, timerId:null, countdownId:null, nextAt: null, done:0, left:0 };
  document.getElementById('nextIn').innerText = 'â€”';
  document.getElementById('doneCount').innerText = '0';
  document.getElementById('leftCount').innerText = '0';
  document.getElementById('goldResult').innerText = 'AutoFetch Ù…ØªÙˆÙ‚Ù Ø´Ø¯.';
}

// -------------------------
// ÙˆØ¶Ø¹ÛŒØª Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†
// -------------------------
function toggleNotification(){
  notifyActive = !notifyActive;
  localStorage.setItem('notifyActive', notifyActive ? '1' : '0');
  const btn = document.getElementById('notifyBtn');
  if(notifyActive){ btn.className = 'toggle on'; btn.innerText = 'ğŸ”” Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø±ÙˆØ´Ù†'; }
  else { btn.className = 'toggle off'; btn.innerText = 'ğŸ”” Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø®Ø§Ù…ÙˆØ´'; }
}

// -------------------------
// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ù†Ù…ÙˆØ¯Ø§Ø± Ùˆ Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§
// -------------------------
function init(){ updateChart(); renderSignals(); document.getElementById('apiCounter').innerText = apiCounter; document.getElementById('leftCount').innerText = 0; }
init();

// -------------------------
// Ø±ÛŒØ³Øª Ùˆ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ
// -------------------------
window.resetApiCounter = function(){ if(confirm('Ø¢ÛŒØ§ Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ API Ø±Ø§ Ø±ÛŒØ³Øª Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯ØŸ')){ apiCounter=0; localStorage.setItem('apiCounter','0'); document.getElementById('apiCounter').innerText='0'; alert('Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ Ø±ÛŒØ³Øª Ø´Ø¯.'); } };
window.clearAllData = function(){ if(confirm('Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø´ÙˆÙ†Ø¯ØŸ')){ historyData=[]; signals=[]; saveHistory(); saveSignals(); updateChart(); renderSignals(); document.getElementById('goldResult').innerText='Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø´Ø¯.'; } };
</script>
</body>
</html>
