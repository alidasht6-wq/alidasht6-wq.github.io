<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø± â€” RSI Ùˆ Ù‚ÛŒÙ…Øª</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{--bg1:#0f1720;--card:#1f2937;--accent:#ffd369;--muted:#9bd7ff}
body{margin:0;padding:14px;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:linear-gradient(180deg,var(--bg1),#0b1116);color:#fff}
.container{max-width:980px;margin:0 auto}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:14px;margin-bottom:12px;box-shadow:0 6px 30px rgba(0,0,0,0.6);border:1px solid rgba(255,211,105,0.06)}
input,button{padding:8px;border-radius:8px;border:none;background:#0b1220;color:#fff}
button{cursor:pointer;background:#ffd369;color:#000;font-weight:600}
.small-muted{color:#94a3b8;font-size:0.85rem}
#trendChart{width:100%;height:360px}
.signal-item{padding:6px;border-bottom:1px dashed rgba(255,255,255,0.03);font-size:0.9rem}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <h3>Ú©Ù„ÛŒØ¯ API RSI</h3>
    <input id="rsiApiKey" type="text" placeholder="ALPHAVANTAGE_KEY">
    <button onclick="saveRSIKey()">Ø°Ø®ÛŒØ±Ù‡ Ú©Ù„ÛŒØ¯ RSI</button>
  </div>

  <div class="card">
    <h3>Ù‚ÛŒÙ…Øª Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø±ØŒ Ø¯Ù„Ø§Ø± Ùˆ Ø§Ù†Ø³</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <input id="gold18" type="number" placeholder="Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø± (ØªÙˆÙ…Ø§Ù†)">
      <input id="usd" type="number" placeholder="Ø¯Ù„Ø§Ø± (ØªÙˆÙ…Ø§Ù†)">
      <input id="ounce" type="number" placeholder="Ø§Ù†Ø³ (Ø¯Ù„Ø§Ø±)">
      <input id="fee" type="number" placeholder="Ø§Ø¬Ø±Øª+Ù…Ø§Ù„ÛŒØ§Øª+Ø³ÙˆØ¯ %">
    </div>
    <button onclick="addData()">Ø«Ø¨Øª Ø¯Ø§Ø¯Ù‡</button>
    <button onclick="fetchFromAPI()">ğŸ“¡ Ø¯Ø±ÛŒØ§ÙØª Ø®ÙˆØ¯Ú©Ø§Ø± Ø§Ø² API</button>
    <div id="goldResult" class="small-muted" style="margin-top:6px">ÙˆØ¶Ø¹ÛŒØª: Ø¢Ù…Ø§Ø¯Ù‡</div>
  </div>

  <div class="card">
    <h3>Ù†Ù…ÙˆØ¯Ø§Ø± Ø­Ø¨Ø§Ø¨ Ùˆ RSI</h3>
    <canvas id="trendChart"></canvas>
    <div id="signalsList"></div>
  </div>
</div>

<script>
const BRS_URL = "https://brsapi.ir/Api/Market/Gold_Currency.php?key=BBzNUXWfiBpUmeXusfw4mkbjXuXjj9nU";
let historyData = JSON.parse(localStorage.getItem('goldHistory')) || [];
let signals = JSON.parse(localStorage.getItem('signals')) || [];

const ctx = document.getElementById('trendChart').getContext('2d');
const trendChart = new Chart(ctx,{type:'line',data:{labels:[],datasets:[
  {label:'Ø­Ø¨Ø§Ø¨',data:[],borderColor:'#60a5fa',backgroundColor:'rgba(96,165,250,0.15)',tension:0.3,fill:true,pointRadius:5,pointBackgroundColor:[]},
  {label:'RSI',data:[],borderColor:'#f472b6',fill:false,yAxisID:'rsiAxis',pointRadius:2}
]},options:{responsive:true,interaction:{mode:'index',intersect:false},scales:{y:{position:'left',title:{display:true,text:'ØªÙˆÙ…Ø§Ù†'}},rsiAxis:{position:'right',min:0,max:100,title:{display:true,text:'RSI'}}},plugins:{legend:{labels:{boxWidth:12}}}}});

function saveRSIKey(){const k=document.getElementById('rsiApiKey').value.trim();if(!k){alert('Ú©Ù„ÛŒØ¯ ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡');return;}localStorage.setItem('rsiApiKey',k);document.getElementById('goldResult').innerText='Ú©Ù„ÛŒØ¯ RSI Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯';}

function computeAverage(data,newPrice){const recent=data.slice(-5).map(d=>d.price);recent.push(newPrice);return recent.reduce((a,b)=>a+b,0)/recent.length;}
function computeRSI(prices,period=14){if(prices.length<period+1)return 50;let gains=0,losses=0;for(let i=prices.length-period;i<prices.length;i++){const diff=prices[i]-prices[i-1];if(diff>0)gains+=diff;else losses+=Math.abs(diff);}if(losses===0)return 100;const rs=gains/losses;return 100-(100/(1+rs));}

async function fetchRSIFromAPI(symbol='XAUUSD',interval='daily',time_period=14){
  const key = localStorage.getItem('rsiApiKey'); if(!key) return null;
  try{const url=`https://www.alphavantage.co/query?function=RSI&symbol=${symbol}&interval=${interval}&time_period=${time_period}&series_type=close&apikey=${key}`;
    const res=await fetch(url); const j=await res.json(); if(j['Technical Analysis: RSI']){
      const lastKey=Object.keys(j['Technical Analysis: RSI'])[0]; return parseFloat(j['Technical Analysis: RSI'][lastKey]['RSI']);
    }return null;}catch(e){console.warn(e);return null;}
}

function pushSignal(type,text){const now=new Date().toLocaleString();signals.unshift({type,text,ts:now});if(signals.length>50)signals=signals.slice(0,50);localStorage.setItem('signals',JSON.stringify(signals));renderSignals();}
function renderSignals(){const el=document.getElementById('signalsList');el.innerHTML='';if(signals.length===0){el.innerHTML='<div class="small-muted">Ù‡Ù†ÙˆØ² Ø³ÛŒÚ¯Ù†Ø§Ù„ÛŒ ØµØ§Ø¯Ø± Ù†Ø´Ø¯Ù‡</div>';return;}signals.forEach(s=>{const div=document.createElement('div');div.className='signal-item';div.innerHTML=`<strong>[${s.type}]</strong> ${s.text} <div class="small-muted">${s.ts}</div>`;el.appendChild(div);});}
function updateChart(){trendChart.data.labels=historyData.map((_,i)=>i+1);trendChart.data.datasets[0].data=historyData.map(d=>d.bubble);trendChart.data.datasets[1].data=historyData.map(d=>d.rsi);trendChart.data.datasets[0].pointBackgroundColor=historyData.map(d=>d.signal==='entry'?'#16a34a':d.signal==='exit'?'#ef4444':'#60a5fa');trendChart.update();}

async function addData(){
  const gold=parseFloat(document.getElementById('gold18').value);
  const usd=parseFloat(document.getElementById('usd').value)||0;
  const ounce=parseFloat(document.getElementById('ounce').value)||0;
  const fee=parseFloat(document.getElementById('fee').value)||0;
  if(!gold && !(usd && ounce)){document.getElementById('goldResult').innerText='Ù„Ø·ÙØ§Ù‹ Ø·Ù„Ø§ÛŒ Û±Û¸ ÛŒØ§ Ø¯Ù„Ø§Ø± Ùˆ Ø§Ù†Ø³ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯';return;}
  let finalPrice = gold || ((ounce*usd)/31.1035)*(1+fee/100);
  const avg = computeAverage(historyData,finalPrice);
  const bubble = finalPrice - avg;

  const pricesForRSI = [...historyData.map(d=>d.price),finalPrice];
  let rsi=50;
  const fetched = await fetchRSIFromAPI();
  if(fetched!==null) rsi=fetched; else rsi=computeRSI(pricesForRSI,14);

  let signalType=null;
  if(rsi<30) signalType='entry';
  else if(rsi>70) signalType='exit';

  historyData.push({price:finalPrice,bubble:bubble,rsi:rsi,signal:signalType,usd:usd,ounce:ounce,fee:fee,ts:Date.now()});
  localStorage.setItem('goldHistory',JSON.stringify(historyData));
  document.getElementById('goldResult').innerText=`Ø«Ø¨Øª Ø´Ø¯: ${finalPrice.toLocaleString()} ØªÙˆÙ…Ø§Ù† | Ø­Ø¨Ø§Ø¨: ${bubble.toLocaleString()} | RSI: ${rsi.toFixed(2)}`;
  pushSignal(signalType==='entry'?'Ø®Ø±ÛŒØ¯':signalType==='exit'?'ÙØ±ÙˆØ´':'Ø®Ù†Ø«ÛŒ',`Ù‚ÛŒÙ…Øª: ${finalPrice.toLocaleString()} | RSI: ${rsi.toFixed(2)}`);
  updateChart();
}

async function fetchFromAPI(){
  try{
    const res=await fetch(BRS_URL); const j=await res.json();
    const goldObj=Array.isArray(j.gold)?j.gold.find(i=>i.symbol==='IR_GOLD_18K'):null;
    const xauObj=Array.isArray(j.gold)?j.gold.find(i=>i.symbol==='XAUUSD'):null;
    const usdObj=Array.isArray(j.currency)?j.currency.find(i=>i.symbol==='USD'):null;
    const gold18=goldObj?parseFloat(goldObj.price):null;
    const ounce=xauObj?parseFloat(xauObj.price):null;
    const usd=usdObj?parseFloat(usdObj.price):null;
    document.getElementById('gold18').value=gold18||''; document.getElementById('usd').value=usd||''; document.getElementById('ounce').value=ounce||'';
    await addData();
  }catch(err){console.error(err); document.getElementById('goldResult').innerText='âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø² API';}
}

function init(){updateChart();renderSignals();}
init();
</script>
</body>
</html>
