/* -------------------------
  AutoFetch: زمان‌بندی بین 18:00 تا 22:00 (اصلاح‌شده)
--------------------------*/
function startAutoFetch(){
  if(autoState.running){ alert('AutoFetch در حال اجراست'); return; }
  const maxReq = parseInt(document.getElementById('maxRequests').value) || 100;
  if(maxReq < 1 || maxReq > 1500){ alert('حداکثر باید بین 1 و 1500 باشد'); return; }

  const now = new Date();
  const startHour = 18, endHour = 22;
  const windowSeconds = (endHour - startHour) * 3600; // 4 ساعت = 14400 ثانیه
  let remainingRequests = Math.max(0, maxReq - apiCounter);
  if(remainingRequests === 0){
    document.getElementById('goldResult').innerText = `⚠ سقف ${maxReq} درخواست API امروز رسید!`;
    return;
  }
  let intervalSec = Math.floor(windowSeconds / remainingRequests);
  if(intervalSec < 3) intervalSec = 3; // حداقل فاصله 3 ثانیه

  autoState.running = true;
  autoState.done = 0;
  autoState.left = remainingRequests;
  document.getElementById('doneCount').innerText = autoState.done;
  document.getElementById('leftCount').innerText = autoState.left;

  function scheduleNext(){
    const now = new Date();
    const hour = now.getHours();
    let nextDelay = 0;

    if(hour >= startHour && hour < endHour){
      nextDelay = 0; // اجرا فوری
    } else {
      const nextStart = new Date(now);
      nextStart.setHours(startHour,0,0,0);
      if(now >= nextStart) nextStart.setDate(nextStart.getDate() + 1);
      nextDelay = Math.floor((nextStart - now)/1000);
    }

    if(nextDelay > 0){
      document.getElementById('nextIn').innerText = nextDelay;
      autoState.countdownId = setInterval(()=>{
        nextDelay -= 1;
        document.getElementById('nextIn').innerText = nextDelay;
        if(nextDelay <= 0){
          clearInterval(autoState.countdownId);
          beginLoop();
        }
      },1000);
    } else {
      beginLoop();
    }
  }

  function beginLoop(){
    autoState.nextAt = Date.now() + intervalSec*1000;
    autoState.timerId = setInterval(async ()=>{
      const now = new Date();
      const hour = now.getHours();
      if(hour >= startHour && hour < endHour){
        if(apiCounter >= maxReq){ stopAutoFetch(); return; }
        await fetchFromAPI();
        autoState.done += 1;
        autoState.left = Math.max(0, maxReq - apiCounter);
        document.getElementById('doneCount').innerText = autoState.done;
        document.getElementById('leftCount').innerText = autoState.left;
        autoState.nextAt = Date.now() + intervalSec*1000;
      } else {
        stopAutoFetch();
      }
    }, intervalSec * 1000);

    autoState.countdownId = setInterval(()=>{
      if(!autoState.nextAt) return;
      const s = Math.max(0, Math.ceil((autoState.nextAt - Date.now())/1000));
      document.getElementById('nextIn').innerText = s;
    }, 500);
  }

  scheduleNext();
  document.getElementById('goldResult').innerText = 'AutoFetch برنامه‌ریزی شد؛ منتظر شروع یا اجرای آن باشید.';
}

function stopAutoFetch(){
  if(autoState.timerId) clearInterval(autoState.timerId);
  if(autoState.countdownId) clearInterval(autoState.countdownId);
  autoState.running = false;
  autoState.timerId = null;
  autoState.countdownId = null;
  autoState.nextAt = null;
  document.getElementById('nextIn').innerText = '—';
  document.getElementById('doneCount').innerText = '0';
  document.getElementById('leftCount').innerText = '0';
  document.getElementById('goldResult').innerText = 'AutoFetch متوقف شد.';
}
