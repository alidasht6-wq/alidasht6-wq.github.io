<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>برنامه حرفه‌ای طلا و ارز</title>
<style>
  body { font-family: sans-serif; background:#f4f4f4; margin:0; padding:20px; }
  .card { background:#fff; padding:20px; margin-bottom:15px; border-radius:12px; box-shadow:0 3px 8px rgba(0,0,0,0.1); }
  .title { font-size:20px; font-weight:bold; margin-bottom:10px; }
  .row { display:flex; gap:10px; margin-top:10px; }
  button { padding:10px 15px; border:none; border-radius:8px; cursor:pointer; background:#2196f3; color:white; }
  .danger { background:#e53935; }
  .success { background:#43a047; }
  input { padding:8px; width:100%; border-radius:6px; border:1px solid #aaa; }
  .flex { display:flex; justify-content:space-between; align-items:center; }
  .status { padding:5px 10px; border-radius:6px; color:white; font-size:13px; }
</style>
</head>
<body>

<div class="card">
  <div class="title">تنظیمات API</div>
  <label>کلید API:</label>
  <input id="apiKey" placeholder="Your API Key" />
</div>

<div class="card">
  <div class="title">درخواست خودکار (18 تا 22)</div>
  <div>تعداد کل درخواست مجاز در روز:</div>
  <input id="maxRequests" type="number" value="1500" />

  <div class="row">
    <button onclick="startAutoFetch()">شروع خودکار</button>
    <button class="danger" onclick="stopAutoFetch()">توقف</button>
  </div>

  <div class="flex" style="margin-top:15px;">
    <div>انجام شده: <span id="doneCount">0</span></div>
    <div>باقی‌مانده: <span id="leftCount">0</span></div>
    <div>بعدی: <span id="nextIn">0</span> ثانیه</div>
  </div>
</div>

<div class="card">
  <div class="title">حد بالا / حد پایین (هشدار)</div>
  <label>حد پایین:</label>
  <input id="lowLimit" type="number" />

  <label>حد بالا:</label>
  <input id="highLimit" type="number" />

  <div class="row">
    <button class="success" onclick="saveLimits()">ذخیره محدوده</button>
  </div>
</div>

<div class="card">
  <div class="title">وضعیت قیمت</div>
  <div>قیمت لحظه‌ای طلا: <span id="goldPrice">---</span></div>
  <div>حباب: <span id="bubble">---</span></div>
  <div>RSI: <span id="rsi">---</span></div>

  <div class="status" id="priceStatus" style="background:gray; margin-top:10px;">وضعیت نرمال</div>
</div>

<script>
let autoTimer = null;
let requestCount = 0;

function fetchGold() {
    const key = document.getElementById("apiKey").value.trim();
    if (!key) return;

    fetch(`https://brsapi.ir/Api/Market/Gold_Currency.php?key=${key}`)
      .then(r => r.json())
      .then(data => {
          let gold = parseFloat(data.G18?.price || 0);
          let bubble = parseFloat(data.G18?.bubble || 0);
          let rsi = parseFloat(data.G18?.RSI || 50);

          document.getElementById("goldPrice").innerText = gold.toLocaleString() + " تومان";
          document.getElementById("bubble").innerText = bubble;
          document.getElementById("rsi").innerText = rsi;

          checkLimits(gold);
      });
}

function startAutoFetch() {
    let max = Number(document.getElementById("maxRequests").value);
    let interval = Math.floor((4 * 60 * 60) / max); // seconds

    requestCount = 0;
    document.getElementById("leftCount").innerText = max;

    autoTimer = setInterval(() => {
        let now = new Date();
        let hour = now.getHours();

        if (hour >= 18 && hour < 22) {
            requestCount++;
            document.getElementById("doneCount").innerText = requestCount;
            document.getElementById("leftCount").innerText = max - requestCount;
            document.getElementById("nextIn").innerText = interval;
            fetchGold();
        }
        if (requestCount >= max) stopAutoFetch();
    }, interval * 1000);
}

function stopAutoFetch() {
    clearInterval(autoTimer);
    alert("درخواست خودکار متوقف شد");
}

let limitLow = 0, limitHigh = 0;
function saveLimits() {
    limitLow = Number(document.getElementById("lowLimit").value);
    limitHigh = Number(document.getElementById("highLimit").value);
    alert("محدوده هشدار ذخیره شد");
}

function checkLimits(price) {
    const box = document.getElementById("priceStatus");

    if (limitLow && price < limitLow) {
        box.innerText = "قیمت زیر حد پایین";
        box.style.background = "#e53935";
        notify("قیمت پایین‌تر از حد تعیین‌شده است!");
    }
    else if (limitHigh && price > limitHigh) {
        box.innerText = "قیمت بالاتر از حد بالا";
        box.style.background = "#43a047";
        notify("قیمت بالاتر از حد تعیین‌شده است!");
    }
    else {
        box.innerText = "وضعیت نرمال";
        box.style.background = "gray";
    }
}

function notify(text) {
    if (Notification.permission === "granted") {
        new Notification(text);
    }
}

if (Notification.permission !== "granted") Notification.requestPermission();
</script>

</body>
</html>
