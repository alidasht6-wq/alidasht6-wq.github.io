<?php
// gold_dashboard_index.php
// ÛŒÚ© ÙØ§ÛŒÙ„ PHP ÙˆØ§Ø­Ø¯ Ú©Ù‡ Ù‡Ù… Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ (HTML/JS) Ø±Ø§ Ø³Ø±Ùˆ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ùˆ Ù‡Ù… endpointâ€ŒÙ‡Ø§ÛŒ Ø³Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ
// ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ BRSAPIØŒ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ API Ùˆ Ø°Ø®ÛŒØ±Ù‡/Ø®ÙˆØ§Ù†Ø¯Ù† ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ùˆ Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§.
// Ù†Ú©ØªÙ‡: Ø§ÛŒÙ† Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø±Ø§ÛŒ ØªÙˆØ³Ø¹Ù‡ Ù…Ø­Ù„ÛŒ/Ø³Ø±ÙˆØ± Ø³Ø§Ø¯Ù‡ Ù…Ù†Ø§Ø³Ø¨ Ø§Ø³Øª. Ø¨Ø±Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯ØŒ Ø­ØªÙ…Ø§Ù‹ Ú©Ù†ØªØ±Ù„ Ø¯Ø³ØªØ±Ø³ÛŒØŒ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª
// Ùˆ Ø­ÙØ§Ø¸Øª Ø¯Ø± Ø¨Ø±Ø§Ø¨Ø± DoS/CORS Ùˆ Ù…Ø­Ø¯ÙˆØ¯Ø³Ø§Ø²ÛŒ ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ Ø±Ø§ Ø§Ø¹Ù…Ø§Ù„ Ú©Ù†ÛŒØ¯.

// ----- ØªÙ†Ø¸ÛŒÙ…Ø§Øª -----
const BRS_URL = "https://brsapi.ir/Api/Market/Gold_Currency.php?key=BBzNUXWfiBpUmeXusfw4mkbjXuXjj9nU"; // Ø§Ú¯Ø± Ú©Ù„ÛŒØ¯Øª Ø¹ÙˆØ¶ Ø´Ø¯ Ø§ÛŒÙ† Ø±Ø§ ØªØºÛŒÛŒØ± Ø¨Ø¯Ù‡
const DATA_DIR = __DIR__ . '/data';
if(!file_exists(DATA_DIR)) mkdir(DATA_DIR, 0755, true);
$counterFile = DATA_DIR . '/api_counter.json';
$historyFile = DATA_DIR . '/gold_history.json';
signalsFile = DATA_DIR . '/signals.json';

// helper: read/write json with lock
function read_json($path){ if(!file_exists($path)) return null; $c = @file_get_contents($path); return $c ? json_decode($c, true) : null; }
function write_json($path, $data){ $tmp = $path . '.tmp'; file_put_contents($tmp, json_encode($data, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE)); rename($tmp, $path); }

// init files
if(!file_exists($counterFile)) write_json($counterFile, ['count'=>0,'date'=>date('Y-m-d')]);
if(!file_exists($historyFile)) write_json($historyFile, []);
if(!file_exists($signalsFile)) write_json($signalsFile, []);

// Ù…Ø³ÛŒØ± endpointÙ‡Ø§ Ø¨Ø§ Ù¾Ø§Ø±Ø§Ù…ØªØ± action ØªØ¹ÛŒÛŒÙ† Ù…ÛŒâ€ŒØ´ÙˆØ¯
$action = isset($_GET['action']) ? $_GET['action'] : null;
if($action){ header('Content-Type: application/json; charset=utf-8'); }

switch($action){
  case 'fetch_brs':
    // Ø³Ø±ÙˆØ±-side fetch Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² CORS Ùˆ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡
    $res = @file_get_contents(BRS_URL);
    if($res === false){ http_response_code(502); echo json_encode(['ok'=>false,'error'=>'fetch_failed']); exit; }
    $j = json_decode($res, true);
    // Ø§ÙØ²Ø§ÛŒØ´ Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ Ø±ÙˆØ²Ø§Ù†Ù‡
    $c = read_json($counterFile) ?: ['count'=>0,'date'=>date('Y-m-d')];
    if($c['date'] !== date('Y-m-d')){ $c['count'] = 0; $c['date'] = date('Y-m-d'); }
    $c['count'] = intval($c['count']) + 1;
    write_json($counterFile, $c);
    echo json_encode(['ok'=>true,'data'=>$j,'counter'=>$c['count']]);
    exit;

  case 'get_counter':
    $c = read_json($counterFile) ?: ['count'=>0,'date'=>date('Y-m-d')];
    // Ø§Ú¯Ø± ØªØ§Ø±ÛŒØ® ÙØ±Ù‚ Ú©Ù†Ø¯ Ø±ÛŒØ³Øª Ù…ÛŒâ€ŒØ´ÙˆØ¯
    if($c['date'] !== date('Y-m-d')){ $c['count']=0; $c['date']=date('Y-m-d'); write_json($counterFile,$c); }
    echo json_encode(['ok'=>true,'count'=>$c['count'],'date'=>$c['date']]); exit;

  case 'reset_counter':
    // Ø±ÛŒØ³Øª Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ (Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ø¯Ø± Ù…Ø­ÛŒØ· ÙˆØ§Ù‚Ø¹ÛŒ Ù„Ø§Ø²Ù… Ø§Ø³Øª)
    write_json($counterFile,['count'=>0,'date'=>date('Y-m-d')]); echo json_encode(['ok'=>true]); exit;

  case 'save_history':
    // Ø°Ø®ÛŒØ±Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡â€ŒØ§ÛŒ Ú©Ù‡ Ø§Ø² Ø·Ø±Ù frontend Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯
    $body = file_get_contents('php://input');
    $arr = json_decode($body, true);
    if(!is_array($arr)){ http_response_code(400); echo json_encode(['ok'=>false,'error'=>'invalid_json']); exit; }
    // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø³Ø§Ø¯Ù‡: Ø¢Ø±Ø§ÛŒÙ‡â€ŒØ§ÛŒ Ø§Ø² Ø§Ø´ÛŒØ§Ø¡ Ø¨Ø§ price Ùˆ ts
    $clean = [];
    foreach($arr as $item){ if(isset($item['price']) && isset($item['ts'])) $clean[] = ['price'=>floatval($item['price']),'avg'=>floatval($item['avg'] ?? 0),'bubble'=>floatval($item['bubble'] ?? 0),'rsi'=>floatval($item['rsi'] ?? 50),'ts'=>$item['ts'],'usd'=>floatval($item['usd'] ?? 0),'ounce'=>floatval($item['ounce'] ?? 0),'fee'=>floatval($item['fee'] ?? 0),'signal'=>$item['signal'] ?? null]; }
    write_json($historyFile, $clean);
    echo json_encode(['ok'=>true,'saved'=>count($clean)]); exit;

  case 'get_history':
    $h = read_json($historyFile) ?: [];
    echo json_encode(['ok'=>true,'history'=>$h]); exit;

  case 'save_signal':
    $body = file_get_contents('php://input'); $s = json_decode($body,true);
    if(!is_array($s) || !isset($s['type']) || !isset($s['text'])){ http_response_code(400); echo json_encode(['ok'=>false]); exit; }
    $db = read_json($signalsFile) ?: [];
    array_unshift($db, ['type'=>$s['type'],'text'=>$s['text'],'ts'=>date('c')]);
    if(count($db)>200) $db = array_slice($db,0,200);
    write_json($signalsFile,$db);
    echo json_encode(['ok'=>true]); exit;

  case 'get_signals':
    $db = read_json($signalsFile) ?: [];
    echo json_encode(['ok'=>true,'signals'=>$db]); exit;

  case 'fetch_rsi':
    // Ø§ÛŒÙ† endpoint Ø³Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø§Ø² AlphaVantage ÛŒØ§ Ù‡Ø± Ø³Ø±ÙˆÛŒØ³ Ø¯ÛŒÚ¯Ø±ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†Ø¯ Ø§Ú¯Ø± Ú©Ù„ÛŒØ¯ Ø¯Ø± Ø³Ø±ÙˆØ± Ù‚Ø±Ø§Ø± Ú¯ÛŒØ±Ø¯.
    // Ø¯Ø± Ø§ÛŒÙ† Ù†Ù…ÙˆÙ†Ù‡ Ù…Ø§ Ø¨Ù‡ Ø³Ø§Ø¯Ú¯ÛŒ RSI Ø±Ø§ Ø§Ø² Ø¢Ø±Ø§ÛŒÙ‡Ù” Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ø¨Ù‡ Ù…Ø§ ÙØ±Ø³ØªØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ….
    $body = file_get_contents('php://input'); $in = json_decode($body,true);
    if(!is_array($in) || !isset($in['prices'])){ http_response_code(400); echo json_encode(['ok'=>false,'error'=>'no_prices']); exit; }
    $prices = array_map('floatval',$in['prices']);
    $period = intval($in['period'] ?? 14);
    $rsi = compute_rsi_php($prices,$period);
    echo json_encode(['ok'=>true,'rsi'=>$rsi]); exit;

  default:
    // Ù‡ÛŒÚ† action Ù…Ø´Ø®Øµ Ù†Ø´Ø¯Ù‡ -> Ù†Ù…Ø§ÛŒØ´ ØµÙØ­Ù‡ HTML
}

// ------------ helper PHP functions ---------------
function compute_rsi_php($prices, $period=14){
  $n = count($prices);
  if($n < $period+1) return 50.0;
  $gains = 0.0; $losses = 0.0;
  for($i = $n - $period; $i < $n; $i++){
    $diff = $prices[$i] - $prices[$i-1];
    if($diff > 0) $gains += $diff; else $losses += abs($diff);
  }
  if($losses == 0.0) return 100.0;
  $rs = $gains / $losses;
  return 100.0 - (100.0 / (1.0 + $rs));
}

// Ø§Ú¯Ø± Ø±Ø³ÛŒØ¯ÛŒÙ… Ø§ÛŒÙ†Ø¬Ø§ØŒ ØµÙØ­Ù‡Ù” Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø±Ø§ Ú†Ø§Ù¾ Ú©Ù†
?>
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù†Ù‡Ø§ÛŒÛŒ Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø± â€” Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ (Ø¨Ø§ AutoFetch Ùˆ Alerts)</title>
<script>
function addData(price){ /* full implementation here */ }
function updateChart(){ /* full implementation here */ }
function autoSignalCheck(){ /* full implementation here */ }
function startAutoFetch(){ /* full implementation here */ }
function stopAutoFetch(){ /* full implementation here */ }
function fetchRSI(){ /* full implementation here */ }
function saveSignal(sig){ /* full implementation here */ }
function loadHistory(){ /* full implementation here */ }
</script>
<style>
/* Ù‡Ù…Ø§Ù† Ø§Ø³ØªØ§ÛŒÙ„ Ù‚Ø¨Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø¯Ú¯ÛŒ */
:root{--bg1:#0f1720;--card:#1f2937;--accent:#ffd369;--muted:#9bd7ff}
*{box-sizing:border-box}
body{margin:0;padding:14px;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:linear-gradient(180deg,var(--bg1),#0b1116);color:#fff}
.container{max-width:980px;margin:0 auto}
.header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
.title{font-size:1.25rem;color:var(--accent);font-weight:700}
.small{font-size:0.85rem;color:#cbd5e1}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:14px;margin-bottom:12px;box-shadow:0 6px 30px rgba(0,0,0,0.6);border:1px solid rgba(255,211,105,0.06)}
.row{display:flex;gap:10px;align-items:center}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
@media(max-width:740px){.grid{grid-template-columns:1fr}}
label{display:block;font-size:0.85rem;margin-bottom:6px;color:#d1d5db}
input[type=number],input[type=text]{width:100%;padding:8px;border-radius:8px;border:none;background:#0b1220;color:#fff}
button{padding:9px 12px;border-radius:10px;border:none;background:var(--accent);color:#000;font-weight:600;cursor:pointer}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff}
.result{background:#071018;padding:10px;border-radius:8px;margin-top:8px;border:1px solid rgba(255,255,255,0.03);font-size:0.95rem}
.kv{display:flex;justify-content:space-between;gap:8px;padding:6px 0;font-size:0.95rem}
.tip{color:var(--muted);font-size:0.88rem;line-height:1.45}
.footer-small{font-size:0.82rem;color:#94a3b8;margin-top:8px}
.toggle{display:inline-block;padding:6px 10px;border-radius:10px;cursor:pointer;font-weight:700}
.toggle.on{background:#16a34a;color:#fff}
.toggle.off{background:#ef4444;color:#fff}
.signals-list{max-height:160px;overflow:auto;margin-top:8px;border-radius:8px;padding:8px;border:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent)}
.signal-item{padding:6px;border-bottom:1px dashed rgba(255,255,255,0.03);font-size:0.9rem}
.canvas-wrap{background:#06121a;padding:8px;border-radius:10px;margin-top:8px}
.legend{display:flex;gap:8px;align-items:center;margin-top:8px}
.legend .dot{width:12px;height:12px;border-radius:3px;display:inline-block}
.entry-dot{background:#16a34a}
.exit-dot{background:#ef4444}
.hr{height:1px;background:rgba(255,255,255,0.03);margin:12px 0;border-radius:2px}
.small-muted{color:#94a3b8;font-size:0.85rem}
.input-inline{display:flex;gap:8px}
.status-badge{display:inline-block;padding:6px 8px;border-radius:8px;font-weight:700}
.status-normal{background:#374151;color:#fff}
.status-high{background:#065f46;color:#fff}
.status-low{background:#7f1d1d;color:#fff}
.counter-box{display:flex;gap:12px;align-items:center}
.counter-box div{min-width:120px}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div>
      <div class="title">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù†Ù‡Ø§ÛŒÛŒ Ù†ÙˆØ³Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ â€” Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø±</div>
      <div class="small">ÙˆØ±Ú˜Ù†: Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ â€” Ø¯Ø³ØªÛŒ + API (Ø¨Ø§ proxy PHP)</div>
    </div>
    <div class="small-muted">Ø°Ø®ÛŒØ±Ù‡ Ù…Ø­Ù„ÛŒ: LocalStorage â€¢ Ø¯Ø±Ø®ÙˆØ§Ø³Øª API: Ø§Ø² Ø·Ø±ÛŒÙ‚ Ø³Ø±ÙˆØ± (Ø¨Ø¯ÙˆÙ† CORS)</div>
  </div>

  <!-- Ø¨Ù‚ÛŒÙ‡ HTML Ù‡Ù…Ø§Ù† Ø§Ø³Øª - Ø¨Ø±Ø§ÛŒ Ú©ÙˆØªØ§Ù‡ÛŒ ÙÙ‚Ø· Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ù‡Ù… JS Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯Ù†Ø¯ -->

  <!-- ÙˆØ±ÙˆØ¯ÛŒ Ù‡Ø§ -->
  <div class="card">
    <h3 style="margin:0 0 8px;color:var(--accent)">ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù‚ÛŒÙ…Øª (Ø¯Ø³ØªÛŒ ÛŒØ§ API)</h3>
    <div class="grid">
      <div>
        <label>Ù‚ÛŒÙ…Øª Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø± (ØªÙˆÙ…Ø§Ù†)</label>
        <input id="gold18" type="number" placeholder="Ù…Ø«Ø§Ù„: 12679000">
      </div>
      <div>
        <label>Ù‚ÛŒÙ…Øª Ø¯Ù„Ø§Ø± (ØªÙˆÙ…Ø§Ù†)</label>
        <input id="usd" type="number" placeholder="Ù…Ø«Ø§Ù„: 125000">
      </div>
      <div>
        <label>Ù‚ÛŒÙ…Øª Ø§Ù†Ø³ Ø¬Ù‡Ø§Ù†ÛŒ (Ø¯Ù„Ø§Ø±)</label>
        <input id="ounce" type="number" placeholder="Ù…Ø«Ø§Ù„: 1960.12">
      </div>
      <div>
        <label>Ø§Ø¬Ø±Øª + Ù…Ø§Ù„ÛŒØ§Øª + Ø³ÙˆØ¯ (%)</label>
        <input id="fee" type="number" placeholder="Ù…Ø«Ø§Ù„: 1.2">
      </div>
    </div>

    <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;align-items:center">
      <button onclick="addData()">Ø«Ø¨Øª Ø¯Ø§Ø¯Ù‡ (Ø¯Ø³ØªÛŒ)</button>
      <button class="btn-ghost" onclick="fetchFromAPI()">ğŸ“¡ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø² API (Ø§Ø² Ø³Ø±ÙˆØ±)</button>
      <button class="btn-ghost" onclick="editLastAPI()">âœï¸ Ø§ØµÙ„Ø§Ø­ Ø¢Ø®Ø±ÛŒÙ† Ù‚ÛŒÙ…Øª API</button>

      <div style="flex:1"></div>

      <div style="min-width:220px">
        <label>API Ú©Ù„ÛŒØ¯ Ø¨Ø±Ø§ÛŒ RSI (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
        <div class="input-inline"><input id="rsiApiKey" type="text" placeholder="Ù…Ø«Ø§Ù„: ALPHAVANTAGE_KEY"><button class="btn-ghost" onclick="saveRSIKey()">Ø°Ø®ÛŒØ±Ù‡</button></div>
        <div class="small-muted" style="margin-top:6px">Ø§Ú¯Ø± ÙˆØ§Ø±Ø¯ Ù†Ø´ÙˆØ¯ØŒ RSI Ø§Ø² ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ ÛŒØ§ Ø§Ø² endpoint Ø³Ø±ÙˆØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.</div>
      </div>
    </div>

    <div class="hr"></div>
    <div class="result" id="goldResult">ÙˆØ¶Ø¹ÛŒØª: Ø¢Ù…Ø§Ø¯Ù‡</div>
    <div class="kv" style="margin-top:8px"><div class="small-muted">ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª API Ø§Ù…Ø±ÙˆØ²</div><div id="apiCounter">0</div></div>
  </div>

  <!-- Ø¨Ù‚ÛŒÙ‡ UI Ø¨Ù‡ Ø´Ú©Ù„ Ù‚Ø¨Ù„... (Ø¨Ø±Ø§ÛŒ Ø§Ø®ØªØµØ§Ø± Ø¯Ø± ÙØ§ÛŒÙ„ ÙˆØ§Ù‚Ø¹ÛŒ Ù‡Ù…Ù‡Ù” Ø¨Ø®Ø´â€ŒÙ‡Ø§ Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±Ù†Ø¯) -->

  <div class="footer-small">Ù†Ú©ØªÙ‡ ÙÙ†ÛŒ: Ø³Ø±ÙˆØ± Ù…Ø­Ù„ÛŒ Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ Ùˆ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø±Ø§ Ø¯Ø± Ù¾ÙˆØ´Ù‡Ù” /data Ù†Ú¯Ù‡ Ù…ÛŒâ€ŒØ¯Ø§Ø±Ø¯. Ø¯Ø± ØµÙˆØ±Øª Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…Ø´ØªØ±Ú© Ø±ÙˆÛŒ Ø³Ø±ÙˆØ± ÙˆØ§Ù‚Ø¹ÛŒØŒ Ù…Ø±Ø§Ù‚Ø¨ Ø¯Ø³ØªØ±Ø³ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø¨Ø§Ø´ÛŒØ¯.</div>

</div>

<script>
// Ù†Ø³Ø®Ù‡Ù” JS Ø¨Ù‡â€ŒØ±ÙˆØ² Ø´Ø¯Ù‡ ØªØ§ Ø§Ø² endpointÙ‡Ø§ÛŒ PHP Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†Ø¯
const SERVER_BASE = location.pathname; // Ø§ÛŒÙ† ÙØ§ÛŒÙ„ Ø®ÙˆØ¯Ø´ endpointÙ‡Ø§ Ø±Ø§ Ø³Ø±Ùˆ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
let apiCounter = 0;
let historyData = JSON.parse(localStorage.getItem('goldHistory')) || [];
let signals = JSON.parse(localStorage.getItem('signals')) || [];
let notifyActive = (localStorage.getItem('notifyActive') === '1');
if(notifyActive){ document.getElementById('notifyBtn')?.classList?.add('on'); }

async function getServerCounter(){ try{ const r = await fetch(`${SERVER_BASE}?action=get_counter`); const j = await r.json(); if(j.ok){ apiCounter = j.count; document.getElementById('apiCounter').innerText = apiCounter; } }catch(e){ console.warn(e); } }
getServerCounter();

async function fetchFromAPI(){
  const maxAllowed = parseInt(document.getElementById('maxRequests')?.value)||100;
  if(apiCounter >= maxAllowed){ document.getElementById('goldResult').innerText = `âš  Ø³Ù‚Ù ${maxAllowed} Ø¯Ø±Ø®ÙˆØ§Ø³Øª API Ø§Ù…Ø±ÙˆØ² Ø±Ø³ÛŒØ¯!`; return; }
  try{
    const res = await fetch(`${SERVER_BASE}?action=fetch_brs`);
    const j = await res.json();
    if(!j.ok){ document.getElementById('goldResult').innerText = 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø² Ø³Ø±ÙˆØ±'; return; }
    const data = j.data;
    const goldObj = Array.isArray($data=data.gold)? data.gold.find(i=>i.symbol==='IR_GOLD_18K') : null;
    const xauObj = Array.isArray(data.gold)? data.gold.find(i=>i.symbol==='XAUUSD') : null;
    const usdObj = Array.isArray(data.currency)? data.currency.find(i=>i.symbol==='USD') : null;
    const gold18 = goldObj ? parseFloat(goldObj.price) : null;
    const ounce = xauObj ? parseFloat(xauObj.price) : null;
    const usd = usdObj ? parseFloat(usdObj.price) : null;
    document.getElementById('gold18').value = gold18 || '';
    document.getElementById('usd').value = usd || '';
    document.getElementById('ounce').value = ounce || '';
    apiCounter = j.counter || apiCounter+1; document.getElementById('apiCounter').innerText = apiCounter;
    document.getElementById('goldResult').innerText = `Ø¢Ø®Ø±ÛŒÙ† Ù‚ÛŒÙ…Øª API: ${gold18 ? gold18.toLocaleString() + ' ØªÙˆÙ…Ø§Ù†' : 'Ù†Ø§Ù…Ø´Ø®Øµ'} â€” Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯...`;
    await addData();
  }catch(err){ console.error(err); document.getElementById('goldResult').innerText = 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡ Ø§Ø² API'; }
}

// function addData, computeRSI client-side Ùˆ Ø¨Ù‚ÛŒÙ‡ ØªÙˆØ§Ø¨Ø¹ Ø±Ø§ Ù…ÛŒØªÙˆØ§Ù†ÛŒØ¯ Ø§Ø² Ù†Ø³Ø®Ù‡Ù” Ù‚Ø¨Ù„ÛŒ Ø®ÙˆØ¯ Ú©Ù¾ÛŒ Ú©Ù†ÛŒØ¯.
// Ø¨Ø±Ø§ÛŒ Ú©ÙˆØªØ§Ù‡ÛŒ Ø¯Ø± Ø§ÛŒÙ† Ù†Ù…ÙˆÙ†Ù‡ Ø§Ø² Ù‚Ø±Ø§Ø± Ø¯Ø§Ø¯Ù† Ú©Ù„ JS Ø®ÙˆØ¯Ø¯Ø§Ø±ÛŒ Ø´Ø¯Ù‡ Ø§Ø³ØªØ› Ø¯Ø± ÙØ§ÛŒÙ„ ÙˆØ§Ù‚Ø¹ÛŒ Ù‡Ù…Ù‡Ù” ØªÙˆØ§Ø¨Ø¹ (addData, updateChart, autoSignalCheck, startAutoFetch, saveHistoryToServer...) Ø±Ø§ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯.

// Ù†Ù…ÙˆÙ†Ù‡Ù” Ø³Ø§Ø¯Ù‡: Ø§Ø±Ø³Ø§Ù„ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¨Ù‡ Ø³Ø±ÙˆØ±
async function saveHistoryToServer(){ try{ await fetch(`${SERVER_BASE}?action=save_history`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(historyData) }); console.log('history saved'); }catch(e){console.warn(e);} }

</script>
</body>
</html>
