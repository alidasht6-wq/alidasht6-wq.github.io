<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù†Ù‡Ø§ÛŒÛŒ Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø± â€” Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ (Ø¨Ø§ AutoFetch Ùˆ Alerts)</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{--bg1:#0f1720;--card:#1f2937;--accent:#ffd369;--muted:#9bd7ff}
*{box-sizing:border-box}
body{margin:0;padding:14px;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:linear-gradient(180deg,var(--bg1),#0b1116);color:#fff}
.container{max-width:980px;margin:0 auto}
.header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
.title{font-size:1.25rem;color:var(--accent);font-weight:700}
.small{font-size:0.85rem;color:#cbd5e1}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:14px;margin-bottom:12px;box-shadow:0 6px 30px rgba(0,0,0,0.6);border:1px solid rgba(255,211,105,0.06)}
.row{display:flex;gap:10px;align-items:center}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
@media(max-width:740px){.grid{grid-template-columns:1fr}}
label{display:block;font-size:0.85rem;margin-bottom:6px;color:#d1d5db}
input[type=number],input[type=text]{width:100%;padding:8px;border-radius:8px;border:none;background:#0b1220;color:#fff}
button{padding:9px 12px;border-radius:10px;border:none;background:var(--accent);color:#000;font-weight:600;cursor:pointer}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff}
.result{background:#071018;padding:10px;border-radius:8px;margin-top:8px;border:1px solid rgba(255,255,255,0.03);font-size:0.95rem}
.kv{display:flex;justify-content:space-between;gap:8px;padding:6px 0;font-size:0.95rem}
.tip{color:var(--muted);font-size:0.88rem;line-height:1.45}
.footer-small{font-size:0.82rem;color:#94a3b8;margin-top:8px}
.toggle{display:inline-block;padding:6px 10px;border-radius:10px;cursor:pointer;font-weight:700}
.toggle.on{background:#16a34a;color:#fff}
.toggle.off{background:#ef4444;color:#fff}
.signals-list{max-height:160px;overflow:auto;margin-top:8px;border-radius:8px;padding:8px;border:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent)}
.signal-item{padding:6px;border-bottom:1px dashed rgba(255,255,255,0.03);font-size:0.9rem}
.canvas-wrap{background:#06121a;padding:8px;border-radius:10px;margin-top:8px}
.legend{display:flex;gap:8px;align-items:center;margin-top:8px}
.legend .dot{width:12px;height:12px;border-radius:3px;display:inline-block}
.entry-dot{background:#16a34a}
.exit-dot{background:#ef4444}
.hr{height:1px;background:rgba(255,255,255,0.03);margin:12px 0;border-radius:2px}
.small-muted{color:#94a3b8;font-size:0.85rem}
.input-inline{display:flex;gap:8px}
.status-badge{display:inline-block;padding:6px 8px;border-radius:8px;font-weight:700}
.status-normal{background:#374151;color:#fff}
.status-high{background:#065f46;color:#fff}
.status-low{background:#7f1d1d;color:#fff}
.counter-box{display:flex;gap:12px;align-items:center}
.counter-box div{min-width:120px}
</style>
</head>
<body>
<div class="container">
  <!-- ... Ù…Ø­ØªÙˆÛŒØ§Øª UI Ù‡Ù…Ø§Ù†Ù†Ø¯ Ù‚Ø¨Ù„ ... -->
  <!-- Ø¨Ø®Ø´ AutoFetch Ùˆ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¢Ù† -->
  <div class="card">
    <h3 style="margin:0 0 8px;color:var(--accent)">ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø®ÙˆØ¯Ú©Ø§Ø± API Ùˆ Ù‡Ø´Ø¯Ø§Ø± Ù‚ÛŒÙ…Øª</h3>
    <div class="grid">
      <div>
        <label>Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú©Ù„ Ø¯Ø± Ø¨Ø§Ø²Ù‡ 18:00â€“22:00 (Ø­Ø¯Ø§Ú©Ø«Ø± 1500)</label>
        <input id="maxRequests" type="number" value="100" min="1" max="1500">
      </div>
      <div>
        <label>Ø§Ø¬Ø±Ø§ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±ØŸ</label>
        <div style="display:flex;gap:8px"><button onclick="startAutoFetch()">â–¶ Ø´Ø±ÙˆØ¹ Ø¯Ø± 18:00</button><button class="btn-ghost" onclick="stopAutoFetch()">â–  ØªÙˆÙ‚Ù</button></div>
      </div>
      <div>
        <label>Ø­Ø¯ Ù¾Ø§ÛŒÛŒÙ† Ù‡Ø´Ø¯Ø§Ø± (ØªÙˆÙ…Ø§Ù†)</label>
        <input id="lowLimit" type="number" placeholder="Ù…Ø«Ø§Ù„: 12000000">
      </div>
      <div>
        <label>Ø­Ø¯ Ø¨Ø§Ù„Ø§ Ù‡Ø´Ø¯Ø§Ø± (ØªÙˆÙ…Ø§Ù†)</label>
        <input id="highLimit" type="number" placeholder="Ù…Ø«Ø§Ù„: 18000000">
      </div>
    </div>

    <div class="hr"></div>
    <div class="counter-box">
      <div>Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡: <strong id="doneCount">0</strong></div>
      <div>Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: <strong id="leftCount">0</strong></div>
      <div>Ø¨Ø¹Ø¯ÛŒ Ø¯Ø±: <strong id="nextIn">â€”</strong> Ø«Ø§Ù†ÛŒÙ‡</div>
    </div>
    <div class="small-muted" style="margin-top:8px">ØªØ°Ú©Ø±: Ø§Ú¯Ø± ØµÙØ­Ù‡ Ø±Ø§ Ø¨Ø¨Ù†Ø¯ÛŒ Ø§Ø¬Ø±Ø§ Ù‚Ø·Ø¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
  </div>

</div>

<script>
// -------------------------
// ØªÙ†Ø¸ÛŒÙ… Ø§ÙˆÙ„ÛŒÙ‡ Ùˆ Ù…ØªØºÛŒØ±Ù‡Ø§
// -------------------------
const BRS_URL = "https://brsapi.ir/Api/Market/Gold_Currency.php?key=BBzNUXWfiBpUmeXusfw4mkbjXuXjj9nU";
let apiCounter = parseInt(localStorage.getItem('apiCounter')) || 0;
let historyData = JSON.parse(localStorage.getItem('goldHistory')) || [];
let signals = JSON.parse(localStorage.getItem('signals')) || [];
let notifyActive = (localStorage.getItem('notifyActive') === '1');
if(notifyActive){ document.getElementById('notifyBtn')?.classList?.add('on'); document.getElementById('notifyBtn')?.classList?.remove('off'); document.getElementById('notifyBtn').innerText='ğŸ”” Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø±ÙˆØ´Ù†'; }
document.getElementById('apiCounter')?.innerText = apiCounter;

// AutoFetch state
let autoState = { running:false, timerId:null, countdownId:null, nextAt: null, done:0, left:0 };

// -------------------------
// AutoFetch Ø§ØµÙ„Ø§Ø­â€ŒØ´Ø¯Ù‡
// -------------------------
function startAutoFetch(){
  if(autoState.running){ alert('AutoFetch Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§Ø³Øª'); return; }
  const maxReq = parseInt(document.getElementById('maxRequests').value) || 100;
  if(maxReq < 1 || maxReq > 1500){ alert('Ø­Ø¯Ø§Ú©Ø«Ø± Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† 1 Ùˆ 1500 Ø¨Ø§Ø´Ø¯'); return; }

  const now = new Date();
  const startHour = 18, endHour = 22;
  const windowSeconds = (endHour - startHour) * 3600;
  let remainingRequests = Math.max(0, maxReq - apiCounter);
  if(remainingRequests === 0){
    document.getElementById('goldResult').innerText = `âš  Ø³Ù‚Ù ${maxReq} Ø¯Ø±Ø®ÙˆØ§Ø³Øª API Ø§Ù…Ø±ÙˆØ² Ø±Ø³ÛŒØ¯!`;
    return;
  }
  let intervalSec = Math.floor(windowSeconds / remainingRequests);
  if(intervalSec < 3) intervalSec = 3;

  autoState.running = true;
  autoState.done = 0;
  autoState.left = remainingRequests;
  document.getElementById('doneCount').innerText = autoState.done;
  document.getElementById('leftCount').innerText = autoState.left;

  function scheduleNext(){
    const now = new Date();
    const hour = now.getHours();
    let nextDelay = 0;

    if(hour >= startHour && hour < endHour){ nextDelay = 0; }
    else {
      const nextStart = new Date(now);
      nextStart.setHours(startHour,0,0,0);
      if(now >= nextStart) nextStart.setDate(nextStart.getDate() + 1);
      nextDelay = Math.floor((nextStart - now)/1000);
    }

    if(nextDelay > 0){
      document.getElementById('nextIn').innerText = nextDelay;
      autoState.countdownId = setInterval(()=>{
        nextDelay -= 1;
        document.getElementById('nextIn').innerText = nextDelay;
        if(nextDelay <= 0){
          clearInterval(autoState.countdownId);
          beginLoop();
        }
      },1000);
    } else { beginLoop(); }
  }

  function beginLoop(){
    autoState.nextAt = Date.now() + intervalSec*1000;
    autoState.timerId = setInterval(async ()=>{
      const now = new Date();
      const hour = now.getHours();
      if(hour >= startHour && hour < endHour){
        if(apiCounter >= maxReq){ stopAutoFetch(); return; }
        await fetchFromAPI();
        autoState.done += 1;
        autoState.left = Math.max(0, maxReq - apiCounter);
        document.getElementById('doneCount').innerText = autoState.done;
        document.getElementById('leftCount').innerText = autoState.left;
        autoState.nextAt = Date.now() + intervalSec*1000;
      } else { stopAutoFetch(); }
    }, intervalSec * 1000);

    autoState.countdownId = setInterval(()=>{
      if(!autoState.nextAt) return;
      const s = Math.max(0, Math.ceil((autoState.nextAt - Date.now())/1000));
      document.getElementById('nextIn').innerText = s;
    }, 500);
  }

  scheduleNext();
  document.getElementById('goldResult').innerText = 'AutoFetch Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ Ø´Ø¯Ø› Ù…Ù†ØªØ¸Ø± Ø´Ø±ÙˆØ¹ ÛŒØ§ Ø§Ø¬Ø±Ø§ÛŒ Ø¢Ù† Ø¨Ø§Ø´ÛŒØ¯.';
}

function stopAutoFetch(){
  if(autoState.timerId) clearInterval(autoState.timerId);
  if(autoState.countdownId) clearInterval(autoState.countdownId);
  autoState.running = false;
  autoState.timerId = null;
  autoState.countdownId = null;
  autoState.nextAt = null;
  document.getElementById('nextIn').innerText = 'â€”';
  document.getElementById('doneCount').innerText = '0';
  document.getElementById('leftCount').innerText = '0';
  document.getElementById('goldResult').innerText = 'AutoFetch Ù…ØªÙˆÙ‚Ù Ø´Ø¯.';
}
</script>
</body>
</html>
