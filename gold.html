<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù†ÙˆØ³Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø± â€” Ø¹Ù…Ù„ÛŒØ§ØªÛŒ</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{--bg:#071016;--card:#0f1720;--accent:#ffd369}
body{margin:0;padding:14px;font-family:system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--bg),#051019);color:#e6eef8}
.container{max-width:1100px;margin:0 auto}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.title{color:var(--accent);font-weight:800}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.005));border-radius:10px;padding:12px;margin-bottom:12px;border:1px solid rgba(255,211,105,0.04)}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
@media(max-width:780px){.grid{grid-template-columns:1fr}}
input,select{width:100%;padding:8px;border-radius:8px;border:none;background:#07121a;color:#fff}
button{padding:8px 12px;border-radius:8px;border:none;background:var(--accent);font-weight:700;cursor:pointer}
.small{color:#9fbcd9;font-size:13px}
.toggle{padding:6px 10px;border-radius:8px;cursor:pointer;font-weight:700}
.toggle.on{background:#16a34a;color:#fff}
.toggle.off{background:#ef4444;color:#fff}
.result{background:#06121a;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);margin-top:8px}
.time-btn{padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);cursor:pointer;background:transparent;color:#fff}
.time-btn.active{background:#16a34a;color:#fff;border-color:#16a34a}
.canvas-wrap{background:#05121a;padding:8px;border-radius:8px;margin-top:8px}
.signals-list{max-height:180px;overflow:auto;padding:6px;border-radius:6px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent)}
.signal-item{padding:6px;border-bottom:1px dashed rgba(255,255,255,0.03)}
.counter{display:flex;gap:12px;align-items:center}
.counter div{min-width:140px}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div>
      <div class="title">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù†ÙˆØ³Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ â€” Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø±</div>
      <div class="small">ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡ â€” AutoFetch Ø¯Ù‚ÛŒÙ‚ â€” RSI (AlphaVantage ÛŒØ§ Ù…Ø­Ù„ÛŒ)</div>
    </div>
    <div class="small">Ù†ÙˆØ§ Ø¬ÙˆÙ† â€” Ù†Ø³Ø®Ù‡ Ø¹Ù…Ù„ÛŒØ§ØªÛŒ</div>
  </div>

  <!-- Ø±Ø§Ù‡Ù†Ù…Ø§ -->
  <div class="card">
    <strong>Ø±Ø§Ù‡Ù†Ù…Ø§ (Ù†Ú©Ø§Øª Ù…Ù‡Ù…)</strong>
    <ul class="small">
      <li>Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù…Ù†Ø§Ø³Ø¨ Ù†ÙˆØ³Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ: Ø´Ù†Ø¨Ù‡ ØªØ§ Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡ (Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡ Ù…Ù†Ø§Ø³Ø¨â€ŒØªØ±ÛŒÙ†).</li>
      <li>Ø¨Ø§Ø²Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ: 10:30â€“12:00 Ùˆ 18:00â€“22:00. ÛŒØ§ Ø²Ù…Ø§Ù† Ø¢Ø²Ø§Ø¯ (Free run).</li>
      <li>Ø¯Ø± AutoFetch ÙˆÙ‚ØªÛŒ Ø¨Ø§Ø²Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ø´ÙˆØ¯ØŒ Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡Ù” Ø¨Ø§Ø²Ù‡ ØªÙ‚Ø³ÛŒÙ… Ø¨Ø± ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.</li>
      <li>Ø§Ú¯Ø± Ú©Ù„ÛŒØ¯ AlphaVantage ÙˆØ§Ø±Ø¯ Ù†Ø´ÙˆØ¯ ÛŒØ§ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø±Ø® Ø¯Ù‡Ø¯ØŒ RSI Ø§Ø² ØªØ§Ø±ÛŒØ®Ú†Ù‡Ù” Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</li>
    </ul>
  </div>

  <!-- Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ø§Ø²Ù‡ -->
  <div class="card">
    <strong>Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ø§Ø²Ù‡</strong>
    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
      <button id="btnMorning" class="time-btn" onclick="selectTime('morning', this)">10:30â€“12:00</button>
      <button id="btnEvening" class="time-btn" onclick="selectTime('evening', this)">18:00â€“22:00</button>
      <button id="btnFree" class="time-btn" onclick="selectTime('free', this)">Ø²Ù…Ø§Ù† Ø¢Ø²Ø§Ø¯</button>
    </div>
  </div>

  <!-- ÙˆØ±ÙˆØ¯ÛŒ -->
  <div class="card">
    <strong>ÙˆØ±ÙˆØ¯ÛŒ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§</strong>
    <div class="grid" style="margin-top:8px">
      <div>
        <label class="small">Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø± (ØªÙˆÙ…Ø§Ù†)</label>
        <input id="gold18" type="number" placeholder="Ù…Ø«Ø§Ù„: 12679000">
      </div>
      <div>
        <label class="small">Ø¯Ù„Ø§Ø± (ØªÙˆÙ…Ø§Ù†)</label>
        <input id="usd" type="number" placeholder="Ù…Ø«Ø§Ù„: 125000">
      </div>
      <div>
        <label class="small">Ø§Ù†Ø³ Ø¬Ù‡Ø§Ù†ÛŒ (Ø¯Ù„Ø§Ø±)</label>
        <input id="ounce" type="number" placeholder="Ù…Ø«Ø§Ù„: 1960.12">
      </div>
      <div>
        <label class="small">Ø§Ø¬Ø±Øª+Ù…Ø§Ù„ÛŒØ§Øª+Ø³ÙˆØ¯ (%)</label>
        <input id="fee" type="number" placeholder="Ù…Ø«Ø§Ù„: 1.2">
      </div>
    </div>

    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
      <button onclick="onAddManual()">Ø«Ø¨Øª Ø¯Ø³ØªÛŒ</button>
      <button onclick="onFetchOnce()">ğŸ“¡ Ø¯Ø±ÛŒØ§ÙØª Ù‡Ù…â€ŒØ²Ù…Ø§Ù† (API)</button>
      <button onclick="onEditLast()">âœï¸ Ø§ØµÙ„Ø§Ø­ Ø¢Ø®Ø±ÛŒÙ†</button>
      <button onclick="onClearLast()">âŒ Ø­Ø°Ù Ø¢Ø®Ø±ÛŒÙ†</button>
      <button onclick="onClearAll()">ğŸ—‘ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„</button>

      <div style="flex:1"></div>

      <div style="min-width:260px">
        <label class="small">Ú©Ù„ÛŒØ¯ RSI (AlphaVantage) â€” Ø§Ø®ØªÛŒØ§Ø±ÛŒ</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="rsiKey" type="text" placeholder="ALPHAVANTAGE_KEY">
          <button class="btn-ghost" onclick="saveRsiKey()">Ø°Ø®ÛŒØ±Ù‡</button>
        </div>
        <div class="small" style="margin-top:6px">Ø§Ú¯Ø± Ú©Ù„ÛŒØ¯ ÙˆØ§Ø±Ø¯ Ù†Ø´ÙˆØ¯ØŒ RSI Ù…Ø­Ù„ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
      </div>
    </div>

    <div class="result" id="lastStatus">ÙˆØ¶Ø¹ÛŒØª: Ø¢Ù…Ø§Ø¯Ù‡</div>
  </div>

  <!-- AutoFetch -->
  <div class="card">
    <strong>AutoFetch & Alerts</strong>
    <div class="grid" style="margin-top:8px">
      <div>
        <label class="small">ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø± Ø¨Ø§Ø²Ù‡</label>
        <input id="maxReq" type="number" value="100" min="1" max="1500">
      </div>
      <div>
        <label class="small">Ø§Ø¬Ø±Ø§ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±</label>
        <div style="display:flex;gap:8px;margin-top:6px">
          <button onclick="startAuto()">â–¶ Ø´Ø±ÙˆØ¹</button>
          <button class="btn-ghost" onclick="stopAuto()">â–  ØªÙˆÙ‚Ù</button>
        </div>
      </div>
      <div>
        <label class="small">Ø­Ø¯ Ù¾Ø§ÛŒÛŒÙ† Ù‡Ø´Ø¯Ø§Ø± (ØªÙˆÙ…Ø§Ù†)</label>
        <input id="lowLimit" type="number" placeholder="Ù…Ø«Ø§Ù„: 12000000">
      </div>
      <div>
        <label class="small">Ø­Ø¯ Ø¨Ø§Ù„Ø§ Ù‡Ø´Ø¯Ø§Ø± (ØªÙˆÙ…Ø§Ù†)</label>
        <input id="highLimit" type="number" placeholder="Ù…Ø«Ø§Ù„: 18000000">
      </div>
    </div>

    <div style="margin-top:10px" class="counter">
      <div>Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡: <strong id="doneCount">0</strong></div>
      <div>Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: <strong id="leftCount">0</strong></div>
      <div>Ø¨Ø¹Ø¯ÛŒ Ø¯Ø±: <strong id="nextIn">â€”</strong></div>
    </div>
  </div>

  <!-- Ù†Ù…ÙˆØ¯Ø§Ø± -->
  <div class="card">
    <strong>Ù†Ù…ÙˆØ¯Ø§Ø± Ø­Ø¨Ø§Ø¨ Ùˆ RSI</strong>
    <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
      <button onclick="onSignal()">ğŸ” Ø¯Ø±ÛŒØ§ÙØª Ø³ÛŒÚ¯Ù†Ø§Ù„</button>
      <div style="flex:1"></div>
      <button id="notifyBtn" class="toggle off" onclick="toggleNotify()">ğŸ”” Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø®Ø§Ù…ÙˆØ´</button>
    </div>

    <div class="canvas-wrap">
      <canvas id="chart" style="width:100%;height:360px"></canvas>
    </div>

    <div style="margin-top:10px" class="signals-list" id="signals"></div>

    <div class="result" id="signalBox">Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.</div>
  </div>

</div>

<script>
/* --------- ØªÙ†Ø¸ÛŒÙ… Ø§ÙˆÙ„ÛŒÙ‡ Ùˆ Ù…ØªØºÛŒØ±Ù‡Ø§ --------- */
const GOLD_API = "https://brsapi.ir/Api/Market/Gold_Currency.php?key=BBzNUXWfiBpUmeXusfw4mkbjXuXjj9nU";
let historyData = JSON.parse(localStorage.getItem('goldHistory') || '[]');
let signals = JSON.parse(localStorage.getItem('signals') || '[]');
let apiCounter = parseInt(localStorage.getItem('apiCounter') || '0');
let notifyActive = localStorage.getItem('notifyActive') === '1';
let auto = { running:false, timerId:null, nextAt:null, done:0, left:0, countdownId:null, intervalSec:0 };
let selectedRange = 'free'; // 'morning','evening','free'

const chartCtx = document.getElementById('chart').getContext('2d');
const chart = new Chart(chartCtx, {
  type:'line',
  data:{ labels:[], datasets:[
    { label:'Ø­Ø¨Ø§Ø¨ (ØªÙˆÙ…Ø§Ù†)', data:[], borderColor:'#60a5fa', backgroundColor:'rgba(96,165,250,0.12)', fill:true, tension:0.3, pointRadius:5, pointBackgroundColor:[] },
    { label:'Ø­Ù…Ø§ÛŒØª', data:[], borderColor:'#10b981', borderDash:[6,4], fill:false, pointRadius:0 },
    { label:'Ù…Ù‚Ø§ÙˆÙ…Øª', data:[], borderColor:'#ef4444', borderDash:[6,4], fill:false, pointRadius:0 },
    { label:'RSI', data:[], borderColor:'#f472b6', fill:false, yAxisID:'rsi' }
  ]},
  options:{
    responsive:true,
    interaction:{mode:'index',intersect:false},
    scales:{ y:{position:'left'}, rsi:{position:'right', min:0, max:100} },
    plugins:{legend:{labels:{boxWidth:12}}}
  }
});

/* --------- Ú©Ù…Ú©ÛŒâ€ŒÙ‡Ø§ --------- */
function saveAll(){
  localStorage.setItem('goldHistory', JSON.stringify(historyData));
  localStorage.setItem('signals', JSON.stringify(signals));
  localStorage.setItem('apiCounter', String(apiCounter));
  localStorage.setItem('notifyActive', notifyActive ? '1' : '0');
}

function formatNumber(n){ if(n===null||n===undefined||isNaN(n)) return 'â€”'; return Number(n).toLocaleString(); }

function computeAvg(data, price){ const days=5; const arr=data.slice(-days).map(d=>d.price); arr.push(price); const s=arr.reduce((a,b)=>a+b,0); return s/arr.length; }

function computeRSI_local(prices, period=14){
  if(prices.length < period+1) return 50;
  let gains=0, losses=0;
  for(let i=prices.length-period;i<prices.length;i++){
    const d = prices[i]-prices[i-1];
    if(d>0) gains += d; else losses += Math.abs(d);
  }
  if(losses===0) return 100;
  const rs = gains/losses;
  return 100 - (100/(1+rs));
}

async function fetchRSI_external(symbol='XAUUSD'){
  const key = localStorage.getItem('rsiKey') || document.getElementById('rsiKey').value.trim();
  if(!key) return null;
  try{
    const url = `https://www.alphavantage.co/query?function=RSI&symbol=${symbol}&interval=daily&time_period=14&series_type=close&apikey=${key}`;
    const r = await fetch(url);
    const j = await r.json();
    if(j['Technical Analysis: RSI']){
      const k = Object.keys(j['Technical Analysis: RSI'])[0];
      return parseFloat(j['Technical Analysis: RSI'][k]['RSI']);
    }
    return null;
  }catch(e){ console.warn('RSI fetch err', e); return null; }
}

function pushSignal(type, text){
  const now = new Date().toLocaleString();
  signals.unshift({type, text, ts: now});
  if(signals.length>50) signals = signals.slice(0,50);
  saveAll(); renderSignals();
}

function renderSignals(){
  const el = document.getElementById('signals');
  el.innerHTML = '';
  if(signals.length===0){ el.innerHTML = '<div class="small">Ù‡Ù†ÙˆØ² Ø³ÛŒÚ¯Ù†Ø§Ù„ÛŒ ØµØ§Ø¯Ø± Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</div>'; return; }
  signals.forEach(s=>{
    const d = document.createElement('div');
    d.className = 'signal-item';
    d.innerHTML = `<strong>[${s.type}]</strong> ${s.text} <div class="small" style="margin-top:6px">${s.ts}</div>`;
    el.appendChild(d);
  });
}

function updateChart(){
  chart.data.labels = historyData.map((_,i)=>i+1);
  chart.data.datasets[0].data = historyData.map(h=>h.bubble);
  chart.data.datasets[1].data = historyData.map(h=>h.avg*0.985);
  chart.data.datasets[2].data = historyData.map(h=>h.avg*1.015);
  chart.data.datasets[3].data = historyData.map(h=>h.rsi);
  chart.data.datasets[0].pointBackgroundColor = historyData.map(h => h.signal==='entry' ? '#16a34a' : (h.signal==='exit' ? '#ef4444' : '#60a5fa'));
  chart.update();
}

/* --------- Ø¹Ù…Ù„ÛŒØ§Øª Ø¯Ø³ØªÛŒ Ùˆ API --------- */
function onAddManual(){
  const gold = parseFloat(document.getElementById('gold18').value);
  const usd = parseFloat(document.getElementById('usd').value);
  const ounce = parseFloat(document.getElementById('ounce').value);
  const fee = parseFloat(document.getElementById('fee').value) || 0;
  if((!gold || gold<=0) && (!usd || !ounce)){
    document.getElementById('lastStatus').innerText = 'Ù„Ø·ÙØ§Ù‹ ÛŒØ§ Ù‚ÛŒÙ…Øª Ø·Ù„Ø§ÛŒ Û±Û¸ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø¯Ù„Ø§Ø± Ùˆ Ø§Ù†Ø³ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯.';
    return;
  }
  const price = gold && gold>0 ? gold : ((ounce * usd)/31.1035) * (1 + fee/100);
  const avg = historyData.length ? computeAvg(historyData, price) : price;
  const bubble = price - avg;
  const prices = historyData.map(h=>h.price).concat([price]);
  const rsiLocal = computeRSI_local(prices, 14);
  historyData.push({price, usd, ounce, fee, avg, bubble, rsi: rsiLocal, signal: null, ts: Date.now()});
  saveAll();
  updateChart();
  document.getElementById('lastStatus').innerText = `Ø«Ø¨Øª Ø¯Ø³ØªÛŒ: ${formatNumber(price)} ØªÙˆÙ…Ø§Ù† â€” Ø­Ø¨Ø§Ø¨: ${Math.round(bubble)} â€” RSI: ${rsiLocal.toFixed(2)}`;
}

async function onFetchOnce(){
  document.getElementById('lastStatus').innerText = 'Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...';
  try{
    const res = await fetch(GOLD_API);
    const j = await res.json();
    // BRS API structure handling (robust)
    let gold = null, usd = null, ounce = null;
    if(Array.isArray(j.gold)){
      const goldObj = j.gold.find(x => x.symbol && x.symbol.includes('IR_GOLD_18K')) || j.gold.find(x=>x.symbol==='IR_GOLD_18K');
      const xau = j.gold.find(x => x.symbol && x.symbol.includes('XAUUSD')) || j.gold.find(x=>x.symbol==='XAUUSD');
      if(goldObj) gold = parseFloat(goldObj.price);
      if(xau) ounce = parseFloat(xau.price);
    }
    if(Array.isArray(j.currency)){
      const usdObj = j.currency.find(x => x.symbol && x.symbol.includes('USD')) || j.currency.find(x=>x.symbol==='USD');
      if(usdObj) usd = parseFloat(usdObj.price);
    }
    // fallback if keys differ
    if(!gold && j.Gold18) gold = parseFloat(j.Gold18);
    if(!usd && j.USD) usd = parseFloat(j.USD);
    if(!ounce && j.Ounce) ounce = parseFloat(j.Ounce);

    // show values
    if(gold) document.getElementById('gold18').value = gold;
    if(usd) document.getElementById('usd').value = usd;
    if(ounce) document.getElementById('ounce').value = ounce;

    // compute final price and RSI
    const fee = parseFloat(document.getElementById('fee').value) || 0;
    const price = gold ? gold : ((ounce * usd)/31.1035) * (1 + fee/100);
    const avg = historyData.length ? computeAvg(historyData, price) : price;
    const bubble = price - avg;

    // try external RSI
    let rsi = await fetchRSI_external();
    if(rsi === null) rsi = computeRSI_local(historyData.map(h=>h.price).concat([price]), 14);

    // decide signal
    let signal = null;
    const lowLimit = parseFloat(document.getElementById('lowLimit').value) || null;
    const highLimit = parseFloat(document.getElementById('highLimit').value) || null;
    if((lowLimit && price <= lowLimit) || rsi <= 30) { signal = 'entry'; pushSignal('ÙˆØ±ÙˆØ¯', `Ù‚ÛŒÙ…Øª ${formatNumber(price)} â€” RSI ${rsi.toFixed(2)}`); playSound(); notify(`Ø³ÛŒÚ¯Ù†Ø§Ù„ ÙˆØ±ÙˆØ¯ â€” ${formatNumber(price)}`); }
    else if((highLimit && price >= highLimit) || rsi >= 70) { signal = 'exit'; pushSignal('Ø®Ø±ÙˆØ¬', `Ù‚ÛŒÙ…Øª ${formatNumber(price)} â€” RSI ${rsi.toFixed(2)}`); playSound(); notify(`Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø®Ø±ÙˆØ¬ â€” ${formatNumber(price)}`); }

    historyData.push({price, usd, ounce, fee, avg, bubble, rsi, signal, ts: Date.now()});
    apiCounter++;
    saveAll();
    updateChart();
    document.getElementById('lastStatus').innerText = `API Ø«Ø¨Øª Ø´Ø¯: ${formatNumber(price)} ØªÙˆÙ…Ø§Ù† | Ø­Ø¨Ø§Ø¨: ${Math.round(bubble)} | RSI: ${rsi.toFixed(2)}`;
    document.getElementById('doneCount').innerText = auto.done || 0;
    document.getElementById('leftCount').innerText = Math.max(0, (parseInt(document.getElementById('maxReq').value)||1) - apiCounter);
  }catch(e){
    console.error(e);
    document.getElementById('lastStatus').innerText = 'Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª API';
  }
}

function onEditLast(){
  if(historyData.length===0){ alert('Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ØµÙ„Ø§Ø­ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯'); return; }
  const last = historyData[historyData.length-1];
  const newVal = prompt('Ù‚ÛŒÙ…Øª Ø¬Ø¯ÛŒØ¯ (ØªÙˆÙ…Ø§Ù†):', String(last.price));
  if(!newVal) return;
  const p = parseFloat(newVal);
  if(isNaN(p)){ alert('Ù‚ÛŒÙ…Øª Ù†Ø§Ù…Ø¹ØªØ¨Ø±'); return; }
  last.price = p;
  last.avg = computeAvg(historyData.slice(0,-1), p);
  last.bubble = p - last.avg;
  last.rsi = computeRSI_local(historyData.map(h=>h.price),14);
  saveAll(); updateChart();
  document.getElementById('lastStatus').innerText = `Ø§ØµÙ„Ø§Ø­ Ø´Ø¯: ${formatNumber(p)}`;
}

function onClearLast(){
  if(!confirm('Ø¢ÛŒØ§ Ø¢Ø®Ø±ÛŒÙ† Ø¯Ø§Ø¯Ù‡ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
  historyData.pop(); saveAll(); updateChart();
  document.getElementById('lastStatus').innerText = 'Ø¢Ø®Ø±ÛŒÙ† Ø¯Ø§Ø¯Ù‡ Ø­Ø°Ù Ø´Ø¯';
}

function onClearAll(){
  if(!confirm('Ø¢ÛŒØ§ ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø´ÙˆÙ†Ø¯ØŸ')) return;
  historyData = []; signals = []; apiCounter = 0; saveAll(); updateChart(); renderSignals();
  document.getElementById('lastStatus').innerText = 'Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø´Ø¯';
}

/* --------- Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ø§Ø²Ù‡â€ŒÙ‡Ø§ (Ø¯Ú©Ù…Ù‡ Ø±Ù†Ú¯ÛŒ) --------- */
function selectTime(which, btn){
  selectedRange = which;
  ['btnMorning','btnEvening','btnFree'].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.classList.remove('active');
  });
  btn.classList.add('active');
}

/* --------- AutoFetch logic --------- */
function secondsUntil(hm){ // hm like "18:00" or 'free'
  if(hm==='free') return 0;
  const [hh,mm] = hm.split(':').map(Number);
  const now = new Date();
  const target = new Date(now);
  target.setHours(hh,mm,0,0);
  return Math.max(0, Math.floor((target - now)/1000));
}
function getWindowRange(){
  if(selectedRange === 'morning') return {start:'10:30', end:'12:00'};
  if(selectedRange === 'evening') return {start:'18:00', end:'22:00'};
  return {start:'00:00', end:'23:59'}; // free -> whole day
}

function startAuto(){
  if(auto.running){ alert('AutoFetch Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§Ø³Øª'); return; }
  const maxReq = parseInt(document.getElementById('maxReq').value) || 100;
  const windowRange = getWindowRange();
  const now = new Date();

  // compute startTime and endTime Date objects
  const [sh, sm] = windowRange.start.split(':').map(Number);
  const [eh, em] = windowRange.end.split(':').map(Number);
  let start = new Date(now); start.setHours(sh, sm, 0, 0);
  let end = new Date(now); end.setHours(eh, em, 0, 0);
  if(windowRange.start === '00:00' && windowRange.end === '23:59'){ start = now; end = new Date(now.getTime() + 24*3600*1000); }
  if(end <= start) end.setDate(end.getDate() + 1);

  let remainingSec = Math.floor((end - Math.max(now, start))/1000);
  if(remainingSec <= 0){
    alert('Ø¨Ø§Ø²Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ ØªÙ…Ø§Ù… Ø´Ø¯Ù‡ ÛŒØ§ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ø¨Ø§Ø²Ù‡Ù” Ø¯ÛŒÚ¯Ø±ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø²Ù…Ø§Ù† Ø¢Ø²Ø§Ø¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.');
    return;
  }

  // compute how many requests left for today
  let requestsLeft = Math.max(0, (maxReq - apiCounter));
  if(requestsLeft <= 0){ alert('Ø³Ù‚Ù Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ù…Ø±ÙˆØ² Ø±Ø³ÛŒØ¯Ù‡.'); return; }

  // interval seconds (at least 3s)
  let intervalSec = Math.floor(remainingSec / requestsLeft);
  if(intervalSec < 3) intervalSec = 3;

  auto.running = true;
  auto.done = 0;
  auto.left = requestsLeft;
  auto.intervalSec = intervalSec;

  document.getElementById('doneCount').innerText = auto.done;
  document.getElementById('leftCount').innerText = auto.left;

  // if now < start, wait until start
  const wait = Math.max(0, Math.floor((start - now)/1000));
  if(wait > 0){
    document.getElementById('nextIn').innerText = `${wait}s (Ø´Ø±ÙˆØ¹ ØªØ§ ${windowRange.start})`;
    auto.countdownId = setInterval(()=>{
      const rem = Math.max(0, Math.floor((start - Date.now())/1000));
      document.getElementById('nextIn').innerText = rem > 0 ? `${rem}s ØªØ§ Ø´Ø±ÙˆØ¹` : 'Ø´Ø±ÙˆØ¹...';
      if(rem<=0){ clearInterval(auto.countdownId); runAutoLoop(intervalSec, end); }
    }, 1000);
  } else {
    runAutoLoop(intervalSec, end);
  }
}

function runAutoLoop(intervalSec, endTime){
  // immediate first run
  (async function step(){
    if(!auto.running) return;
    if(apiCounter >= parseInt(document.getElementById('maxReq').value || '1')){ stopAuto(); return; }
    const now = new Date();
    if(now >= endTime){ stopAuto(); return; }
    await onFetchOnce();
    auto.done++; auto.left = Math.max(0, (parseInt(document.getElementById('maxReq').value || '1') - apiCounter));
    document.getElementById('doneCount').innerText = auto.done;
    document.getElementById('leftCount').innerText = auto.left;
    auto.nextAt = Date.now() + intervalSec*1000;
    document.getElementById('nextIn').innerText = `${intervalSec}s`;

    auto.timerId = setTimeout(async function loop(){
      if(!auto.running) return;
      const now2 = new Date();
      if(now2 >= endTime){ stopAuto(); return; }
      await onFetchOnce();
      auto.done++; auto.left = Math.max(0, (parseInt(document.getElementById('maxReq').value || '1') - apiCounter));
      document.getElementById('doneCount').innerText = auto.done;
      document.getElementById('leftCount').innerText = auto.left;
      auto.nextAt = Date.now() + intervalSec*1000;
      // schedule next
      auto.timerId = setTimeout(loop, intervalSec*1000);
    }, intervalSec*1000);
    // countdown display
    if(auto.countdownId) clearInterval(auto.countdownId);
    auto.countdownId = setInterval(()=>{
      if(!auto.nextAt){ document.getElementById('nextIn').innerText = 'â€”'; return; }
      const s = Math.max(0, Math.ceil((auto.nextAt - Date.now())/1000));
      document.getElementById('nextIn').innerText = `${s}s`;
    }, 500);
  })();
}

function stopAuto(){
  auto.running = false;
  if(auto.timerId) clearTimeout(auto.timerId);
  if(auto.countdownId) clearInterval(auto.countdownId);
  auto.timerId = null; auto.countdownId = null; auto.nextAt = null; auto.done = 0; auto.left = 0;
  document.getElementById('nextIn').innerText = 'â€”';
  document.getElementById('doneCount').innerText = '0';
  document.getElementById('leftCount').innerText = '0';
}

/* --------- Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø¯Ø³ØªÛŒ --------- */
function onSignal(){
  if(historyData.length===0){ alert('Ù‡Ù†ÙˆØ² Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡'); return; }
  const last = historyData[historyData.length-1];
  const support = last.avg * 0.985;
  const resistance = last.avg * 1.015;
  let text = '';
  if(last.bubble < -20000 && last.price <= support){
    text = `ğŸŸ¢ Ø³ÛŒÚ¯Ù†Ø§Ù„ ÙˆØ±ÙˆØ¯ Ù‚ÙˆÛŒ â€” Ù‚ÛŒÙ…Øª Ù†Ø²Ø¯ÛŒÚ© Ø­Ù…Ø§ÛŒØª: ${formatNumber(support)} | RSI: ${last.rsi.toFixed(2)}`;
    pushSignal('ÙˆØ±ÙˆØ¯', text); playSound(); notify(text);
    last.signal = 'entry';
  } else if(last.bubble > 20000 && last.price >= resistance){
    text = `ğŸ”´ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø®Ø±ÙˆØ¬ Ù‚ÙˆÛŒ â€” Ù‚ÛŒÙ…Øª Ù†Ø²Ø¯ÛŒÚ© Ù…Ù‚Ø§ÙˆÙ…Øª: ${formatNumber(resistance)} | RSI: ${last.rsi.toFixed(2)}`;
    pushSignal('Ø®Ø±ÙˆØ¬', text); playSound(); notify(text);
    last.signal = 'exit';
  } else {
    text = `âš– Ø¨Ø§Ø²Ø§Ø± Ø®Ù†Ø«ÛŒ â€” Ø­Ø¨Ø§Ø¨: ${Math.round(last.bubble)} ØªÙˆÙ…Ø§Ù† | RSI: ${last.rsi.toFixed(2)}`;
    pushSignal('Ø®Ù†Ø«ÛŒ', text);
    last.signal = null;
  }
  saveAll(); updateChart();
  document.getElementById('signalBox').innerText = text;
}

/* --------- Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† --------- */
function toggleNotify(){
  notifyActive = !notifyActive;
  localStorage.setItem('notifyActive', notifyActive ? '1' : '0');
  const btn = document.getElementById('notifyBtn');
  if(notifyActive){ btn.classList.remove('off'); btn.classList.add('on'); btn.innerText='ğŸ”” Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø±ÙˆØ´Ù†'; }
  else { btn.classList.remove('on'); btn.classList.add('off'); btn.innerText='ğŸ”” Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø®Ø§Ù…ÙˆØ´'; }
}

/* --------- Ú©Ù„ÛŒØ¯ RSI Ø°Ø®ÛŒØ±Ù‡ --------- */
function saveRsiKey(){
  const k = document.getElementById('rsiKey').value.trim();
  if(!k){ alert('Ú©Ù„ÛŒØ¯ ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡'); return; }
  localStorage.setItem('rsiKey', k);
  alert('Ú©Ù„ÛŒØ¯ RSI Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
}

/* --------- Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ UI --------- */
function initUI(){
  // mark selected time (default free)
  document.getElementById('btnFree').classList.add('active');
  renderSignals();
  updateChart();
  document.getElementById('doneCount').innerText = 0;
  document.getElementById('leftCount').innerText = Math.max(0, (parseInt(document.getElementById('maxReq').value)||1) - apiCounter);
}
initUI();

</script>
</body>
</html>
