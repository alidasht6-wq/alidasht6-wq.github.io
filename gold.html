<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù†Ù‡Ø§ÛŒÛŒ Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø± â€” Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ (Ø¨Ø§ AutoFetch Ùˆ RSI)</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{--bg1:#0f1720;--card:#1f2937;--accent:#ffd369;--muted:#9bd7ff}
*{box-sizing:border-box}
body{margin:0;padding:14px;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:linear-gradient(180deg,var(--bg1),#0b1116);color:#fff}
.container{max-width:980px;margin:0 auto}
.header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
.title{font-size:1.25rem;color:var(--accent);font-weight:700}
.small{font-size:0.85rem;color:#cbd5e1}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:14px;margin-bottom:12px;box-shadow:0 6px 30px rgba(0,0,0,0.6);border:1px solid rgba(255,211,105,0.06)}
.row{display:flex;gap:10px;align-items:center}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
@media(max-width:740px){.grid{grid-template-columns:1fr}}
label{display:block;font-size:0.85rem;margin-bottom:6px;color:#d1d5db}
input[type=number],input[type=text]{width:100%;padding:8px;border-radius:8px;border:none;background:#0b1220;color:#fff}
button{padding:9px 12px;border-radius:10px;border:none;background:var(--accent);color:#000;font-weight:600;cursor:pointer}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff}
.result{background:#071018;padding:10px;border-radius:8px;margin-top:8px;border:1px solid rgba(255,255,255,0.03);font-size:0.95rem}
.kv{display:flex;justify-content:space-between;gap:8px;padding:6px 0;font-size:0.95rem}
.tip{color:var(--muted);font-size:0.88rem;line-height:1.45}
.footer-small{font-size:0.82rem;color:#94a3b8;margin-top:8px}
.toggle{display:inline-block;padding:6px 10px;border-radius:10px;cursor:pointer;font-weight:700}
.toggle.on{background:#16a34a;color:#fff}
.toggle.off{background:#ef4444;color:#fff}
.signals-list{max-height:160px;overflow:auto;margin-top:8px;border-radius:8px;padding:8px;border:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent)}
.signal-item{padding:6px;border-bottom:1px dashed rgba(255,255,255,0.03);font-size:0.9rem}
.canvas-wrap{background:#06121a;padding:8px;border-radius:10px;margin-top:8px}
.legend{display:flex;gap:8px;align-items:center;margin-top:8px}
.legend .dot{width:12px;height:12px;border-radius:3px;display:inline-block}
.entry-dot{background:#16a34a}
.exit-dot{background:#ef4444}
.hr{height:1px;background:rgba(255,255,255,0.03);margin:12px 0;border-radius:2px}
.small-muted{color:#94a3b8;font-size:0.85rem}
.input-inline{display:flex;gap:8px}
.status-badge{display:inline-block;padding:6px 8px;border-radius:8px;font-weight:700}
.status-normal{background:#374151;color:#fff}
.status-high{background:#065f46;color:#fff}
.status-low{background:#7f1d1d;color:#fff}
.counter-box{display:flex;gap:12px;align-items:center}
.counter-box div{min-width:120px}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div>
      <div class="title">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù†ÙˆØ³Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ â€” Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø±</div>
      <div class="small">ÙˆØ±Ú˜Ù†: Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ â€” AutoFetch + RSI API + Ø­Ø¯ Ø¨Ø§Ù„Ø§/Ù¾Ø§ÛŒÛŒÙ†</div>
    </div>
    <div class="small-muted">LocalStorage Ø°Ø®ÛŒØ±Ù‡ Ù…Ø­Ù„ÛŒ â€¢ API Ù…Ø­Ø¯ÙˆØ¯ ÛŒØ§ Ù‚Ø§Ø¨Ù„ Ø§ÙØ²Ø§ÛŒØ´</div>
  </div>

  <!-- ØªÙˆØ¶ÛŒØ­Ø§Øª Ùˆ ØªØ§ÛŒÙ… -->
  <div class="card">
    <h3 style="margin:0 0 6px;color:var(--accent)">Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø³Ø±ÛŒØ¹</h3>
    <div class="tip">
      â€¢ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ Ø±Ø§ Ø¯Ø³ØªÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø§Ø² API Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†ÛŒØ¯.<br>
      â€¢ RSI ÙˆØ§Ù‚Ø¹ÛŒ Ø¨Ø§ Ú©Ù„ÛŒØ¯ AlphaVantage Ø¯Ø±ÛŒØ§ÙØª Ù…ÛŒâ€ŒØ´ÙˆØ¯Ø› Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§ØŒ Ø§Ø² ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.<br>
      â€¢ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ AutoFetch Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡ Ø¨Ø§Ø²Ù‡ Û±Û¸:Û°Û°â€“Û²Û²:Û°Û° Ø±Ø§ ØªÙ‚Ø³ÛŒÙ… Ø¨Ø± ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª ØªÙ†Ø¸ÛŒÙ… Ù…ÛŒâ€ŒÚ©Ù†Ø¯.<br>
      â€¢ Ø­Ø¯ Ø¨Ø§Ù„Ø§/Ù¾Ø§ÛŒÛŒÙ† Ùˆ RSI Ø¨Ø±Ø§ÛŒ Ù†ÙˆØ³Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ùˆ Ù‡Ø´Ø¯Ø§Ø± ØµÙˆØªÛŒ ØµØ§Ø¯Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯.
    </div>
  </div>

  <!-- ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ -->
  <div class="card">
    <h3 style="margin:0 0 8px;color:var(--accent)">ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§</h3>
    <div class="grid">
      <div>
        <label>Ù‚ÛŒÙ…Øª Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø± (ØªÙˆÙ…Ø§Ù†)</label>
        <input id="gold18" type="number" placeholder="Ù…Ø«Ø§Ù„: 12679000">
      </div>
      <div>
        <label>Ù‚ÛŒÙ…Øª Ø¯Ù„Ø§Ø± (ØªÙˆÙ…Ø§Ù†)</label>
        <input id="usd" type="number" placeholder="Ù…Ø«Ø§Ù„: 125000">
      </div>
      <div>
        <label>Ù‚ÛŒÙ…Øª Ø§Ù†Ø³ Ø¬Ù‡Ø§Ù†ÛŒ (Ø¯Ù„Ø§Ø±)</label>
        <input id="ounce" type="number" placeholder="Ù…Ø«Ø§Ù„: 1960.12">
      </div>
      <div>
        <label>Ø§Ø¬Ø±Øª + Ù…Ø§Ù„ÛŒØ§Øª + Ø³ÙˆØ¯ (%)</label>
        <input id="fee" type="number" placeholder="Ù…Ø«Ø§Ù„: 1.2">
      </div>
    </div>

    <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;align-items:center">
      <button onclick="addData()">Ø«Ø¨Øª Ø¯Ø§Ø¯Ù‡ (Ø¯Ø³ØªÛŒ)</button>
      <button class="btn-ghost" onclick="fetchFromAPI()">ğŸ“¡ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø² API (BRS)</button>
      <button class="btn-ghost" onclick="editLastAPI()">âœï¸ Ø§ØµÙ„Ø§Ø­ Ø¢Ø®Ø±ÛŒÙ† Ù‚ÛŒÙ…Øª API</button>

      <div style="flex:1"></div>

      <div style="min-width:220px">
        <label>Ú©Ù„ÛŒØ¯ API Ø¨Ø±Ø§ÛŒ RSI (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
        <div class="input-inline"><input id="rsiApiKey" type="text" placeholder="ALPHAVANTAGE_KEY"><button class="btn-ghost" onclick="saveRSIKey()">Ø°Ø®ÛŒØ±Ù‡</button></div>
        <div class="small-muted" style="margin-top:6px">Ø§Ú¯Ø± ÙˆØ§Ø±Ø¯ Ù†Ø´ÙˆØ¯ØŒ RSI Ø§Ø² ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
      </div>
    </div>

    <div class="hr"></div>
    <div class="result" id="goldResult">ÙˆØ¶Ø¹ÛŒØª: Ø¢Ù…Ø§Ø¯Ù‡</div>
    <div class="kv" style="margin-top:8px"><div class="small-muted">ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª API Ø§Ù…Ø±ÙˆØ²</div><div id="apiCounter">0</div></div>
  </div>

  <!-- AutoFetch -->
  <div class="card">
    <h3 style="margin:0 0 8px;color:var(--accent)">ØªÙ†Ø¸ÛŒÙ…Ø§Øª AutoFetch Ùˆ Ù‡Ø´Ø¯Ø§Ø± Ù‚ÛŒÙ…Øª</h3>
    <div class="grid">
      <div>
        <label>ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ Ø¯Ø± Ø¨Ø§Ø²Ù‡ 18:00â€“22:00</label>
        <input id="maxRequests" type="number" value="100" min="1" max="1500">
      </div>
      <div>
        <label>Ø§Ø¬Ø±Ø§ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±</label>
        <div style="display:flex;gap:8px"><button onclick="startAutoFetch()">â–¶ Ø´Ø±ÙˆØ¹</button><button class="btn-ghost" onclick="stopAutoFetch()">â–  ØªÙˆÙ‚Ù</button></div>
      </div>
      <div>
        <label>Ø­Ø¯ Ù¾Ø§ÛŒÛŒÙ† Ù‡Ø´Ø¯Ø§Ø± (ØªÙˆÙ…Ø§Ù†)</label>
        <input id="lowLimit" type="number" placeholder="Ù…Ø«Ø§Ù„: 12000000">
      </div>
      <div>
        <label>Ø­Ø¯ Ø¨Ø§Ù„Ø§ Ù‡Ø´Ø¯Ø§Ø± (ØªÙˆÙ…Ø§Ù†)</label>
        <input id="highLimit" type="number" placeholder="Ù…Ø«Ø§Ù„: 18000000">
      </div>
    </div>

    <div class="hr"></div>
    <div class="counter-box">
      <div>Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡: <strong id="doneCount">0</strong></div>
      <div>Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: <strong id="leftCount">0</strong></div>
      <div>Ø¨Ø¹Ø¯ÛŒ Ø¯Ø±: <strong id="nextIn">â€”</strong> Ø«Ø§Ù†ÛŒÙ‡</div>
    </div>
    <div class="small-muted" style="margin-top:8px">ØªÙˆØ¬Ù‡: Ø§Ø¬Ø±Ø§ ÙÙ‚Ø· ÙˆÙ‚ØªÛŒ ØµÙØ­Ù‡ Ø¨Ø§Ø² Ø¨Ø§Ø´Ø¯.</div>
  </div>

  <!-- Ù†Ù…ÙˆØ¯Ø§Ø± Ùˆ Ø³ÛŒÚ¯Ù†Ø§Ù„ -->
  <div class="card">
    <h3 style="margin:0 0 8px;color:var(--accent)">Ù†Ù…ÙˆØ¯Ø§Ø±ØŒ Ø­Ø¨Ø§Ø¨ Ùˆ RSI</h3>
    <div style="display:flex;gap:8px;align-items:center">
      <button onclick="signal()">ğŸ” Ø¯Ø±ÛŒØ§ÙØª Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ</button>
      <div style="flex:1"></div>
      <div>
        <button id="notifyBtn" class="toggle off" onclick="toggleNotification()">ğŸ”” Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø®Ø§Ù…ÙˆØ´</button>
      </div>
    </div>
    <div class="canvas-wrap">
      <canvas id="trendChart" style="width:100%;height:360px"></canvas>
    </div>
    <div class="legend">
      <div class="dot entry-dot"></div><div class="small-muted">Ù†Ù‚Ø·Ù‡ ÙˆØ±ÙˆØ¯</div>
      <div class="dot exit-dot" style="margin-left:8px"></div><div class="small-muted">Ù†Ù‚Ø·Ù‡ Ø®Ø±ÙˆØ¬</div>
    </div>
    <div class="hr"></div>
    <div class="result" id="signalResult">Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ Ùˆ ØªØ§Ø±ÛŒØ®Ú†Ù‡Ù” Ø¢Ø®Ø±ÛŒÙ† 50 Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø¯Ø± Ø²ÛŒØ± Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
    <div class="signals-list" id="signalsList"></div>
  </div>

  <div class="footer-small">ØªÙˆØ¶ÛŒØ­Ø§Øª ÙÙ†ÛŒ: Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¯Ø± LocalStorage Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.</div>
</div>

<script>
/* -------------------------
  ØªÙ†Ø¸ÛŒÙ… Ø§ÙˆÙ„ÛŒÙ‡ Ùˆ Ù…ØªØºÛŒØ±Ù‡Ø§
--------------------------*/
const BRS_URL = "https://brsapi.ir/Api/Market/Gold_Currency.php?key=BBzNUXWfiBpUmeXusfw4mkbjXuXjj9nU"; 
let apiCounter = parseInt(localStorage.getItem('apiCounter')) || 0;
let historyData = JSON.parse(localStorage.getItem('goldHistory')) || [];
let signals = JSON.parse(localStorage.getItem('signals')) || [];
let notifyActive = (localStorage.getItem('notifyActive')==='1');
if(notifyActive){ document.getElementById('notifyBtn').className='toggle on'; document.getElementById('notifyBtn').innerText='ğŸ”” Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø±ÙˆØ´Ù†'; }
document.getElementById('apiCounter').innerText = apiCounter;

let autoState = { running:false, timerId:null, countdownId:null, nextAt:null, done:0, left:0 };

/* Chart.js setup */
const ctx = document.getElementById('trendChart').getContext('2d');
const trendChart = new Chart(ctx,{
  type:'line',
  data:{
    labels:[],
    datasets:[
      {label:'Ø­Ø¨Ø§Ø¨ Ù‚ÛŒÙ…Øª (ØªÙˆÙ…Ø§Ù†)', data:[], borderColor:'#60a5fa', backgroundColor:'rgba(96,165,250,0.15)', tension:0.3, fill:true, pointRadius:5, pointBackgroundColor:[]},
      {label:'Ø­Ù…Ø§ÛŒØª', data:[], borderColor:'#10b981', borderDash:[6,4], fill:false, pointRadius:0},
      {label:'Ù…Ù‚Ø§ÙˆÙ…Øª', data:[], borderColor:'#ef4444', borderDash:[6,4], fill:false, pointRadius:0},
      {label:'RSI', data:[], borderColor:'#f472b6', fill:false, yAxisID:'rsiAxis', pointRadius:2}
    ]
  },
  options:{
    responsive:true,
    interaction:{mode:'index',intersect:false},
    scales:{
      y:{position:'left', title:{display:true,text:'ØªÙˆÙ…Ø§Ù† (Ø­Ø¨Ø§Ø¨/Ø³Ø·ÙˆØ­)'}},
      rsiAxis:{position:'right', min:0, max:100, title:{display:true,text:'RSI'}}
    },
    plugins:{legend:{labels:{boxWidth:12}}}
  }
});

/* -------------------------
  ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ
--------------------------*/
function saveHistory(){ localStorage.setItem('goldHistory', JSON.stringify(historyData)); }
function saveSignals(){ localStorage.setItem('signals', JSON.stringify(signals)); }
function setApiCounter(n){ apiCounter=n; localStorage.setItem('apiCounter',String(apiCounter)); document.getElementById('apiCounter').innerText = apiCounter; }
function computeAverage(data,newPrice){ const days=5; const recent=data.slice(-days).map(d=>d.price); recent.push(newPrice); return recent.reduce((a,b)=>a+b,0)/recent.length; }
function computeRSI(prices,period=14){ if(prices.length<period+1) return 50; let gains=0,losses=0; for(let i=prices.length-period;i<prices.length;i++){ const diff=prices[i]-prices[i-1]; if(diff>0) gains+=diff; else losses+=Math.abs(diff); } if(losses===0) return 100; const rs=gains/losses; return 100-(100/(1+rs)); }

/* RSI API */
async function fetchRSIFromAPI(symbol='XAUUSD', interval='daily', time_period=14){
  const key = localStorage.getItem('rsiApiKey');
  if(!key) return null;
  try{
    const url = `https://www.alphavantage.co/query?function=RSI&symbol=${symbol}&interval=${interval}&time_period=${time_period}&series_type=close&apikey=${key}`;
    const res = await fetch(url); const j = await res.json();
    if(j['Technical Analysis: RSI']){
      const lastKey = Object.keys(j['Technical Analysis: RSI'])[0];
      return parseFloat(j['Technical Analysis: RSI'][lastKey]['RSI']);
    }
    return null;
  }catch(e){ console.error('RSI API error',e); return null; }
}

/* Ù‡Ø´Ø¯Ø§Ø± ØµÙˆØªÛŒ Ùˆ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† */
function playSound(){ try{ new Audio('https://www.soundjay.com/button/sounds/beep-07.mp3').play(); }catch(e){console.warn(e);} }
function notify(message){ if(!notifyActive) return; if(Notification.permission==='granted'){ new Notification('Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø±',{body:message}); } else if(Notification.permission!=='denied'){ Notification.requestPermission().then(p=>{ if(p==='granted') new Notification('Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø±',{body:message}); }); }}

/* Ø§ÙØ²ÙˆØ¯Ù† Ø³ÛŒÚ¯Ù†Ø§Ù„ */
function pushSignal(type,text){ const now = new Date().toLocaleString(); const item={type,text,ts:now}; signals.unshift(item); if(signals.length>50) signals=signals.slice(0,50); saveSignals(); renderSignals(); }
function renderSignals(){ const el=document.getElementById('signalsList'); el.innerHTML=''; if(signals.length===0){ el.innerHTML='<div class="small-muted">Ù‡Ù†ÙˆØ² Ø³ÛŒÚ¯Ù†Ø§Ù„ÛŒ ØµØ§Ø¯Ø± Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</div>'; return; } signals.forEach(s=>{ const div=document.createElement('div'); div.className='signal-item'; div.innerHTML=`<strong>[${s.type}]</strong> ${s.text} <div class="small-muted" style="margin-top:4px">${s.ts}</div>`; el.appendChild(div); }); }

/* Ù†Ù…ÙˆØ¯Ø§Ø± */
function updateChart(){ trendChart.data.labels=historyData.map((_,i)=>i+1); trendChart.data.datasets[0].data=historyData.map(d=>d.bubble); trendChart.data.datasets[1].data=historyData.map(d=>d.avg*0.985); trendChart.data.datasets[2].data=historyData.map(d=>d.avg*1.015); trendChart.data.datasets[3].data=historyData.map(d=>d.rsi); trendChart.data.datasets[0].pointBackgroundColor=historyData.map(d=>d.signal==='ÙˆØ±ÙˆØ¯'?'#16a34a':d.signal==='Ø®Ø±ÙˆØ¬'?'#ef4444':'#60a5fa'); trendChart.update(); }

/* Ø°Ø®ÛŒØ±Ù‡ Ú©Ù„ÛŒØ¯ RSI */
function saveRSIKey(){ const k=document.getElementById('rsiApiKey').value.trim(); if(k){ localStorage.setItem('rsiApiKey',k); alert('Ú©Ù„ÛŒØ¯ RSI Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯'); } else alert('Ú©Ù„ÛŒØ¯ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª'); }

/* -------------------------
  Ø¯Ø±ÛŒØ§ÙØª Ù‚ÛŒÙ…Øª Ø§Ø² API Ø§ØµÙ„ÛŒ (Ø·Ù„Ø§ÛŒ Û±Û¸ØŒ Ø¯Ù„Ø§Ø±ØŒ Ø§Ù†Ø³)
--------------------------*/
async function fetchFromAPI(){
  try{
    const res = await fetch(BRS_URL);
    const data = await res.json();
    const goldPrice = parseFloat(data.gold18) || 0;
    const usdPrice = parseFloat(data.usd) || 0;
    const ouncePrice = parseFloat(data.ounce) || 0;
    document.getElementById('gold18').value = goldPrice;
    document.getElementById('usd').value = usdPrice;
    document.getElementById('ounce').value = ouncePrice;
    addData(true);
    setApiCounter(apiCounter+1);
  }catch(e){ console.error('API BRS error',e); alert('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§'); }
}

/* Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø§Ø¯Ù‡ Ùˆ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø­Ø¨Ø§Ø¨ Ùˆ RSI */
async function addData(fromAPI=false){
  const gold = parseFloat(document.getElementById('gold18').value);
  const usd = parseFloat(document.getElementById('usd').value);
  const ounce = parseFloat(document.getElementById('ounce').value);
  const fee = parseFloat(document.getElementById('fee').value)||0;

  if(!gold || !usd || !ounce){ alert('Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }

  // Ø­Ø¨Ø§Ø¨ = Ù‚ÛŒÙ…Øª Ø·Ù„Ø§ÛŒ ÙˆØ§Ù‚Ø¹ÛŒ - Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† 5 Ø¯ÙˆØ±Ù‡ Ø§Ø®ÛŒØ±
  const avg = computeAverage(historyData,gold);
  const bubble = gold-avg;

  // RSI
  const prices = historyData.map(d=>d.price); prices.push(gold);
  let rsi = await fetchRSIFromAPI(); if(rsi===null) rsi = computeRSI(prices);

  // Ø¨Ø±Ø±Ø³ÛŒ Ø³ÛŒÚ¯Ù†Ø§Ù„ ÙˆØ±ÙˆØ¯/Ø®Ø±ÙˆØ¬
  let signalText = '';
  let signalType = '';
  if(bubble<parseFloat(document.getElementById('lowLimit').value||-Infinity) || rsi<30){ signalText=`Ø®Ø±ÛŒØ¯: Ø­Ø¨Ø§Ø¨=${bubble.toFixed(0)}, RSI=${rsi.toFixed(1)}`; signalType='ÙˆØ±ÙˆØ¯'; playSound(); notify(signalText);}
  else if(bubble>parseFloat(document.getElementById('highLimit').value||Infinity) || rsi>70){ signalText=`ÙØ±ÙˆØ´: Ø­Ø¨Ø§Ø¨=${bubble.toFixed(0)}, RSI=${rsi.toFixed(1)}`; signalType='Ø®Ø±ÙˆØ¬'; playSound(); notify(signalText);}

  historyData.push({price:gold,usd,ounce,fee,avg,bubble,rsi,signal:signalType});
  saveHistory(); updateChart(); renderSignals();

  document.getElementById('goldResult').innerHTML=`Ø¢Ø®Ø±ÛŒÙ† Ù‚ÛŒÙ…Øª: ${gold} ØªÙˆÙ…Ø§Ù† | Ø­Ø¨Ø§Ø¨: ${bubble.toFixed(0)} | RSI: ${rsi.toFixed(1)} ${signalText}`;
}

/* -------------------------
  AutoFetch Ù‡ÙˆØ´Ù…Ù†Ø¯
--------------------------*/
function getNextInterval(total=100,startHour=18,endHour=22){
  const now = new Date();
  const start=new Date(); start.setHours(startHour,0,0,0);
  const end=new Date(); end.setHours(endHour,0,0,0);
  if(now<start) now.setTime(start.getTime());
  const remaining = Math.max((end-now)/1000,1);
  const interval = remaining/total;
  return interval;
}

function startAutoFetch(){
  if(autoState.running) return;
  autoState.running=true;
  const totalReq = parseInt(document.getElementById('maxRequests').value)||100;
  autoState.done=0;
  autoState.left=totalReq;
  const interval = getNextInterval(totalReq)*1000;
  document.getElementById('doneCount').innerText=autoState.done;
  document.getElementById('leftCount').innerText=autoState.left;

  function loop(){
    if(autoState.left<=0){ stopAutoFetch(); return; }
    fetchFromAPI();
    autoState.done++; autoState.left--; 
    document.getElementById('doneCount').innerText=autoState.done;
    document.getElementById('leftCount').innerText=autoState.left;
    autoState.nextAt = Date.now() + interval;
    document.getElementById('nextIn').innerText=Math.round(interval/1000);
    autoState.timerId=setTimeout(loop,interval);
  }
  loop();
}

function stopAutoFetch(){ clearTimeout(autoState.timerId); autoState.running=false; document.getElementById('nextIn').innerText='â€”'; }

/* Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø¯Ø³ØªÛŒ */
function signal(){ if(historyData.length===0){ alert('Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª'); return; } const last=historyData[historyData.length-1]; if(last.signal){ pushSignal(last.signal,`Ù‚ÛŒÙ…Øª:${last.price}, Ø­Ø¨Ø§Ø¨:${last.bubble.toFixed(0)}, RSI:${last.rsi.toFixed(1)}`);} else alert('Ø³ÛŒÚ¯Ù†Ø§Ù„ÛŒ ØµØ§Ø¯Ø± Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª'); }

/* Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† */
function toggleNotification(){ notifyActive=!notifyActive; localStorage.setItem('notifyActive',notifyActive?'1':'0'); const btn=document.getElementById('notifyBtn'); if(notifyActive){ btn.className='toggle on'; btn.innerText='ğŸ”” Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø±ÙˆØ´Ù†'; } else { btn.className='toggle off'; btn.innerText='ğŸ”” Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø®Ø§Ù…ÙˆØ´';} }

/* Ø§ØµÙ„Ø§Ø­ Ø¢Ø®Ø±ÛŒÙ† Ø¯Ø§Ø¯Ù‡ API */
function editLastAPI(){ if(historyData.length===0){ alert('Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª'); return; } const gold=parseFloat(document.getElementById('gold18').value); if(!gold) return; historyData[historyData.length-1].price=gold; saveHistory(); updateChart(); alert('Ø¢Ø®Ø±ÛŒÙ† Ù‚ÛŒÙ…Øª API Ø§ØµÙ„Ø§Ø­ Ø´Ø¯'); }

/* -------------------------
  Ø´Ø±ÙˆØ¹ Ø§ÙˆÙ„ÛŒÙ‡
--------------------------*/
updateChart(); renderSignals();
</script>
</body>
</html>
